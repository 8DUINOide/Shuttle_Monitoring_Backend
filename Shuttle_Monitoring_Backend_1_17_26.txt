Shuttle_Monitoring_Backend:
public:
images:
	- background.jpg
	- default-profile.png
	- logo.png
index.html:
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="icon" type="image/png" href="images/logo.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css" type="text/css">
    <style>
        .map-search {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 10px;
        }
        .map-search input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
        }
        .map-search button {
            padding: 8px 12px;
            background-color: #003A6C;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .map-search button:hover {
            background-color: #0066CC;
        }
        .map-container {
            position: relative;
            width: 100%;
            height: 600px;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .active-shuttles {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .map-style-selector {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .map-style-selector select {
            padding: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div id="login-screen" class="login-bg">
    <div class="login-container">
        <img src="images/logo.png" class="logo">
        <h3 style="color: #003A6C; font-size: 2rem; margin: 0.5rem 0 2rem 0; font-weight: bold; text-align: center;">Ride.ADNU</h3>
        <input type="text" placeholder="Username" id="username">
        <div class="password-wrapper">
            <input type="password" placeholder="Password" id="password">
            <span class="toggle-password" onclick="togglePassword('password', this)">
                <i class="fa-solid fa-eye-slash"></i>
            </span>
        </div>
        <p id="login-error" class="error-text" style="display:none; color: red; text-align: center; margin-top: 10px;"></p>
        <button onclick="login()">Sign in</button>
        <a href="reset-password.html" style="display: block; margin-top: 10px; text-align: center; color: #ffffff;">Forgot Password?</a>
    </div>
</div>

<div id="dashboard" class="dashboard" style="display: none">
    <div id="sidebar" class="sidebar">
        <div class="sidebar-profile">
            <img id="sidebar-profile-picture" src="images/default-profile.png" alt="Admin Profile Picture" class="sidebar-profile-pic">
            <p class="sidebar-username" id="sidebar-username"></p>
            <p class="sidebar-email" id="sidebar-email"></p>
        </div>
        <ul>
            <li onclick="showTab('home')"><i class="fa-solid fa-house"></i> Dashboard</li>
            <li onclick="showTab('live-map')"><i class="fa-solid fa-map-location-dot"></i> Live Map</li>
            <li onclick="showTab('students')"><i class="fa-solid fa-users"></i> Students</li>
            <li onclick="showTab('drivers')"><i class="fa-solid fa-id-card"></i> Drivers</li>
            <li onclick="showTab('shuttles')"><i class="fa-solid fa-bus"></i> Shuttles</li>
            <li onclick="showTab('notifications')"><i class="fa-solid fa-bell"></i> Notifications</li>
            <li onclick="showTab('profile')"><i class="fa-solid fa-user"></i> Profile</li>
            <li onclick="showLogoutConfirmModal()"><i class="fa-solid fa-sign-out-alt"></i> Logout</li>
        </ul>
    </div>

    <div class="sidebar-toggle" onclick="toggleSidebar()">â˜°</div>
    <div id="content" class="content">
        <div id="home" class="tab active">
            <header>
                <div class="title-container">
                    <i class="fa-solid fa-house"></i>
                    <h2>Dashboard Overview</h2>
                </div>
                <p>Real-time shuttle monitoring and management</p>
            </header>
            <div class="balance-section">
                <div class="balance-card">
                    <div class="label">Active Shuttles</div>
                    <h1>0</h1>
                </div>
                <div class="balance-card">
                    <div class="label">Students Checked In</div>
                    <h1>0</h1>
                </div>
                <div class="balance-card">
                    <div class="label">On time Performance</div>
                    <h1>0%</h1>
                </div>
                <div class="balance-card">
                    <div class="label">Routes Active</div>
                    <h1>0</h1>
                </div>
                <div class="chart-card">
                    <h4>Today's Routes</h4>
                    <table id="todays-routes-table">
                        <thead>
                        <tr>
                            <th>Route</th>
                            <th>Shuttle</th>
                            <th>Driver</th>
                            <th>Capacity</th>
                            <th>Status</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="chart-card">
                    <h4>Recent Activity</h4>
                    <ul id="recent-activity-list"></ul>
                </div>
            </div>
        </div>

        <div id="shuttles" class="tab">
            <header>
                <div class="title-container">
                    <i class="fa-solid fa-bus"></i>
                    <h2>Shuttle Management</h2>
                </div>
                <p>Monitor and manage all shuttle operations</p>
            </header>
            <div class="table-header">
                <div class="table-title-section">
                    <h3>Active Shuttles</h3>
                    <p>Real time shuttle tracking and status monitoring</p>
                </div>
                <div class="table-actions">
                    <button class="add-btn" onclick="showAddShuttleModal()">
                        <i class="fa-solid fa-plus"></i> Add Shuttle
                    </button>
                </div>
            </div>
            <div class="search-container">
                <input id="searchShuttles" type="text" placeholder="Search shuttles, drivers, or routes..." oninput="filterShuttles()">
                <select id="statusFilter" onchange="filterShuttles()">
                    <option value="all">All Status</option>
                    <option value="ACTIVE">Active</option>
                    <option value="INACTIVE">Inactive</option>
                    <option value="MAINTENANCE">Maintenance</option>
                </select>
            </div>
            <p id="no-shuttles-message" style="display:none; color: red; margin-top: 10px;">No shuttles found.</p>
            <table>
                <thead>
                <tr>
                    <th>Shuttle</th>
                    <th>Driver</th>
                    <th>Route</th>
                    <th>Status</th>
                    <th>Occupancy</th>
                    <th>Location</th>
                    <th>Next Stop</th>
                    <th>ETA</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="shuttles-table"></tbody>
            </table>
        </div>

        <div id="students" class="tab users-tab">
            <header>
                <div class="title-container">
                    <i class="fa-solid fa-users"></i>
                    <h2>Student Management</h2>
                </div>
                <p>Monitor and manage all student shuttle operations</p>
            </header>
            <div class="table-header">
                <div class="table-title-section">
                    <h3>Active Students</h3>
                    <p>Real-time student tracking and status monitoring</p>
                </div>
                <div class="table-actions">
                    <button class="add-btn" onclick="showAddParentModal()">
                        <i class="fa-solid fa-plus"></i> Add Parent & Students
                    </button>
                    <button class="add-btn bulk-btn" onclick="showBulkUploadModal('students')">
                        <i class="fa-solid fa-file-excel"></i> Bulk Upload
                    </button>
                </div>
            </div>
            <div class="search-container">
                <input id="searchStudents" type="text" placeholder="Search students, parents, or shuttles..." oninput="filterStudents()">
                <select id="statusFilter" onchange="filterStudents()">
                    <option value="all">All Status</option>
                    <option value="checked-in">Checked in</option>
                    <option value="checked-out">Checked out</option>
                    <option value="not-boarded">Not boarded</option>
                </select>
            </div>
            <p id="no-students-message" style="display:none; color: red; margin-top: 10px;">No students found.</p>
            <table>
                <thead>
                <tr>
                    <th><i class="fa-solid fa-user"></i> Student</th>
                    <th><i class="fa-solid fa-user"></i> Parent/Guardian</th>
                    <th><i class="fa-solid fa-address-book"></i> Contact</th>
                    <th><i class="fa-solid fa-bus"></i> Assigned Shuttle</th>
                    <th>Status</th>
                    <th>Check-in Time</th>
                    <th>Current Location</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="students-table"></tbody>
            </table>
        </div>

        <div id="drivers" class="tab users-tab">
            <header>
                <div class="title-container">
                    <i class="fa-solid fa-id-card"></i>
                    <h2>Driver Management</h2>
                </div>
                <p>Monitor and manage all driver operations</p>
            </header>
            <div class="table-header">
                <div class="table-title-section">
                    <h3>Active Drivers</h3>
                    <p>Real-time driver tracking and status monitoring</p>
                </div>
                <div class="table-actions">
                    <button class="add-btn" onclick="showAddOperatorModal()">
                        <i class="fa-solid fa-plus"></i> Add Operator & Drivers
                    </button>
                    <button class="add-btn bulk-btn" onclick="showBulkUploadModal('drivers')">
                        <i class="fa-solid fa-file-excel"></i> Bulk Upload
                    </button>
                </div>
            </div>
            <div class="search-container">
                <input id="searchDrivers" type="text" placeholder="Search drivers, operators, or licenses..." oninput="filterDrivers()">
                <select id="statusFilterDrivers" onchange="filterDrivers()">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="maintenance">Maintenance</option>
                </select>
            </div>
            <p id="no-drivers-message" style="display:none; color: red; margin-top: 10px;">No drivers found.</p>
            <table>
                <thead>
                <tr>
                    <th><i class="fa-solid fa-user"></i> Driver</th>
                    <th><i class="fa-solid fa-user-tie"></i> Operator</th>
                    <th><i class="fa-solid fa-address-book"></i> Contact</th>
                    <th><i class="fa-solid fa-id-card"></i> License</th>
                    <th><i class="fa-solid fa-phone-volume"></i> Emergency Contact</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="drivers-table"></tbody>
            </table>
        </div>

        <div id="notifications" class="tab">
            <header>
                <div class="title-container">
                    <i class="fa-solid fa-bell"></i>
                    <h2>Notifications</h2>
                </div>
                <p>Real-time system alerts and activity updates</p>
            </header>
            <div class="table-header">
                <h3>System Notifications</h3>
                <div class="table-actions">
                    <button class="action-btn" onclick="markAllAsRead()">Mark All as Read</button>
                    <button class="action-btn" onclick="clearAllNotifications()">Clear All</button>
                </div>
            </div>
            <div class="search-container">
                <input id="searchNotifications" type="text" placeholder="Search notifications..." oninput="filterNotifications()">
                <select id="notificationStatusFilter" onchange="filterNotifications()">
                    <option value="all">All Status</option>
                    <option value="unread">Unread</option>
                    <option value="read">Read</option>
                </select>
            </div>
            <p id="no-notifications-message" style="display:none; color: red; margin-top: 10px;">No notifications found.</p>
            <table>
                <thead>
                <tr>
                    <th>Notification Message</th>
                    <th>Timestamp</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody id="notifications-table">
                <tr>
                    <td>Sarah Johnson checked in to Shuttle #3</td>
                    <td>2025-09-22 12:16:00</td>
                    <td><span class="status-badge badge-unread">Unread</span></td>
                </tr>
                <tr>
                    <td>Shuttle #2 is running 5 minutes behind schedule</td>
                    <td>2025-09-22 12:13:00</td>
                    <td><span class="status-badge badge-read">Read</span></td>
                </tr>
                <tr>
                    <td>Mike Chen checked out from Shuttle #2</td>
                    <td>2025-09-22 12:10:00</td>
                    <td><span class="status-badge badge-unread">Unread</span></td>
                </tr>
                <tr>
                    <td>Route A delayed by 10 minutes</td>
                    <td>2025-09-22 12:00:00</td>
                    <td><span class="status-badge badge-read">Read</span></td>
                </tr>
                </tbody>
            </table>
        </div>

        <div id="live-map" class="tab">
            <header>
                <div class="title-container">
                    <i class="fa-solid fa-map-location-dot"></i>
                    <h2>Live Map Tracking</h2>
                </div>
                <p>Real-time shuttle locations and routes</p>
            </header>
            <div class="table-header">
                <h3>Shuttle Map</h3>
                <div class="table-actions">
                    <div class="map-search">
                        <input id="map-search-input" type="text" placeholder="Search location...">
                        <button class="action-btn" onclick="searchLocation()"><i class="fa-solid fa-search"></i></button>
                    </div>
                    <button class="action-btn" onclick="refreshMap()">Refresh</button>
                    <button class="action-btn" onclick="toggleTrafficLayer()">Toggle Traffic</button>
                </div>
            </div>
            <div class="map-container" style="display: flex; gap: 20px;">
                <div id="map" style="flex: 1; position: relative;"></div>
                <div class="active-shuttles" style="width: 30%; max-height: 600px; overflow-y: auto;">
                    <h3>Active Shuttles</h3>
                    <p>Live Location Tracking</p>
                    <div class="shuttle-list">
                        <div class="shuttle-item">
                            <p><strong>Shuttle #1</strong> - On Time<br>Lat: 14.5995, Lng: 120.9842<br>Driver: John Doe<br>Route: A</p>
                            <button class="action-btn track-btn" onclick="trackShuttle('Shuttle #1')">Track Shuttle</button>
                            <button class="action-btn route-btn" onclick="showRoute('Shuttle #1')">Show Route</button>
                        </div>
                        <div class="shuttle-item">
                            <p><strong>Shuttle #2</strong> - Delayed<br>Lat: 14.6760, Lng: 121.0437<br>Driver: Jane Smith<br>Route: B</p>
                            <button class="action-btn track-btn" onclick="trackShuttle('Shuttle #2')">Track Shuttle</button>
                            <button class="action-btn route-btn" onclick="showRoute('Shuttle #2')">Show Route</button>
                        </div>
                        <div class="shuttle-item">
                            <p><strong>Shuttle #3</strong> - On Time<br>Lat: 14.5580, Lng: 121.0813<br>Driver: Alex Brown<br>Route: C</p>
                            <button class="action-btn track-btn" onclick="trackShuttle('Shuttle #3')">Track Shuttle</button>
                            <button class="action-btn route-btn" onclick="showRoute('Shuttle #3')">Show Route</button>
                        </div>
                        <div class="shuttle-item">
                            <p><strong>Shuttle #4</strong> - Inactive<br>Lat: 14.5547, Lng: 121.0244<br>Driver: None<br>Route: None</p>
                            <button class="action-btn track-btn" onclick="trackShuttle('Shuttle #4')">Track Shuttle</button>
                            <button class="action-btn route-btn" onclick="showRoute('Shuttle #4')" disabled>No Route</button>
                        </div>
                    </div>
                </div>
            </div>
            <script>
                mapboxgl.accessToken = 'pk.eyJ1IjoiYWxmcmFuY2lzYnA0IiwiYSI6ImNtZnRqaDU2dzBsbGIyanM4cHFhbDY1MjMifQ.-ZQAt1NphjZJLxYUeMkZ7g';
                const map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v11',
                    center: [121.7740, 12.8797],
                    zoom: 5
                });

                map.on('load', () => {
                    // Initialize Mapbox Directions
                    const directions = new MapboxDirections({
                        accessToken: mapboxgl.accessToken,
                        unit: 'metric',
                        profile: 'mapbox/driving-traffic',
                        controls: { inputs: true, instructions: true }
                    });
                    map.addControl(directions, 'top-left');

                    // Add Geolocation Control
                    map.addControl(new mapboxgl.GeolocateControl({
                        positionOptions: { enableHighAccuracy: true },
                        trackUserLocation: true,
                        showUserHeading: true
                    }), 'top-right');

                    // Add Scale Control
                    map.addControl(new mapboxgl.ScaleControl({ unit: 'metric' }), 'bottom-right');

                    // Add Map Style Selector
                    const styleSelector = document.createElement('div');
                    styleSelector.className = 'map-style-selector';
                    styleSelector.innerHTML = `
                        <select id="style-selector" onchange="changeMapStyle(this.value)">
                            <option value="mapbox://styles/mapbox/streets-v11">Streets</option>
                            <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
                            <option value="mapbox://styles/mapbox/dark-v10">Dark</option>
                            <option value="mapbox://styles/mapbox/navigation-day-v1">Navigation Day</option>
                        </select>
                    `;
                    document.getElementById('map').prepend(styleSelector);

                    // Add Traffic Layer (initially hidden)
                    map.addSource('traffic', {
                        type: 'vector',
                        url: 'mapbox://mapbox.mapbox-traffic-v1'
                    });
                    map.addLayer({
                        id: 'traffic-layer',
                        type: 'line',
                        source: 'traffic',
                        'source-layer': 'traffic',
                        paint: {
                            'line-color': [
                                'case',
                                ['==', ['get', 'congestion'], 'low'], '#00ff00',
                                ['==', ['get', 'congestion'], 'moderate'], '#ffcc00',
                                ['==', ['get', 'congestion'], 'heavy'], '#ff0000',
                                ['==', ['get', 'congestion'], 'severe'], '#800000',
                                '#000000'
                            ],
                            'line-width': 4,
                            'line-opacity': 0.7
                        },
                        layout: { visibility: 'none' }
                    });

                    // Ensure map resizes correctly
                    map.resize();
                });

                map.addControl(new mapboxgl.NavigationControl(), 'top-right');
                map.addControl(new mapboxgl.FullscreenControl(), 'top-right');

                const shuttles = [
                    { name: 'Shuttle #1', coordinates: [120.9842, 14.5995], status: 'On Time', driver: 'John Doe', route: 'A', nextStop: 'Stop 1', eta: '10 min' },
                    { name: 'Shuttle #2', coordinates: [121.0437, 14.6760], status: 'Delayed', driver: 'Jane Smith', route: 'B', nextStop: 'Stop 2', eta: '15 min' },
                    { name: 'Shuttle #3', coordinates: [121.0813, 14.5580], status: 'On Time', driver: 'Alex Brown', route: 'C', nextStop: 'Stop 3', eta: '8 min' },
                    { name: 'Shuttle #4', coordinates: [121.0244, 14.5547], status: 'Inactive', driver: 'None', route: 'None', nextStop: 'N/A', eta: 'N/A' }
                ];

                // Sample routes for demonstration
                const routes = {
                    'Shuttle #1': [[120.9842, 14.5995], [120.9900, 14.6000], [120.9950, 14.6050]],
                    'Shuttle #2': [[121.0437, 14.6760], [121.0500, 14.6800], [121.0550, 14.6850]],
                    'Shuttle #3': [[121.0813, 14.5580], [121.0850, 14.5600], [121.0900, 14.5650]],
                    'Shuttle #4': []
                };

                shuttles.forEach(shuttle => {
                    const markerElement = document.createElement('div');
                    markerElement.style.backgroundColor = shuttle.status === 'Inactive' ? '#666' : '#003A6C';
                    markerElement.style.width = '30px';
                    markerElement.style.height = '30px';
                    markerElement.style.borderRadius = '50%';
                    markerElement.style.display = 'flex';
                    markerElement.style.alignItems = 'center';
                    markerElement.style.justifyContent = 'center';
                    markerElement.style.cursor = 'pointer';
                    markerElement.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                    markerElement.innerHTML = '<i class="fa-solid fa-bus" style="color: #F5F5F5; font-size: 18px;"></i>';

                    markerElement.addEventListener('mouseenter', () => {
                        markerElement.style.backgroundColor = shuttle.status === 'Inactive' ? '#999' : '#0066CC';
                    });
                    markerElement.addEventListener('mouseleave', () => {
                        markerElement.style.backgroundColor = shuttle.status === 'Inactive' ? '#666' : '#003A6C';
                    });

                    new mapboxgl.Marker({ element: markerElement })
                        .setLngLat(shuttle.coordinates)
                        .setPopup(new mapboxgl.Popup().setHTML(`
                            <h3>${shuttle.name}</h3>
                            <p>Status: ${shuttle.status}</p>
                            <p>Driver: ${shuttle.driver}</p>
                            <p>Route: ${shuttle.route}</p>
                            <p>Next Stop: ${shuttle.nextStop}</p>
                            <p>ETA: ${shuttle.eta}</p>
                        `))
                        .addTo(map);
                });

                function refreshMap() {
                    map.resize();
                    showToast('Map refreshed!');
                }

                function toggleTrafficLayer() {
                    const visibility = map.getLayoutProperty('traffic-layer', 'visibility');
                    map.setLayoutProperty('traffic-layer', 'visibility', visibility === 'visible' ? 'none' : 'visible');
                    showToast(visibility === 'visible' ? 'Traffic layer hidden' : 'Traffic layer shown');
                }

                function changeMapStyle(style) {
                    map.setStyle(style);
                    showToast('Map style changed');
                    map.on('style.load', () => {
                        map.addSource('traffic', {
                            type: 'vector',
                            url: 'mapbox://mapbox.mapbox-traffic-v1'
                        });
                        map.addLayer({
                            id: 'traffic-layer',
                            type: 'line',
                            source: 'traffic',
                            'source-layer': 'traffic',
                            paint: {
                                'line-color': [
                                    'case',
                                    ['==', ['get', 'congestion'], 'low'], '#00ff00',
                                    ['==', ['get', 'congestion'], 'moderate'], '#ffcc00',
                                    ['==', ['get', 'congestion'], 'heavy'], '#ff0000',
                                    ['==', ['get', 'congestion'], 'severe'], '#800000',
                                    '#000000'
                                ],
                                'line-width': 4,
                                'line-opacity': 0.7
                            },
                            layout: { visibility: 'none' }
                        });

                        shuttles.forEach(shuttle => {
                            const markerElement = document.createElement('div');
                            markerElement.style.backgroundColor = shuttle.status === 'Inactive' ? '#666' : '#003A6C';
                            markerElement.style.width = '30px';
                            markerElement.style.height = '30px';
                            markerElement.style.borderRadius = '50%';
                            markerElement.style.display = 'flex';
                            markerElement.style.alignItems = 'center';
                            markerElement.style.justifyContent = 'center';
                            markerElement.style.cursor = 'pointer';
                            markerElement.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                            markerElement.innerHTML = '<i class="fa-solid fa-bus" style="color: #F5F5F5; font-size: 18px;"></i>';

                            markerElement.addEventListener('mouseenter', () => {
                                markerElement.style.backgroundColor = shuttle.status === 'Inactive' ? '#999' : '#0066CC';
                            });
                            markerElement.addEventListener('mouseleave', () => {
                                markerElement.style.backgroundColor = shuttle.status === 'Inactive' ? '#666' : '#003A6C';
                            });

                            new mapboxgl.Marker({ element: markerElement })
                                .setLngLat(shuttle.coordinates)
                                .setPopup(new mapboxgl.Popup().setHTML(`
                                    <h3>${shuttle.name}</h3>
                                    <p>Status: ${shuttle.status}</p>
                                    <p>Driver: ${shuttle.driver}</p>
                                    <p>Route: ${shuttle.route}</p>
                                    <p>Next Stop: ${shuttle.nextStop}</p>
                                    <p>ETA: ${shuttle.eta}</p>
                                `))
                                .addTo(map);
                        });

                        // Re-add Directions control after style change
                        const directions = new MapboxDirections({
                            accessToken: mapboxgl.accessToken,
                            unit: 'metric',
                            profile: 'mapbox/driving-traffic',
                            controls: { inputs: true, instructions: true }
                        });
                        map.addControl(directions, 'top-left');
                    });
                }

                function trackShuttle(shuttleName) {
                    const shuttle = shuttles.find(s => s.name === shuttleName);
                    if (shuttle) {
                        map.flyTo({ center: shuttle.coordinates, zoom: 12 });
                        showToast(`Tracking ${shuttleName}`);
                    }
                }

                function showRoute(shuttleName) {
                    const route = routes[shuttleName];
                    if (!route || route.length < 2) {
                        showToast(`No route available for ${shuttleName}`);
                        return;
                    }

                    const coordinates = route;
                    map.getSource('route')?.setData({
                        type: 'Feature',
                        properties: {},
                        geometry: {
                            type: 'LineString',
                            coordinates: coordinates
                        }
                    }) || map.addSource('route', {
                        type: 'geojson',
                        data: {
                            type: 'Feature',
                            properties: {},
                            geometry: {
                                type: 'LineString',
                                coordinates: coordinates
                            }
                        }
                    });

                    map.getLayer('route') || map.addLayer({
                        id: 'route',
                        type: 'line',
                        source: 'route',
                        layout: {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        paint: {
                            'line-color': '#003A6C',
                            'line-width': 5,
                            'line-opacity': 0.75
                        }
                    });

                    const bounds = coordinates.reduce((bounds, coord) => {
                        return bounds.extend(coord);
                    }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));
                    map.fitBounds(bounds, { padding: 50 });
                    showToast(`Showing route for ${shuttleName}`);
                }

                function searchLocation() {
                    const query = document.getElementById('map-search-input').value.trim();
                    if (!query) {
                        showToast('Please enter a location to search.');
                        return;
                    }

                    fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${mapboxgl.accessToken}&country=PH&limit=1`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.features && data.features.length > 0) {
                                const [lng, lat] = data.features[0].center;
                                map.flyTo({ center: [lng, lat], zoom: 12 });
                                new mapboxgl.Marker()
                                    .setLngLat([lng, lat])
                                    .setPopup(new mapboxgl.Popup().setHTML(`<h3>${data.features[0].place_name}</h3>`))
                                    .addTo(map);
                                showToast(`Found location: ${data.features[0].place_name}`);
                            } else {
                                showToast('Location not found. Please try a different search term.');
                            }
                        })
                        .catch(error => {
                            console.error('Error searching location:', error);
                            showToast('Error searching location: ' + error.message);
                        });
                }
            </script>
        </div>

        <div id="profile" class="tab">
            <header>
                <h2>Profile</h2>
            </header>
            <div class="profile-section">
                <div class="profile-card" role="region" aria-labelledby="admin-info-title">
                    <h3 id="admin-info-title">Admin Information</h3>
                    <div class="info-row">
                        <div class="profile-picture-container">
                            <img id="admin-profile-picture" src="images/default-profile.png" alt="Admin Profile Picture" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; border: 2px solid #f46354;">
                            <div class="profile-picture-upload">
                                <input type="file" id="profile-picture-input" accept="image/*" style="display: none;">
                                <button class="profile-button" onclick="document.getElementById('profile-picture-input').click()">Change Picture</button>
                            </div>
                            <p id="profile-picture-error" class="error-text" style="display: none;"></p>
                        </div>
                        <p><strong>Username:</strong> <span id="admin-username"></span></p>
                        <p><strong>Email:</strong> <span id="admin-email"></span></p>
                    </div>
                </div>
                <div class="profile-card" role="region" aria-labelledby="admin-reset-title">
                    <h3 id="admin-reset-title">Reset Your Password</h3>
                    <form id="admin-reset-password-form" class="profile-form" aria-labelledby="admin-reset-title">
                        <div class="form-group password-wrapper">
                            <label for="admin-current-password">Current Password</label>
                            <input type="password" id="admin-current-password" required>
                            <span class="toggle-password" onclick="togglePassword('admin-current-password', this)" aria-label="Toggle password visibility">
                                <i class="fa-solid fa-eye-slash"></i>
                            </span>
                        </div>
                        <div class="form-group password-wrapper">
                            <label for="admin-new-password">New Password</label>
                            <input type="password" id="admin-new-password" required>
                            <span class="toggle-password" onclick="togglePassword('admin-new-password', this)" aria-label="Toggle password visibility">
                                <i class="fa-solid fa-eye-slash"></i>
                            </span>
                        </div>
                        <div class="form-group password-wrapper">
                            <label for="admin-confirm-password">Confirm New Password</label>
                            <input type="password" id="admin-confirm-password" required>
                            <span class="toggle-password" onclick="togglePassword('admin-confirm-password', this)" aria-label="Toggle password visibility">
                                <i class="fa-solid fa-eye-slash"></i>
                            </span>
                        </div>
                        <p id="admin-reset-error" class="error-text" style="display: none;"></p>
                        <button type="submit" class="profile-button">Reset Password</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Add Shuttle Modal -->
        <div id="addShuttleModal" class="modal" style="display: none;">
            <div class="modal-content add-form-modal">
                <div class="modal-header">
                    <h3><i class="fa-solid fa-bus"></i> Add Shuttle</h3>
                    <span class="close-modal" onclick="closeAddShuttleModal()">&times;</span>
                </div>
                <form id="addShuttleForm">
                    <div class="form-group">
                        <label for="nameInput">Name (Optional)</label>
                        <input type="text" id="nameInput" placeholder="e.g., Shuttle A1">
                    </div>
                    <div class="form-group">
                        <label for="operatorSelect">Operator *</label>
                        <select id="operatorSelect" required onchange="loadDriversForOperator('operatorSelect', 'driverSelect')">
                            <option value="">Select Operator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="driverSelect">Driver *</label>
                        <select id="driverSelect" required>
                            <option value="">Select Driver</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="routeInput">Route *</label>
                        <input type="text" id="routeInput" required placeholder="e.g., Route A">
                    </div>
                    <div class="form-group">
                        <label for="maxCapacityInput">Max Capacity *</label>
                        <input type="number" id="maxCapacityInput" required min="1" value="50">
                    </div>
                    <p id="add-shuttle-error" class="error-text" style="display: none;"></p>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeAddShuttleModal()">Cancel</button>
                        <button type="submit" class="submit-btn">
                            <i class="fa-solid fa-save"></i> Add Shuttle
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Shuttle Modal -->
        <div id="editShuttleModal" class="modal" style="display: none;">
            <div class="modal-content add-form-modal">
                <div class="modal-header">
                    <h3><i class="fa-solid fa-edit"></i> Edit Shuttle</h3>
                    <span class="close-modal" onclick="closeEditShuttleModal()">&times;</span>
                </div>
                <form id="editShuttleForm">
                    <input type="hidden" id="edit-shuttle-id">
                    <div class="form-group">
                        <label for="edit-name-input">Name</label>
                        <input type="text" id="edit-name-input" placeholder="e.g., Shuttle A1">
                    </div>
                    <div class="form-group">
                        <label for="edit-status-select">Status *</label>
                        <select id="edit-status-select" required>
                            <option value="ACTIVE">Active</option>
                            <option value="INACTIVE">Inactive</option>
                            <option value="MAINTENANCE">Maintenance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-operator-select">Operator *</label>
                        <select id="edit-operator-select" required onchange="loadDriversForOperator('edit-operator-select', 'edit-driver-select')">
                            <option value="">Select Operator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-driver-select">Driver *</label>
                        <select id="edit-driver-select" required>
                            <option value="">Select Driver</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-route-input">Route *</label>
                        <input type="text" id="edit-route-input" required placeholder="e.g., Route A">
                    </div>
                    <div class="form-group">
                        <label for="edit-max-capacity-input">Max Capacity *</label>
                        <input type="number" id="edit-max-capacity-input" required min="1" value="50">
                    </div>
                    <p id="edit-shuttle-error" class="error-text" style="display: none;"></p>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeEditShuttleModal()">Cancel</button>
                        <button type="submit" class="submit-btn">
                            <i class="fa-solid fa-save"></i> Update Shuttle
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Parent & Students Modal -->
        <div id="addParentModal" class="modal" style="display: none;">
            <div class="modal-content add-form-modal">
                <div class="modal-header">
                    <h3><i class="fa-solid fa-users"></i> Add Parent & Students</h3>
                    <span class="close-modal" onclick="closeAddParentModal()">&times;</span>
                </div>
                <form id="addParentForm">
                    <div class="form-section">
                        <h4><i class="fa-solid fa-user"></i> Parent Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="parent-username">Username *</label>
                                <input type="text" id="parent-username" required>
                            </div>
                            <div class="form-group">
                                <label for="parent-email">Email *</label>
                                <input type="email" id="parent-email" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group password-wrapper">
                                <label for="parent-password">Password *</label>
                                <input type="password" id="parent-password" required>
                                <span class="toggle-password" onclick="togglePassword('parent-password', this)">
                                    <i class="fa-solid fa-eye-slash"></i>
                                </span>
                            </div>
                            <div class="form-group">
                                <label for="parent-fullname">Full Name *</label>
                                <input type="text" id="parent-fullname" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="parent-phone">Contact Phone *</label>
                                <input type="tel" id="parent-phone" placeholder="+63-912-345-6789" required>
                            </div>
                            <div class="form-group">
                                <label for="parent-address">Current Address *</label>
                                <input type="text" id="parent-address" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-header">
                            <h4><i class="fa-solid fa-graduation-cap"></i> Students Information</h4>
                            <button type="button" class="add-student-btn" onclick="addStudentForm()">
                                <i class="fa-solid fa-plus"></i> Add Student
                            </button>
                        </div>
                        <div id="students-container">
                            <div class="student-form" data-student="1">
                                <div class="student-header">
                                    <h5>Student 1</h5>
                                    <button type="button" class="remove-student-btn" onclick="removeStudentForm(1)" style="display: none;">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="student-1-username">Username *</label>
                                        <input type="text" id="student-1-username" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="student-1-email">Email *</label>
                                        <input type="email" id="student-1-email" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group password-wrapper">
                                        <label for="student-1-password">Password *</label>
                                        <input type="password" id="student-1-password" required>
                                        <span class="toggle-password" onclick="togglePassword('student-1-password', this)">
                                            <i class="fa-solid fa-eye-slash"></i>
                                        </span>
                                    </div>
                                    <div class="form-group">
                                        <label for="student-1-fullname">Full Name *</label>
                                        <input type="text" id="student-1-fullname" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="student-1-address">Current Address *</label>
                                        <input type="text" id="student-1-address" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="student-1-grade">Grade *</label>
                                        <select id="student-1-grade" required>
                                            <option value="">Select Grade</option>
                                            <option value="Grade 7">Grade 7</option>
                                            <option value="Grade 8">Grade 8</option>
                                            <option value="Grade 9">Grade 9</option>
                                            <option value="Grade 10">Grade 10</option>
                                            <option value="Grade 11">Grade 11</option>
                                            <option value="Grade 12">Grade 12</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="student-1-section">Section *</label>
                                        <input type="text" id="student-1-section" placeholder="e.g., Section A" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p id="add-parent-error" class="error-text" style="display: none;"></p>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeAddParentModal()">Cancel</button>
                        <button type="submit" class="submit-btn">
                            <i class="fa-solid fa-save"></i> Register Parent & Students
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Operator & Drivers Modal -->
        <div id="addOperatorModal" class="modal" style="display: none;">
            <div class="modal-content add-form-modal">
                <div class="modal-header">
                    <h3><i class="fa-solid fa-bus"></i> Add Operator & Drivers</h3>
                    <span class="close-modal" onclick="closeAddOperatorModal()">&times;</span>
                </div>
                <form id="addOperatorForm">
                    <div class="form-section">
                        <h4><i class="fa-solid fa-user-tie"></i> Operator Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="operator-username">Username *</label>
                                <input type="text" id="operator-username" required>
                            </div>
                            <div class="form-group">
                                <label for="operator-email">Email *</label>
                                <input type="email" id="operator-email" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group password-wrapper">
                                <label for="operator-password">Password *</label>
                                <input type="password" id="operator-password" required>
                                <span class="toggle-password" onclick="togglePassword('operator-password', this)">
                                    <i class="fa-solid fa-eye-slash"></i>
                                </span>
                            </div>
                            <div class="form-group">
                                <label for="operator-fullname">Full Name *</label>
                                <input type="text" id="operator-fullname" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="operator-phone">Contact Phone *</label>
                                <input type="tel" id="operator-phone" placeholder="+63-912-345-6789" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-header">
                            <h4><i class="fa-solid fa-id-card"></i> Drivers Information</h4>
                            <button type="button" class="add-driver-btn" onclick="addDriverForm()">
                                <i class="fa-solid fa-plus"></i> Add Driver
                            </button>
                        </div>
                        <div id="drivers-container">
                            <div class="driver-form" data-driver="1">
                                <div class="driver-header">
                                    <h5>Driver 1</h5>
                                    <button type="button" class="remove-driver-btn" onclick="removeDriverForm(1)" style="display: none;">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="driver-1-username">Username *</label>
                                        <input type="text" id="driver-1-username" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="driver-1-email">Email *</label>
                                        <input type="email" id="driver-1-email" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group password-wrapper">
                                        <label for="driver-1-password">Password *</label>
                                        <input type="password" id="driver-1-password" required>
                                        <span class="toggle-password" onclick="togglePassword('driver-1-password', this)">
                                            <i class="fa-solid fa-eye-slash"></i>
                                        </span>
                                    </div>
                                    <div class="form-group">
                                        <label for="driver-1-license">License Number *</label>
                                        <input type="text" id="driver-1-license" placeholder="e.g., DRV-12345" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="driver-1-phone">Contact Phone *</label>
                                        <input type="tel" id="driver-1-phone" placeholder="+63-912-345-6789" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="driver-1-emergency">Emergency Contact *</label>
                                        <input type="tel" id="driver-1-emergency" placeholder="+63-912-345-6789" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p id="add-operator-error" class="error-text" style="display: none;"></p>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeAddOperatorModal()">Cancel</button>
                        <button type="submit" class="submit-btn">
                            <i class="fa-solid fa-save"></i> Register Operator & Drivers
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Bulk Upload Modal -->
        <div id="bulkUploadModal" class="modal" style="display: none;">
            <div class="modal-content bulk-upload-modal">
                <div class="modal-header">
                    <h3 id="bulk-title"><i class="fa-solid fa-upload"></i> Bulk Upload</h3>
                    <span class="close-modal" onclick="closeBulkUploadModal()">&times;</span>
                </div>
                <form id="bulkUploadForm">
                    <div class="form-group">
                        <label for="bulk-file">Select XLSX File *</label>
                        <input type="file" id="bulk-file" accept=".xlsx" required>
                        <small>Upload an Excel file with user data.</small>
                    </div>
                    <p id="bulk-error" class="error-text" style="display: none;"></p>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeBulkUploadModal()">Cancel</button>
                        <button type="submit" class="submit-btn">
                            <i class="fa-solid fa-upload"></i> Upload File
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Student Modal -->
        <div id="editStudentModal" class="modal" style="display: none;">
            <div class="modal-content add-form-modal">
                <div class="modal-header">
                    <h3><i class="fa-solid fa-user-edit"></i> Edit Student</h3>
                    <span class="close-modal" onclick="closeEditStudentModal()">&times;</span>
                </div>
                <form id="editStudentForm">
                    <input type="hidden" id="edit-student-id">
                    <div class="form-section">
                        <h4><i class="fa-solid fa-graduation-cap"></i> Student Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-student-fullname">Full Name *</label>
                                <input type="text" id="edit-student-fullname" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-student-grade">Grade *</label>
                                <select id="edit-student-grade" required>
                                    <option value="">Select Grade</option>
                                    <option value="Grade 7">Grade 7</option>
                                    <option value="Grade 8">Grade 8</option>
                                    <option value="Grade 9">Grade 9</option>
                                    <option value="Grade 10">Grade 10</option>
                                    <option value="Grade 11">Grade 11</option>
                                    <option value="Grade 12">Grade 12</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-student-section">Section *</label>
                                <input type="text" id="edit-student-section" placeholder="e.g., Section A" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-student-address">Current Address *</label>
                                <input type="text" id="edit-student-address" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h4><i class="fa-solid fa-user"></i> Parent Information</h4>
                        <input type="hidden" id="edit-parent-id">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-parent-fullname">Full Name *</label>
                                <input type="text" id="edit-parent-fullname" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-parent-phone">Contact Phone *</label>
                                <input type="tel" id="edit-parent-phone" placeholder="+63-912-345-6789" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-parent-address">Current Address *</label>
                                <input type="text" id="edit-parent-address" required>
                            </div>
                        </div>
                    </div>
                    <p id="edit-student-error" class="error-text" style="display: none;"></p>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeEditStudentModal()">Cancel</button>
                        <button type="submit" class="submit-btn">
                            <i class="fa-solid fa-save"></i> Update Student & Parent
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Driver Modal -->
        <div id="editDriverModal" class="modal" style="display: none;">
            <div class="modal-content add-form-modal">
                <div class="modal-header">
                    <h3><i class="fa-solid fa-user-edit"></i> Edit Driver</h3>
                    <span class="close-modal" onclick="closeEditDriverModal()">&times;</span>
                </div>
                <form id="editDriverForm">
                    <input type="hidden" id="edit-driver-id">
                    <div class="form-section">
                        <h4><i class="fa-solid fa-id-card"></i> Driver Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-driver-contact">Contact Phone *</label>
                                <input type="tel" id="edit-driver-contact" placeholder="+63-912-345-6789" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-driver-license">License Number *</label>
                                <input type="text" id="edit-driver-license" placeholder="e.g., DRV-12345" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-driver-emergency">Emergency Contact *</label>
                                <input type="tel" id="edit-driver-emergency" placeholder="+63-912-345-6789" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h4><i class="fa-solid fa-user-tie"></i> Operator Information</h4>
                        <input type="hidden" id="edit-operator-id">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-operator-fullname">Full Name *</label>
                                <input type="text" id="edit-operator-fullname" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-operator-phone">Contact Phone *</label>
                                <input type="tel" id="edit-operator-phone" placeholder="+63-912-345-6789" required>
                            </div>
                        </div>
                    </div>
                    <p id="edit-driver-error" class="error-text" style="display: none;"></p>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeEditDriverModal()">Cancel</button>
                        <button type="submit" class="submit-btn">
                            <i class="fa-solid fa-save"></i> Update Driver & Operator
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteConfirmModal" class="modal-confirm" style="display: none;">
            <div class="modal-confirm-content">
                <h3>Confirm Delete</h3>
                <p id="deleteConfirmMessage">Are you sure you want to delete this item? This action cannot be undone.</p>
                <input type="hidden" id="deleteItemId">
                <input type="hidden" id="deleteItemType">
                <button class="confirm-action" onclick="confirmDelete()">Delete</button>
                <button class="cancel-action" onclick="cancelDelete()">Cancel</button>
            </div>
        </div>

        <div id="logoutConfirmModal" class="modal-confirm" style="display: none;">
            <div class="modal-confirm-content">
                <h3>Confirm Logout</h3>
                <p>Are you sure you want to log out?</p>
                <button class="confirm-action" onclick="confirmLogout()">Logout</button>
                <button class="cancel-action" onclick="cancelLogout()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast" style="display: none;"></div>

    <script src="script.js"></script>
    <script>
        function togglePassword(id, iconSpan) {
            const input = document.getElementById(id);
            const icon = iconSpan.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 4000);
        }
    </script>
</body>
</html>

reset-password.html :
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .reset-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
        }
        .reset-box {
            background: linear-gradient(135deg, #fff5f5, #f5f5f5);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .reset-box h2 {
            margin-bottom: 1.5rem;
            color: #333;
        }
        .reset-box input {
            width: 100%;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .reset-box button {
            padding: 0.5rem 1rem;
            margin: 0.5rem;
            border: none;
            border-radius: 5px;
            background: linear-gradient(135deg, #5cb85c, #4cae4c);
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        .reset-box button.cancel {
            background: linear-gradient(135deg, #ccc, #aaa);
            color: black;
        }
        .password-wrapper {
            position: relative;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
        }
        .error-text {
            color: red;
            margin-top: 0.5rem;
            display: none;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #e57373, #ff9999);
            color: #fff;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            opacity: 0;
            animation: fadeInOut 4s forwards;
            z-index: 3000;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
<div class="reset-container">
    <div class="reset-box">
        <img src="images/logo.png" class="logo" style="width: 100px; margin-bottom: 1rem;">
        <h2>Reset Password</h2>
        <div id="emailStep">
            <input type="email" id="resetEmail" placeholder="Enter your email">
            <p id="resetEmailError" class="error-text">Error</p>
            <button onclick="requestOtp()">Send OTP</button>
            <button class="cancel" onclick="window.location.href='index.html'">Back to Login</button>
        </div>
        <div id="otpStep" style="display: none;">
            <input type="text" id="resetOtp" placeholder="Enter OTP">
            <p id="resetOtpError" class="error-text">Error</p>
            <button onclick="verifyOtp()">Verify OTP</button>
            <button class="cancel" onclick="window.location.href='index.html'">Back to Login</button>
        </div>
        <div id="passwordStep" style="display: none;">
            <div class="password-wrapper">
                <input type="password" id="newResetPassword" placeholder="New Password">
                <span class="toggle-password" onclick="togglePassword('newResetPassword', this)">
                        <i class="fa-solid fa-eye-slash"></i>
                    </span>
            </div>
            <div class="password-wrapper">
                <input type="password" id="repeatResetPassword" placeholder="Confirm Password">
                <span class="toggle-password" onclick="togglePassword('repeatResetPassword', this)">
                        <i class="fa-solid fa-eye-slash"></i>
                    </span>
            </div>
            <p id="resetPasswordError" class="error-text">Error</p>
            <button onclick="changePassword()">Change Password</button>
            <button class="cancel" onclick="window.location.href='index.html'">Back to Login</button>
        </div>
        <div id="toast" class="toast" style="display: none;"></div>
    </div>
</div>

<script>
    function togglePassword(id, iconSpan) {
        const input = document.getElementById(id);
        const icon = iconSpan.querySelector('i');
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        }
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 4000);
    }

    async function requestOtp() {
        const email = document.getElementById('resetEmail').value;
        const error = document.getElementById('resetEmailError');
        error.style.display = 'none';
        if (!email) {
            error.textContent = 'Email is required';
            error.style.display = 'block';
            return;
        }

        try {
            const response = await fetch('http://localhost:8080/api/forgotPassword/verifyMail', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });
            const result = await response.json();
            if (result.status === 'success') {
                showToast(result.message);
                document.getElementById('emailStep').style.display = 'none';
                document.getElementById('otpStep').style.display = 'block';
            } else {
                error.textContent = result.message || 'Failed to send OTP';
                error.style.display = 'block';
            }
        } catch (e) {
            error.textContent = 'Failed to send OTP';
            error.style.display = 'block';
        }
    }

    async function verifyOtp() {
        const email = document.getElementById('resetEmail').value;
        const otp = document.getElementById('resetOtp').value;
        const error = document.getElementById('resetOtpError');
        error.style.display = 'none';
        if (!otp) {
            error.textContent = 'OTP is required';
            error.style.display = 'block';
            return;
        }

        try {
            const response = await fetch('http://localhost:8080/api/forgotPassword/verifyOtp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, otp })
            });
            const result = await response.json();
            if (result.status === 'success') {
                showToast(result.message);
                document.getElementById('otpStep').style.display = 'none';
                document.getElementById('passwordStep').style.display = 'block';
            } else {
                error.textContent = result.message || 'Invalid OTP';
                error.style.display = 'block';
            }
        } catch (e) {
            error.textContent = 'Failed to verify OTP';
            error.style.display = 'block';
        }
    }

    async function changePassword() {
        const email = document.getElementById('resetEmail').value;
        const otp = document.getElementById('resetOtp').value;
        const password = document.getElementById('newResetPassword').value;
        const repeatPassword = document.getElementById('repeatResetPassword').value;
        const error = document.getElementById('resetPasswordError');
        error.style.display = 'none';
        if (!password || !repeatPassword) {
            error.textContent = 'Both password fields are required';
            error.style.display = 'block';
            return;
        }
        if (password !== repeatPassword) {
            error.textContent = 'Passwords do not match';
            error.style.display = 'block';
            return;
        }

        try {
            const response = await fetch('http://localhost:8080/api/forgotPassword/changePassword', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, otp, password, repeatPassword })
            });
            const result = await response.json();
            if (result.status === 'success') {
                showToast(result.message);
                setTimeout(() => window.location.href = 'index.html', 2000);
            } else {
                error.textContent = result.message || 'Failed to change password';
                error.style.display = 'block';
            }
        } catch (e) {
            error.textContent = 'Failed to change password';
            error.style.display = 'block';
        }
    }
</script>
</body>
</html>

script.js :
const SERVER_URL = "http://localhost:8080"; // Change to "http://152.42.192.226:8080" for server testing

let token = null;
let currentUser = null;
let currentUserId = null;
let studentCounter = 1;
let driverCounter = 1;
let bulkType = '';
let allDrivers = [];

const studentStatuses = ['Checked in', 'Checked out', 'Not boarded'];
const studentStatusClasses = ['badge-checked-in', 'badge-checked-out', 'badge-not-boarded'];
const shuttleStatuses = ['ACTIVE', 'INACTIVE', 'MAINTENANCE'];
const shuttleStatusClasses = ['badge-active', 'badge-inactive', 'badge-maintenance'];

// Function to sanitize input to prevent XSS
function sanitizeHTML(str) {
    if (typeof str !== 'string') return str;
    return str.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/&amp;/g, '&amp;');
}

// Check for stored token on page load
document.addEventListener('DOMContentLoaded', async () => {
    const storedToken = localStorage.getItem('authToken');
    const storedUser = localStorage.getItem('currentUser');
    const storedUserId = localStorage.getItem('currentUserId');

    if (storedToken && storedUser && storedUserId) {
        token = storedToken;
        currentUser = JSON.parse(storedUser);
        currentUserId = storedUserId;
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("dashboard").style.display = "flex";
        await loadAllData();
        updateDashboard();
        showProfile();
    }
});

function showToast(message) {
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.textContent = message;

    // Determine toast color based on message content
    const isError = message.toLowerCase().includes("error") || message.toLowerCase().includes("failed");
    toast.style.backgroundColor = isError ? "red" : "green";

    document.body.appendChild(toast);
    setTimeout(() => {
        toast.classList.add("fadeInOut");
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }, 100);
}

// =================== AUTH ===================
async function login() {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;
    const errorElement = document.getElementById("login-error");
    errorElement.style.display = "none";
    errorElement.textContent = "";

    try {
        const response = await fetch(`${SERVER_URL}/api/auth/sign-in`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ usernameOrEmail: username, password })
        });

        const data = await response.json();
        if (response.ok && data.access_token) {
            if (username.toLowerCase() === "admin") {
                token = data.access_token;
                currentUser = {
                    username,
                    email: data.email || "admin@gmail.com",
                    userId: data.user_id
                };
                currentUserId = data.user_id;
                // Store in localStorage
                localStorage.setItem('authToken', token);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('currentUserId', currentUserId);
                document.getElementById("login-screen").style.display = "none";
                document.getElementById("dashboard").style.display = "flex";
                await loadAllData();
                updateDashboard();
                loadProfilePicture();
            } else {
                errorElement.textContent = "Access denied. Only the admin can log in.";
                errorElement.style.display = "block";
            }
        } else {
            errorElement.textContent = data.error || "Login failed. Please check your credentials.";
            errorElement.style.display = "block";
        }
    } catch (error) {
        errorElement.textContent = "Network error: " + error.message;
        errorElement.style.display = "block";
    }
}

function logout() {
    // Clear localStorage
    localStorage.removeItem('authToken');
    localStorage.removeItem('currentUser');
    localStorage.removeItem('currentUserId');
    token = null;
    currentUser = null;
    currentUserId = null;
    document.getElementById("dashboard").style.display = "none";
    document.getElementById("login-screen").style.display = "flex";
}

function showLogoutConfirmModal() {
    document.getElementById("logoutConfirmModal").style.display = "flex";
}

function confirmLogout() {
    document.getElementById("logoutConfirmModal").style.display = "none";
    logout();
}

function cancelLogout() {
    document.getElementById("logoutConfirmModal").style.display = "none";
}

// =================== DELETE CONFIRMATION ===================
function showDeleteConfirm(id, type) {
    document.getElementById('deleteItemId').value = id;
    document.getElementById('deleteItemType').value = type;
    let message = 'Are you sure you want to delete this item? This action cannot be undone.';
    if (type === 'student') {
        message = 'Are you sure you want to delete this student? This will also delete their user account.';
    } else if (type === 'driver') {
        message = 'Are you sure you want to delete this driver? This will also delete their user account.';
    } else if (type === 'shuttle') {
        message = 'Are you sure you want to delete this shuttle? This will remove the shuttle assignment.';
    }
    document.getElementById('deleteConfirmMessage').textContent = message;
    document.getElementById("deleteConfirmModal").style.display = "flex";
}

async function confirmDelete() {
    const id = document.getElementById('deleteItemId').value;
    const type = document.getElementById('deleteItemType').value;
    document.getElementById("deleteConfirmModal").style.display = "none";
    if (type === 'student') {
        await deleteStudent(id);
    } else if (type === 'driver') {
        await deleteDriver(id);
    } else if (type === 'shuttle') {
        await deleteShuttle(id);
    }
}

function cancelDelete() {
    document.getElementById("deleteConfirmModal").style.display = "none";
}

//=================== UI CONTROL ===================
function showTab(tabId) {
    const tabs = document.querySelectorAll(".tab");
    tabs.forEach(tab => tab.classList.remove("active"));
    document.getElementById(tabId).classList.add("active");
    if (tabId === 'profile' && currentUser) {
        showProfile();
        document.getElementById('admin-reset-password-form').reset();
        document.getElementById('admin-reset-error').style.display = 'none';
    }
    if (tabId === 'home') {
        updateDashboard();
    }
    // Reset status filters to "All Status" when switching tabs
    const statusFilters = document.querySelectorAll('select[id$="statusFilter"], select[id$="statusFilterDrivers"]');
    statusFilters.forEach(filter => {
        filter.value = "all";
    });
    // Trigger filter functions to refresh displayed data
    if (tabId === 'shuttles') filterShuttles();
    if (tabId === 'students') filterStudents();
    if (tabId === 'drivers') filterDrivers();
    if (tabId === 'notifications') filterNotifications();
}

function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const content = document.getElementById("content");
    sidebar.classList.toggle("active");
    content.classList.toggle("content-shift");
}

// =================== DATA LOADING ===================
async function loadAllData() {
    await Promise.all([
        loadStudents(),
        loadDrivers(),
        loadShuttles()
    ]);
}

async function loadShuttles() {
    if (!token) return;
    try {
        const response = await fetch(`${SERVER_URL}/api/shuttles/all`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        if (!response.ok) {
            throw new Error('Failed to fetch shuttles');
        }
        const shuttles = await response.json();
        const tbody = document.getElementById('shuttles-table');
        tbody.innerHTML = '';
        shuttles.forEach((shuttle) => {
            const statusText = shuttle.status;
            const statusClass = shuttleStatusClasses[shuttleStatuses.indexOf(statusText)] || 'badge-active';
            const maxCapacity = shuttle.maxCapacity || 50;
            const currentOccupancy = Math.floor(Math.random() * (maxCapacity + 1));
            const occupancy = `${currentOccupancy}/${maxCapacity}`;
            const lat = (14.5 + Math.random() * 0.2).toFixed(4);
            const lng = (121.0 + Math.random() * 0.2).toFixed(4);
            const nextStop = `Stop ${Math.floor(Math.random() * 5) + 1}`;
            const eta = `${Math.floor(Math.random() * 25) + 5} min`;
            const tr = document.createElement('tr');
            tr.dataset.shuttleId = shuttle.shuttleId;
            tr.innerHTML = `
                <td>${sanitizeHTML(shuttle.name)}</td>
                <td>${sanitizeHTML(shuttle.driver.user.username)}</td>
                <td>${sanitizeHTML(shuttle.route)}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>${occupancy}</td>
                <td>Lat: ${lat}, Lng: ${lng}</td>
                <td>${nextStop}</td>
                <td>${eta}</td>
                <td>
                    <div style="display: inline-flex; gap: 5px; align-items: center;">
                        <button class="action-btn track-btn" onclick="showToast('Tracking shuttle details')">Track Details</button>
                        <div class="actions-dropdown">
                            <button class="ellipsis-btn" onclick="toggleDropdown(this)"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                            <div class="dropdown-menu" style="display: none;">
                                <button class="dropdown-item" onclick="editShuttle(${shuttle.shuttleId}); toggleDropdown(this.parentElement.previousElementSibling)"><i class="fa-solid fa-edit"></i> Edit</button>
                                <button class="dropdown-item delete" onclick="showDeleteConfirm(${shuttle.shuttleId}, 'shuttle'); toggleDropdown(this.parentElement.previousElementSibling)"><i class="fa-solid fa-trash"></i> Delete</button>
                            </div>
                        </div>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch (error) {
        console.error('Error loading shuttles:', error);
        showToast('Error loading shuttles data');
    }
}

async function loadStudents() {
    if (!token) return;
    try {
        const response = await fetch(`${SERVER_URL}/api/students/all`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        if (!response.ok) {
            throw new Error('Failed to fetch students');
        }
        const students = await response.json();
        const tbody = document.getElementById('students-table');
        tbody.innerHTML = '';
        students.forEach(student => {
            const statusIndex = Math.floor(Math.random() * studentStatuses.length);
            const statusText = studentStatuses[statusIndex];
            const statusClass = studentStatusClasses[statusIndex];
            let checkInTime = '-';
            if (statusIndex !== 2) {
                const hoursAgo = Math.floor(Math.random() * 8) + 1;
                const checkInDate = new Date(Date.now() - hoursAgo * 3600000);
                checkInTime = checkInDate.toLocaleString('en-PH', { timeZone: 'Asia/Manila', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            }
            const assignedShuttle = `Shuttle #${Math.floor(Math.random() * 4) + 1}`;
            const tr = document.createElement('tr');
            tr.dataset.studentId = student.studentId;
            tr.innerHTML = `
                <td>${sanitizeHTML(student.fullName)}<br><small>${sanitizeHTML(student.grade)} - ${sanitizeHTML(student.section)}</small></td>
                <td>${sanitizeHTML(student.parent.fullName)}</td>
                <td><i class="fa-solid fa-phone"></i> ${sanitizeHTML(student.parent.contactPhone)}<br><i class="fa-solid fa-envelope"></i> ${sanitizeHTML(student.parent.user.email)}</td>
                <td>${assignedShuttle}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>${checkInTime}</td>
                <td>${sanitizeHTML(student.currentAddress)}</td>
                <td>
                    <div style="display: inline-flex; gap: 5px; align-items: center;">
                        <button class="action-btn track-btn" onclick="showToast('Tracking student details')">Track Details</button>
                        <div class="actions-dropdown">
                            <button class="ellipsis-btn" onclick="toggleDropdown(this)"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                            <div class="dropdown-menu" style="display: none;">
                                <button class="dropdown-item" onclick="editStudent(${student.studentId}); toggleDropdown(this.parentElement.previousElementSibling)"><i class="fa-solid fa-edit"></i> Edit</button>
                                <button class="dropdown-item delete" onclick="showDeleteConfirm(${student.studentId}, 'student'); toggleDropdown(this.parentElement.previousElementSibling)"><i class="fa-solid fa-trash"></i> Delete</button>
                            </div>
                        </div>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch (error) {
        console.error('Error loading students:', error);
        showToast('Error loading students data');
    }
}

async function loadDrivers() {
    if (!token) return;
    try {
        const response = await fetch(`${SERVER_URL}/api/drivers/all`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        if (!response.ok) {
            throw new Error('Failed to fetch drivers');
        }
        allDrivers = await response.json();
        const tbody = document.getElementById('drivers-table');
        tbody.innerHTML = '';
        allDrivers.forEach(driver => {
            const tr = document.createElement('tr');
            tr.dataset.driverId = driver.driverId;
            tr.innerHTML = `
                <td>${sanitizeHTML(driver.user.username)}</td>
                <td>${sanitizeHTML(driver.operator.fullName)}<br><small><i class="fa-solid fa-envelope"></i> ${sanitizeHTML(driver.operator.user.email)}</small></td>
                <td><i class="fa-solid fa-phone"></i> ${sanitizeHTML(driver.contactPhone)}<br><i class="fa-solid fa-envelope"></i> ${sanitizeHTML(driver.user.email)}</td>
                <td>${sanitizeHTML(driver.licenseNumber)}</td>
                <td><i class="fa-solid fa-phone"></i> ${sanitizeHTML(driver.emergencyContact)}</td>
                <td><span class="status-badge badge-active">Active</span></td>
                <td>
                    <div style="display: inline-flex; gap: 5px; align-items: center;">
                        <button class="action-btn track-btn" onclick="showToast('Tracking driver details')">Track Details</button>
                        <div class="actions-dropdown">
                            <button class="ellipsis-btn" onclick="toggleDropdown(this)"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                            <div class="dropdown-menu" style="display: none;">
                                <button class="dropdown-item" onclick="editDriver(${driver.driverId}); toggleDropdown(this.parentElement.previousElementSibling)"><i class="fa-solid fa-edit"></i> Edit</button>
                                <button class="dropdown-item delete" onclick="showDeleteConfirm(${driver.driverId}, 'driver'); toggleDropdown(this.parentElement.previousElementSibling)"><i class="fa-solid fa-trash"></i> Delete</button>
                            </div>
                        </div>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch (error) {
        console.error('Error loading drivers:', error);
        showToast('Error loading drivers data');
    }
}

// =================== PROFILE ===================
function showProfile() {
    if (document.getElementById('profile').classList.contains('active') && currentUser) {
        document.getElementById('admin-username').textContent = currentUser.username || 'N/A';
        document.getElementById('admin-email').textContent = currentUser.email || 'N/A';
        document.getElementById('sidebar-username').textContent = currentUser.username || 'N/A';
        document.getElementById('sidebar-email').textContent = currentUser.email || 'N/A';
        loadProfilePicture();
    } else if (currentUser) {
        // Update sidebar even if profile tab is not active
        document.getElementById('sidebar-username').textContent = currentUser.username || 'N/A';
        document.getElementById('sidebar-email').textContent = currentUser.email || 'N/A';
        loadProfilePicture();
    }
}

async function loadProfilePicture() {
    if (!currentUserId || !token) return;

    try {
        const response = await fetch(`${SERVER_URL}/api/users/${currentUserId}/profile-picture`, {
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            // Update both profile tab and sidebar images
            document.getElementById("admin-profile-picture").src = url;
            document.getElementById("sidebar-profile-picture").src = url;
        } else {
            document.getElementById("admin-profile-picture").src = "images/default-profile.png";
            document.getElementById("sidebar-profile-picture").src = "images/default-profile.png";
        }
    } catch (error) {
        console.error("Error loading profile picture:", error);
        document.getElementById("admin-profile-picture").src = "images/default-profile.png";
        document.getElementById("sidebar-profile-picture").src = "images/default-profile.png";
    }
}

async function uploadProfilePicture() {
    const fileInput = document.getElementById("profile-picture-input");
    const errorElement = document.getElementById("profile-picture-error");
    errorElement.style.display = "none";
    errorElement.textContent = "";

    if (!fileInput.files[0]) {
        errorElement.textContent = "Please select an image file";
        errorElement.style.display = "block";
        return;
    }

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    try {
        const response = await fetch(`${SERVER_URL}/api/users/${currentUserId}/profile-picture`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` },
            body: formData
        });

        const data = await response.json();
        if (response.ok) {
            showToast(data.message || "Profile picture uploaded successfully");
            await loadProfilePicture();
            fileInput.value = "";
        } else {
            errorElement.textContent = data.error || "Failed to upload profile picture";
            errorElement.style.display = "block";
        }
    } catch (error) {
        errorElement.textContent = "Network error: " + error.message;
        errorElement.style.display = "block";
    }
}

document.getElementById("admin-reset-password-form").addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitButton = e.target.querySelector('.profile-button');
    const errorElement = document.getElementById('admin-reset-error');
    errorElement.style.display = 'none';
    errorElement.textContent = '';
    submitButton.disabled = true;

    const email = document.getElementById('admin-email').textContent;
    const currentPassword = document.getElementById('admin-current-password').value;
    const newPassword = document.getElementById('admin-new-password').value;
    const confirmPassword = document.getElementById('admin-confirm-password').value;

    if (!currentPassword || !newPassword || !confirmPassword) {
        errorElement.textContent = 'All fields are required';
        errorElement.style.display = 'block';
        submitButton.disabled = false;
        return;
    }

    if (newPassword !== confirmPassword) {
        errorElement.textContent = 'Passwords do not match';
        errorElement.style.display = 'block';
        submitButton.disabled = false;
        return;
    }

    try {
        const response = await fetch(`${SERVER_URL}/api/forgotPassword/reset-password?email=${encodeURIComponent(email)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                currentPassword,
                newPassword,
                repeatPassword: confirmPassword
            })
        });
        const result = await response.json();
        if (response.ok) {
            showToast(result.message || 'Password reset successfully');
            e.target.reset();
        } else {
            errorElement.textContent = result.error || 'Failed to reset password';
            errorElement.style.display = 'block';
        }
    } catch (error) {
        errorElement.textContent = 'Network error: ' + error.message;
        errorElement.style.display = 'block';
    } finally {
        submitButton.disabled = false;
    }
});

document.getElementById("profile-picture-input").addEventListener("change", uploadProfilePicture);

// =================== DASHBOARD UPDATE ===================
function relativeTime(timestamp) {
    const date = new Date(timestamp.replace(' ', 'T') + 'Z');
    const now = new Date('2025-09-22T12:24:00-07:00'); // Current time: 12:24 PM PST
    const diffMs = now - date;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHr = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHr / 24);
    if (diffSec < 60) return `${diffSec} seconds ago`;
    if (diffMin < 60) return `${diffMin} minutes ago`;
    if (diffHr < 24) return `${diffHr} hours ago`;
    return `${diffDay} days ago`;
}

async function updateDashboard() {
    if (!token) return;

    // Populate Today's Routes from Shuttles tab
    const shuttleRows = document.querySelectorAll('#shuttles-table tr');
    let activeShuttles = 0;
    let routes = new Set();
    const todaysTbody = document.querySelector('#todays-routes-table tbody');
    todaysTbody.innerHTML = '';
    shuttleRows.forEach(row => {
        const statusText = row.querySelector('td:nth-child(4) span')?.textContent || '';
        const statusClass = row.querySelector('td:nth-child(4) span')?.className || '';
        const route = row.querySelector('td:nth-child(3)')?.textContent || '';
        const shuttle = row.querySelector('td:nth-child(1)')?.textContent || '';
        const driver = row.querySelector('td:nth-child(2)')?.textContent || '';
        const occupancy = row.querySelector('td:nth-child(5)')?.textContent || '';
        const capacity = occupancy.split('/')[1] || '';
        routes.add(route);
        if (statusText === 'ACTIVE') {
            activeShuttles++;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${sanitizeHTML(route)}</td>
                <td>${sanitizeHTML(shuttle)}</td>
                <td>${sanitizeHTML(driver)}</td>
                <td>${sanitizeHTML(capacity)}</td>
                <td><span class="${statusClass}">${sanitizeHTML(statusText)}</span></td>
            `;
            todaysTbody.appendChild(tr);
        }
    });
    const activeRoutes = routes.size;

    // Populate Students Checked In from Students tab
    const studentRows = document.querySelectorAll('#students-table tr');
    let checkedInStudents = 0;
    studentRows.forEach(row => {
        const status = row.querySelector('td:nth-child(5) span')?.textContent || '';
        if (status === 'Checked in') checkedInStudents++;
    });

    // Populate Recent Activity from Notifications tab
    const notifRows = document.querySelectorAll('#notifications-table tr');
    const activityList = document.getElementById('recent-activity-list');
    activityList.innerHTML = '';
    notifRows.forEach(row => {
        const msg = row.querySelector('td:nth-child(1)')?.textContent || '';
        const ts = row.querySelector('td:nth-child(2)')?.textContent || '';
        const rel = relativeTime(ts);
        const li = document.createElement('li');
        li.innerHTML = `
            <div>${sanitizeHTML(msg)}</div>
            <div class="activity-subtitle">${sanitizeHTML(rel)}</div>
        `;
        activityList.appendChild(li);
    });

    // Calculate On Time Performance
    let delayed = 0;
    shuttleRows.forEach(row => {
        const statusText = row.querySelector('td:nth-child(4) span')?.textContent || '';
        if (statusText !== 'ACTIVE') delayed++;
    });
    const onTimePerf = activeRoutes > 0 ? Math.round((activeRoutes - delayed) / activeRoutes * 100) : 0;

    // Update Balance Cards
    const balanceCards = document.querySelectorAll(".balance-card h1");
    balanceCards[0].textContent = activeShuttles;
    balanceCards[1].textContent = checkedInStudents;
    balanceCards[2].textContent = `${onTimePerf}%`;
    balanceCards[3].textContent = activeRoutes;

    showProfile();
}

// =================== FILTER FUNCTIONS (CLIENT-SIDE FOR STATIC DATA) ===================
function filterShuttles() {
    const searchValue = document.getElementById("searchShuttles").value.toLowerCase();
    const statusFilter = document.getElementById("statusFilter").value.toLowerCase();
    const rows = document.querySelectorAll("#shuttles-table tr");
    let visibleCount = 0;

    rows.forEach(row => {
        const shuttle = row.querySelector("td:nth-child(1)")?.textContent.toLowerCase() || "";
        const driver = row.querySelector("td:nth-child(2)")?.textContent.toLowerCase() || "";
        const route = row.querySelector("td:nth-child(3)")?.textContent.toLowerCase() || "";
        const status = row.querySelector("td:nth-child(4) span")?.textContent.toLowerCase() || "";

        const matchesSearch = shuttle.includes(searchValue) || driver.includes(searchValue) || route.includes(searchValue);
        const matchesStatus = statusFilter === "all" || status === statusFilter;

        if (matchesSearch && matchesStatus) {
            row.style.display = "";
            visibleCount++;
        } else {
            row.style.display = "none";
        }
    });

    document.getElementById("no-shuttles-message").style.display = visibleCount === 0 ? "block" : "none";
}

function filterStudents() {
    const searchValue = document.getElementById("searchStudents").value.toLowerCase();
    const statusFilter = document.getElementById("statusFilter").value.toLowerCase();
    const rows = document.querySelectorAll("#students-table tr");
    let visibleCount = 0;

    rows.forEach(row => {
        const student = row.querySelector("td:nth-child(1)")?.textContent.toLowerCase() || "";
        const parent = row.querySelector("td:nth-child(2)")?.textContent.toLowerCase() || "";
        const shuttle = row.querySelector("td:nth-child(4)")?.textContent.toLowerCase() || "";
        const status = row.querySelector("td:nth-child(5) span")?.textContent.toLowerCase() || "";

        const matchesSearch = student.includes(searchValue) || parent.includes(searchValue) || shuttle.includes(searchValue);
        const normalizedStatus = status.replace(/\s+/g, '-');
        const matchesStatus = statusFilter === "all" || normalizedStatus === statusFilter;

        if (matchesSearch && matchesStatus) {
            row.style.display = "";
            visibleCount++;
        } else {
            row.style.display = "none";
        }
    });

    document.getElementById("no-students-message").style.display = visibleCount === 0 ? "block" : "none";
}

function filterDrivers() {
    const searchValue = document.getElementById("searchDrivers").value.toLowerCase();
    const statusFilter = document.getElementById("statusFilterDrivers").value.toLowerCase();
    const rows = document.querySelectorAll("#drivers-table tr");
    let visibleCount = 0;

    rows.forEach(row => {
        const driver = row.querySelector("td:nth-child(1)")?.textContent.toLowerCase() || "";
        const operator = row.querySelector("td:nth-child(2)")?.textContent.toLowerCase() || "";
        const license = row.querySelector("td:nth-child(4)")?.textContent.toLowerCase() || "";
        const status = row.querySelector("td:nth-child(6) span")?.textContent.toLowerCase() || "";

        const matchesSearch = driver.includes(searchValue) || operator.includes(searchValue) || license.includes(searchValue);
        const matchesStatus = statusFilter === "all" || status === statusFilter;

        if (matchesSearch && matchesStatus) {
            row.style.display = "";
            visibleCount++;
        } else {
            row.style.display = "none";
        }
    });

    document.getElementById("no-drivers-message").style.display = visibleCount === 0 ? "block" : "none";
}

function filterNotifications() {
    const searchValue = document.getElementById("searchNotifications").value.toLowerCase();
    const statusFilter = document.getElementById("notificationStatusFilter").value.toLowerCase();
    const rows = document.querySelectorAll("#notifications-table tr");
    let visibleCount = 0;

    rows.forEach(row => {
        const message = row.querySelector("td:nth-child(1)")?.textContent.toLowerCase() || "";
        const status = row.querySelector("td:nth-child(3) span")?.textContent.toLowerCase() || "";

        const matchesSearch = message.includes(searchValue);
        const matchesStatus = statusFilter === "all" || status === statusFilter;

        if (matchesSearch && matchesStatus) {
            row.style.display = "";
            visibleCount++;
        } else {
            row.style.display = "none";
        }
    });

    document.getElementById("no-notifications-message").style.display = visibleCount === 0 ? "block" : "none";
}

function markAllAsRead() {
    const statuses = document.querySelectorAll("#notifications-table .status-badge");
    statuses.forEach(status => {
        status.textContent = "Read";
        status.classList.remove("badge-unread");
        status.classList.add("badge-read");
    });
    showToast("All notifications marked as read");
    updateDashboard(); // Update recent activity after change
}

function clearAllNotifications() {
    const tbody = document.getElementById("notifications-table");
    tbody.innerHTML = "";
    document.getElementById("no-notifications-message").style.display = "block";
    showToast("All notifications cleared");
    updateDashboard(); // Update recent activity after change
}

// =================== SHUTTLE MODAL FUNCTIONS ===================
function loadDriversForOperator(opIdElem, driverIdElem) {
    const opValue = document.getElementById(opIdElem).value;
    const dSelect = document.getElementById(driverIdElem);
    dSelect.innerHTML = '<option value="">Select Driver</option>';
    if (opValue && allDrivers.length) {
        const filtered = allDrivers.filter(d => d.operator.operatorId.toString() === opValue);
        filtered.sort((a, b) => a.user.username.localeCompare(b.user.username)).forEach(d => {
            const opt = new Option(d.user.username, d.driverId);
            dSelect.add(opt);
        });
    }
}

async function showAddShuttleModal() {
    document.getElementById('addShuttleModal').style.display = 'flex';
    document.getElementById('addShuttleForm').reset();
    document.getElementById('addShuttleForm').querySelector('#maxCapacityInput').value = 50;
    document.getElementById('add-shuttle-error').style.display = 'none';
    if (!allDrivers.length) {
        await loadDrivers();
    }
    const uniqueOps = {};
    allDrivers.forEach(d => {
        if (!uniqueOps[d.operator.operatorId]) {
            uniqueOps[d.operator.operatorId] = d.operator;
        }
    });
    const opSelect = document.getElementById('operatorSelect');
    opSelect.innerHTML = '<option value="">Select Operator</option>';
    Object.values(uniqueOps).sort((a, b) => a.fullName.localeCompare(b.fullName)).forEach(op => {
        const opt = new Option(op.fullName, op.operatorId);
        opSelect.add(opt);
    });
    document.getElementById('driverSelect').innerHTML = '<option value="">Select Driver</option>';
}

function closeAddShuttleModal() {
    document.getElementById('addShuttleModal').style.display = 'none';
    document.getElementById('addShuttleForm').reset();
    document.getElementById('addShuttleForm').querySelector('#maxCapacityInput').value = 50;
    document.getElementById('add-shuttle-error').style.display = 'none';
}

async function editShuttle(id) {
    try {
        const response = await fetch(`${SERVER_URL}/api/shuttles/${id}`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Failed to fetch shuttle');
        const shuttle = await response.json();
        document.getElementById('edit-shuttle-id').value = shuttle.shuttleId;
        document.getElementById('edit-name-input').value = shuttle.name || '';
        document.getElementById('edit-status-select').value = shuttle.status;
        document.getElementById('edit-route-input').value = shuttle.route || '';
        document.getElementById('edit-max-capacity-input').value = shuttle.maxCapacity || 50;
        if (!allDrivers.length) await loadDrivers();
        const uniqueOps = {};
        allDrivers.forEach(d => {
            if (!uniqueOps[d.operator.operatorId]) {
                uniqueOps[d.operator.operatorId] = d.operator;
            }
        });
        const opSelect = document.getElementById('edit-operator-select');
        opSelect.innerHTML = '<option value="">Select Operator</option>';
        Object.values(uniqueOps).sort((a, b) => a.fullName.localeCompare(b.fullName)).forEach(op => {
            const opt = new Option(op.fullName, op.operatorId);
            opSelect.add(opt);
        });
        opSelect.value = shuttle.operator.operatorId;
        loadDriversForOperator('edit-operator-select', 'edit-driver-select');
        document.getElementById('edit-driver-select').value = shuttle.driver.driverId;
        document.getElementById('editShuttleModal').style.display = 'flex';
        document.getElementById('edit-shuttle-error').style.display = 'none';
    } catch (error) {
        showToast('Error loading shuttle data: ' + error.message);
    }
}

function closeEditShuttleModal() {
    document.getElementById('editShuttleModal').style.display = 'none';
    document.getElementById('editShuttleForm').reset();
    document.getElementById('editShuttleForm').querySelector('#edit-max-capacity-input').value = 50;
    document.getElementById('edit-shuttle-error').style.display = 'none';
}

document.getElementById('addShuttleForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const errorEl = document.getElementById('add-shuttle-error');
    const submitBtn = e.target.querySelector('.submit-btn');
    submitBtn.disabled = true;
    errorEl.style.display = 'none';
    const name = document.getElementById('nameInput').value.trim();
    const opId = document.getElementById('operatorSelect').value;
    const driverId = document.getElementById('driverSelect').value;
    const route = document.getElementById('routeInput').value.trim();
    const maxCapacity = parseInt(document.getElementById('maxCapacityInput').value);
    if (!opId || !driverId || !route || !maxCapacity) {
        errorEl.textContent = 'All required fields must be filled';
        errorEl.style.display = 'block';
        submitBtn.disabled = false;
        return;
    }
    try {
        const body = JSON.stringify({
            name: name || undefined,
            operatorId: parseInt(opId),
            driverId: parseInt(driverId),
            route,
            maxCapacity
        });
        const res = await fetch(`${SERVER_URL}/api/shuttles`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body
        });
        const data = await res.json();
        if (res.ok) {
            showToast('Shuttle added successfully');
            closeAddShuttleModal();
            await loadShuttles();
            updateDashboard();
        } else {
            errorEl.textContent = data.error || 'Failed to add shuttle';
            errorEl.style.display = 'block';
        }
    } catch (err) {
        errorEl.textContent = 'Network error: ' + err.message;
        errorEl.style.display = 'block';
    } finally {
        submitBtn.disabled = false;
    }
});

document.getElementById('editShuttleForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const errorEl = document.getElementById('edit-shuttle-error');
    const submitBtn = e.target.querySelector('.submit-btn');
    submitBtn.disabled = true;
    errorEl.style.display = 'none';
    const id = document.getElementById('edit-shuttle-id').value;
    const name = document.getElementById('edit-name-input').value.trim();
    const status = document.getElementById('edit-status-select').value;
    const opId = document.getElementById('edit-operator-select').value;
    const driverId = document.getElementById('edit-driver-select').value;
    const route = document.getElementById('edit-route-input').value.trim();
    const maxCapacity = parseInt(document.getElementById('edit-max-capacity-input').value);
    if (!status || !opId || !driverId || !route || !maxCapacity) {
        errorEl.textContent = 'All required fields must be filled';
        errorEl.style.display = 'block';
        submitBtn.disabled = false;
        return;
    }
    try {
        const body = JSON.stringify({
            name: name || undefined,
            status,
            operatorId: parseInt(opId),
            driverId: parseInt(driverId),
            route,
            maxCapacity
        });
        const res = await fetch(`${SERVER_URL}/api/shuttles/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body
        });
        const data = await res.json();
        if (res.ok) {
            showToast('Shuttle updated successfully');
            closeEditShuttleModal();
            await loadShuttles();
            updateDashboard();
        } else {
            errorEl.textContent = data.error || 'Failed to update shuttle';
            errorEl.style.display = 'block';
        }
    } catch (err) {
        errorEl.textContent = 'Network error: ' + err.message;
        errorEl.style.display = 'block';
    } finally {
        submitBtn.disabled = false;
    }
});

async function deleteShuttle(id) {
    try {
        const response = await fetch(`${SERVER_URL}/api/shuttles/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            showToast('Shuttle deleted successfully');
            await loadShuttles();
            updateDashboard();
        } else {
            const data = await response.json();
            showToast('Failed to delete shuttle: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        showToast('Error deleting shuttle: ' + error.message);
    }
}

// =================== ADD PARENT & STUDENTS MODAL ===================
function showAddParentModal() {
    document.getElementById('addParentModal').style.display = 'flex';
    resetParentForm();
}

function closeAddParentModal() {
    document.getElementById('addParentModal').style.display = 'none';
    resetParentForm();
}

function resetParentForm() {
    document.getElementById('addParentForm').reset();
    document.getElementById('add-parent-error').style.display = 'none';

    // Reset students container to show only one student
    const container = document.getElementById('students-container');
    container.innerHTML = `
        <div class="student-form" data-student="1">
            <div class="student-header">
                <h5>Student 1</h5>
                <button type="button" class="remove-student-btn" onclick="removeStudentForm(1)" style="display: none;">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="student-1-username">Username *</label>
                    <input type="text" id="student-1-username" required>
                </div>
                <div class="form-group">
                    <label for="student-1-email">Email *</label>
                    <input type="email" id="student-1-email" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group password-wrapper">
                    <label for="student-1-password">Password *</label>
                    <input type="password" id="student-1-password" required>
                    <span class="toggle-password" onclick="togglePassword('student-1-password', this)">
                        <i class="fa-solid fa-eye-slash"></i>
                    </span>
                </div>
                <div class="form-group">
                    <label for="student-1-fullname">Full Name *</label>
                    <input type="text" id="student-1-fullname" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="student-1-address">Current Address *</label>
                    <input type="text" id="student-1-address" required>
                </div>
                <div class="form-group">
                    <label for="student-1-grade">Grade *</label>
                    <select id="student-1-grade" required>
                        <option value="">Select Grade</option>
                        <option value="Grade 7">Grade 7</option>
                        <option value="Grade 8">Grade 8</option>
                        <option value="Grade 9">Grade 9</option>
                        <option value="Grade 10">Grade 10</option>
                        <option value="Grade 11">Grade 11</option>
                        <option value="Grade 12">Grade 12</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="student-1-section">Section *</label>
                    <input type="text" id="student-1-section" placeholder="e.g., Section A" required>
                </div>
            </div>
        </div>
    `;
    studentCounter = 1;
}

function addStudentForm() {
    studentCounter++;
    const container = document.getElementById('students-container');
    const studentForm = document.createElement('div');
    studentForm.className = 'student-form';
    studentForm.setAttribute('data-student', studentCounter);

    studentForm.innerHTML = `
        <div class="student-header">
            <h5>Student ${studentCounter}</h5>
            <button type="button" class="remove-student-btn" onclick="removeStudentForm(${studentCounter})">
                <i class="fa-solid fa-trash"></i>
            </button>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="student-${studentCounter}-username">Username *</label>
                <input type="text" id="student-${studentCounter}-username" required>
            </div>
            <div class="form-group">
                <label for="student-${studentCounter}-email">Email *</label>
                <input type="email" id="student-${studentCounter}-email" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group password-wrapper">
                <label for="student-${studentCounter}-password">Password *</label>
                <input type="password" id="student-${studentCounter}-password" required>
                <span class="toggle-password" onclick="togglePassword('student-${studentCounter}-password', this)">
                    <i class="fa-solid fa-eye-slash"></i>
                </span>
            </div>
            <div class="form-group">
                <label for="student-${studentCounter}-fullname">Full Name *</label>
                <input type="text" id="student-${studentCounter}-fullname" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="student-${studentCounter}-address">Current Address *</label>
                <input type="text" id="student-${studentCounter}-address" required>
            </div>
            <div class="form-group">
                <label for="student-${studentCounter}-grade">Grade *</label>
                <select id="student-${studentCounter}-grade" required>
                    <option value="">Select Grade</option>
                    <option value="Grade 7">Grade 7</option>
                    <option value="Grade 8">Grade 8</option>
                    <option value="Grade 9">Grade 9</option>
                    <option value="Grade 10">Grade 10</option>
                    <option value="Grade 11">Grade 11</option>
                    <option value="Grade 12">Grade 12</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="student-${studentCounter}-section">Section *</label>
                <input type="text" id="student-${studentCounter}-section" placeholder="e.g., Section A" required>
            </div>
        </div>
    `;

    container.appendChild(studentForm);

    // Show remove buttons for all students except the first one
    updateStudentRemoveButtons();
}

function removeStudentForm(studentId) {
    const studentForm = document.querySelector(`[data-student="${studentId}"]`);
    if (studentForm) {
        studentForm.remove();
        updateStudentRemoveButtons();
    }
}

function updateStudentRemoveButtons() {
    const studentForms = document.querySelectorAll('.student-form');
    studentForms.forEach((form, index) => {
        const removeBtn = form.querySelector('.remove-student-btn');
        if (index === 0 && studentForms.length === 1) {
            removeBtn.style.display = 'none';
        } else {
            removeBtn.style.display = 'block';
        }
    });
}

// Handle parent form submission
document.getElementById('addParentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const errorElement = document.getElementById('add-parent-error');
    const submitButton = e.target.querySelector('.submit-btn');

    errorElement.style.display = 'none';
    submitButton.disabled = true;

    try {
        // Collect parent data
        const parentData = {
            username: document.getElementById('parent-username').value,
            email: document.getElementById('parent-email').value,
            password: document.getElementById('parent-password').value,
            role: "PARENT",
            currentAddress: document.getElementById('parent-address').value,
            fullName: document.getElementById('parent-fullname').value,
            contactPhone: document.getElementById('parent-phone').value
        };

        // Collect students data
        const studentsData = [];
        const studentForms = document.querySelectorAll('.student-form');

        studentForms.forEach(form => {
            const studentId = form.getAttribute('data-student');
            const studentData = {
                username: document.getElementById(`student-${studentId}-username`).value,
                email: document.getElementById(`student-${studentId}-email`).value,
                password: document.getElementById(`student-${studentId}-password`).value,
                role: "STUDENT",
                currentAddress: document.getElementById(`student-${studentId}-address`).value,
                fullName: document.getElementById(`student-${studentId}-fullname`).value,
                grade: document.getElementById(`student-${studentId}-grade`).value,
                section: document.getElementById(`student-${studentId}-section`).value
            };
            studentsData.push(studentData);
        });

        const requestBody = {
            parent: parentData,
            students: studentsData
        };

        const response = await fetch(`${SERVER_URL}/api/auth/sign-up/parents`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(requestBody)
        });

        const result = await response.json();

        if (response.ok) {
            showToast('Parent and students registered successfully!');
            closeAddParentModal();
            await loadStudents(); // Refresh students table
            updateDashboard();
        } else {
            errorElement.textContent = result.error || 'Failed to register parent and students';
            errorElement.style.display = 'block';
        }
    } catch (error) {
        errorElement.textContent = 'Network error: ' + error.message;
        errorElement.style.display = 'block';
    } finally {
        submitButton.disabled = false;
    }
});

// =================== ADD OPERATOR & DRIVERS MODAL ===================
function showAddOperatorModal() {
    document.getElementById('addOperatorModal').style.display = 'flex';
    resetOperatorForm();
}

function closeAddOperatorModal() {
    document.getElementById('addOperatorModal').style.display = 'none';
    resetOperatorForm();
}

function resetOperatorForm() {
    document.getElementById('addOperatorForm').reset();
    document.getElementById('add-operator-error').style.display = 'none';

    // Reset drivers container to show only one driver
    const container = document.getElementById('drivers-container');
    container.innerHTML = `
        <div class="driver-form" data-driver="1">
            <div class="driver-header">
                <h5>Driver 1</h5>
                <button type="button" class="remove-driver-btn" onclick="removeDriverForm(1)" style="display: none;">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="driver-1-username">Username *</label>
                    <input type="text" id="driver-1-username" required>
                </div>
                <div class="form-group">
                    <label for="driver-1-email">Email *</label>
                    <input type="email" id="driver-1-email" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group password-wrapper">
                    <label for="driver-1-password">Password *</label>
                    <input type="password" id="driver-1-password" required>
                    <span class="toggle-password" onclick="togglePassword('driver-1-password', this)">
                        <i class="fa-solid fa-eye-slash"></i>
                    </span>
                </div>
                <div class="form-group">
                    <label for="driver-1-license">License Number *</label>
                    <input type="text" id="driver-1-license" placeholder="e.g., DRV-12345" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="driver-1-phone">Contact Phone *</label>
                    <input type="tel" id="driver-1-phone" placeholder="+63-912-345-6789" required>
                </div>
                <div class="form-group">
                    <label for="driver-1-emergency">Emergency Contact *</label>
                    <input type="tel" id="driver-1-emergency" placeholder="+63-912-345-6789" required>
                </div>
            </div>
        </div>
    `;
    driverCounter = 1;
}

function addDriverForm() {
    driverCounter++;
    const container = document.getElementById('drivers-container');
    const driverForm = document.createElement('div');
    driverForm.className = 'driver-form';
    driverForm.setAttribute('data-driver', driverCounter);

    driverForm.innerHTML = `
        <div class="driver-header">
            <h5>Driver ${driverCounter}</h5>
            <button type="button" class="remove-driver-btn" onclick="removeDriverForm(${driverCounter})">
                <i class="fa-solid fa-trash"></i>
            </button>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="driver-${driverCounter}-username">Username *</label>
                <input type="text" id="driver-${driverCounter}-username" required>
            </div>
            <div class="form-group">
                <label for="driver-${driverCounter}-email">Email *</label>
                <input type="email" id="driver-${driverCounter}-email" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group password-wrapper">
                <label for="driver-${driverCounter}-password">Password *</label>
                <input type="password" id="driver-${driverCounter}-password" required>
                <span class="toggle-password" onclick="togglePassword('driver-${driverCounter}-password', this)">
                    <i class="fa-solid fa-eye-slash"></i>
                </span>
            </div>
            <div class="form-group">
                <label for="driver-${driverCounter}-license">License Number *</label>
                <input type="text" id="driver-${driverCounter}-license" placeholder="e.g., DRV-12345" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="driver-${driverCounter}-phone">Contact Phone *</label>
                <input type="tel" id="driver-${driverCounter}-phone" placeholder="+63-912-345-6789" required>
            </div>
            <div class="form-group">
                <label for="driver-${driverCounter}-emergency">Emergency Contact *</label>
                <input type="tel" id="driver-${driverCounter}-emergency" placeholder="+63-912-345-6789" required>
            </div>
        </div>
    `;

    container.appendChild(driverForm);

    // Show remove buttons for all drivers except the first one
    updateDriverRemoveButtons();
}

function removeDriverForm(driverId) {
    const driverForm = document.querySelector(`[data-driver="${driverId}"]`);
    if (driverForm) {
        driverForm.remove();
        updateDriverRemoveButtons();
    }
}

function updateDriverRemoveButtons() {
    const driverForms = document.querySelectorAll('.driver-form');
    driverForms.forEach((form, index) => {
        const removeBtn = form.querySelector('.remove-driver-btn');
        if (index === 0 && driverForms.length === 1) {
            removeBtn.style.display = 'none';
        } else {
            removeBtn.style.display = 'block';
        }
    });
}

// Handle operator form submission
document.getElementById('addOperatorForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const errorElement = document.getElementById('add-operator-error');
    const submitButton = e.target.querySelector('.submit-btn');

    errorElement.style.display = 'none';
    submitButton.disabled = true;

    try {
        // Collect operator data
        const operatorData = {
            username: document.getElementById('operator-username').value,
            email: document.getElementById('operator-email').value,
            password: document.getElementById('operator-password').value,
            role: "OPERATOR",
            fullName: document.getElementById('operator-fullname').value,
            contactPhone: document.getElementById('operator-phone').value
        };

        // Collect drivers data
        const driversData = [];
        const driverForms = document.querySelectorAll('.driver-form');

        driverForms.forEach(form => {
            const driverId = form.getAttribute('data-driver');
            const driverData = {
                username: document.getElementById(`driver-${driverId}-username`).value,
                email: document.getElementById(`driver-${driverId}-email`).value,
                password: document.getElementById(`driver-${driverId}-password`).value,
                role: "DRIVER",
                licenseNumber: document.getElementById(`driver-${driverId}-license`).value,
                contactPhone: document.getElementById(`driver-${driverId}-phone`).value,
                emergencyContact: document.getElementById(`driver-${driverId}-emergency`).value
            };
            driversData.push(driverData);
        });

        const requestBody = {
            operator: operatorData,
            drivers: driversData
        };

        const response = await fetch(`${SERVER_URL}/api/auth/sign-up/operators`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(requestBody)
        });

        const result = await response.json();

        if (response.ok) {
            showToast('Operator and drivers registered successfully!');
            closeAddOperatorModal();
            await loadDrivers(); // Refresh shuttles table
            updateDashboard();
        } else {
            errorElement.textContent = result.error || 'Failed to register operator and drivers';
            errorElement.style.display = 'block';
        }
    } catch (error) {
        errorElement.textContent = 'Network error: ' + error.message;
        errorElement.style.display = 'block';
    } finally {
        submitButton.disabled = false;
    }
});

// =================== BULK UPLOAD MODAL ===================
function showBulkUploadModal(type) {
    bulkType = type;
    const title = type === 'students' ? 'Parents & Students' : 'Operators & Drivers';
    document.getElementById('bulk-title').innerHTML = `<i class="fa-solid fa-upload"></i> Bulk Upload ${title}`;
    document.getElementById('bulkUploadModal').style.display = 'flex';
    document.getElementById('bulkUploadForm').reset();
    document.getElementById('bulk-error').style.display = 'none';
}

function closeBulkUploadModal() {
    document.getElementById('bulkUploadModal').style.display = 'none';
    bulkType = '';
}

// Handle bulk upload form submission
document.getElementById('bulkUploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fileInput = document.getElementById('bulk-file');
    const errorElement = document.getElementById('bulk-error');
    const submitButton = e.target.querySelector('.submit-btn');

    if (!fileInput.files[0]) {
        errorElement.textContent = 'Please select a file';
        errorElement.style.display = 'block';
        return;
    }

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    submitButton.disabled = true;
    errorElement.style.display = 'none';

    try {
        // Determine the endpoint based on bulkType
        const endpoint = bulkType === 'students'
            ? `${SERVER_URL}/api/admin/bulk-upload/parents-students`
            : `${SERVER_URL}/api/admin/bulk-upload/operators-drivers`;

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            showToast(`Bulk upload successful: ${result.successful || 'Multiple'} users added`);
            closeBulkUploadModal();
            if (bulkType === 'students') {
                await loadStudents();
            } else {
                await loadDrivers();
            }
            updateDashboard();
        } else {
            errorElement.textContent = result.error || 'Failed to upload file';
            errorElement.style.display = 'block';
        }
    } catch (error) {
        errorElement.textContent = 'Network error: ' + error.message;
        errorElement.style.display = 'block';
    } finally {
        submitButton.disabled = false;
    }
});

// =================== ELLIPSIS DROPDOWN ===================
function toggleDropdown(btn) {
    // Get the dropdown menu associated with the clicked button
    const menu = btn.parentElement.querySelector('.dropdown-menu');

    // Close all other dropdowns
    document.querySelectorAll('.dropdown-menu').forEach(otherMenu => {
        if (otherMenu !== menu) {
            otherMenu.style.display = 'none';
        }
    });

    // Toggle the current dropdown
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

// Close dropdowns when clicking outside
document.addEventListener('click', (e) => {
    // Check if the click is outside any dropdown menu or ellipsis button
    if (!e.target.closest('.actions-dropdown') && !e.target.closest('.ellipsis-btn')) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.style.display = 'none';
        });
    }
});

// =================== STUDENT ACTIONS ===================
async function editStudent(id) {
    try {
        const response = await fetch(`${SERVER_URL}/api/students/${id}`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Failed to fetch student');
        const student = await response.json();
        document.getElementById('edit-student-id').value = id;
        document.getElementById('edit-student-fullname').value = student.fullName || '';
        document.getElementById('edit-student-grade').value = student.grade || '';
        document.getElementById('edit-student-section').value = student.section || '';
        document.getElementById('edit-student-address').value = student.currentAddress || '';
        // Parent fields
        document.getElementById('edit-parent-id').value = student.parent.parentId;
        document.getElementById('edit-parent-fullname').value = student.parent.fullName || '';
        document.getElementById('edit-parent-phone').value = student.parent.contactPhone || '';
        document.getElementById('edit-parent-address').value = student.parent.currentAddress || '';
        document.getElementById('editStudentModal').style.display = 'flex';
    } catch (error) {
        showToast('Error loading student data: ' + error.message);
    }
}

function closeEditStudentModal() {
    document.getElementById('editStudentModal').style.display = 'none';
    document.getElementById('editStudentForm').reset();
    document.getElementById('edit-student-error').style.display = 'none';
}

document.getElementById('editStudentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('edit-student-id').value;
    const parentId = document.getElementById('edit-parent-id').value;
    const updatedStudent = {
        fullName: document.getElementById('edit-student-fullname').value,
        grade: document.getElementById('edit-student-grade').value,
        section: document.getElementById('edit-student-section').value,
        currentAddress: document.getElementById('edit-student-address').value
    };
    const updatedParent = {
        fullName: document.getElementById('edit-parent-fullname').value,
        contactPhone: document.getElementById('edit-parent-phone').value,
        currentAddress: document.getElementById('edit-parent-address').value
    };
    const errorElement = document.getElementById('edit-student-error');
    const submitButton = e.target.querySelector('.submit-btn');
    submitButton.disabled = true;
    errorElement.style.display = 'none';

    try {
        // Update student
        const studentResponse = await fetch(`${SERVER_URL}/api/students/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(updatedStudent)
        });
        if (!studentResponse.ok) throw new Error('Failed to update student');

        // Update parent
        const parentResponse = await fetch(`${SERVER_URL}/api/parents/${parentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(updatedParent)
        });
        if (!parentResponse.ok) throw new Error('Failed to update parent');

        showToast('Student and parent updated successfully');
        closeEditStudentModal();
        await loadStudents();
        updateDashboard();
    } catch (error) {
        errorElement.textContent = error.message;
        errorElement.style.display = 'block';
    } finally {
        submitButton.disabled = false;
    }
});

async function deleteStudent(id) {
    try {
        const response = await fetch(`${SERVER_URL}/api/students/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            showToast('Student deleted successfully');
            await loadStudents();
            updateDashboard();
        } else {
            const data = await response.json();
            showToast('Failed to delete student: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        showToast('Error deleting student: ' + error.message);
    }
}

// =================== DRIVER ACTIONS ===================
async function editDriver(id) {
    try {
        const response = await fetch(`${SERVER_URL}/api/drivers/${id}`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Failed to fetch driver');
        const driver = await response.json();
        document.getElementById('edit-driver-id').value = id;
        document.getElementById('edit-driver-contact').value = driver.contactPhone || '';
        document.getElementById('edit-driver-license').value = driver.licenseNumber || '';
        document.getElementById('edit-driver-emergency').value = driver.emergencyContact || '';
        // Operator fields
        document.getElementById('edit-operator-id').value = driver.operator.operatorId;
        document.getElementById('edit-operator-fullname').value = driver.operator.fullName || '';
        document.getElementById('edit-operator-phone').value = driver.operator.contactPhone || '';
        document.getElementById('editDriverModal').style.display = 'flex';
    } catch (error) {
        showToast('Error loading driver data: ' + error.message);
    }
}

function closeEditDriverModal() {
    document.getElementById('editDriverModal').style.display = 'none';
    document.getElementById('editDriverForm').reset();
    document.getElementById('edit-driver-error').style.display = 'none';
}

document.getElementById('editDriverForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('edit-driver-id').value;
    const operatorId = document.getElementById('edit-operator-id').value;
    const updatedDriver = {
        contactPhone: document.getElementById('edit-driver-contact').value,
        licenseNumber: document.getElementById('edit-driver-license').value,
        emergencyContact: document.getElementById('edit-driver-emergency').value
    };
    const updatedOperator = {
        fullName: document.getElementById('edit-operator-fullname').value,
        contactPhone: document.getElementById('edit-operator-phone').value
    };
    const errorElement = document.getElementById('edit-driver-error');
    const submitButton = e.target.querySelector('.submit-btn');
    submitButton.disabled = true;
    errorElement.style.display = 'none';

    try {
        // Update driver
        const driverResponse = await fetch(`${SERVER_URL}/api/drivers/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(updatedDriver)
        });
        if (!driverResponse.ok) throw new Error('Failed to update driver');

        // Update operator
        const operatorResponse = await fetch(`${SERVER_URL}/api/operators/${operatorId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(updatedOperator)
        });
        if (!operatorResponse.ok) throw new Error('Failed to update operator');

        showToast('Driver and operator updated successfully');
        closeEditDriverModal();
        await loadDrivers();
        updateDashboard();
    } catch (error) {
        errorElement.textContent = error.message;
        errorElement.style.display = 'block';
    } finally {
        submitButton.disabled = false;
    }
});

async function deleteDriver(id) {
    try {
        const response = await fetch(`${SERVER_URL}/api/drivers/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            showToast('Driver deleted successfully');
            await loadDrivers();
            updateDashboard();
        } else {
            const data = await response.json();
            showToast('Failed to delete driver: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        showToast('Error deleting driver: ' + error.message);
    }
}

styles.css:
/* === General Reset === */
body, html {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', sans-serif;
    height: 100%;
    overflow: hidden;
    background-color: #F5F5F5; /* Light Grayish-White */
}

/* === Login Page === */
.login-bg {
    background-image: url('images/background.jpg');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

.login-container {
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.75), rgba(250, 204, 21, 0.75)); /* Bright Yellow to Lighter Yellow with increased transparency */
    padding: 3rem 2.5rem;
    border-radius: 25px;
    text-align: center;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.35);
    width: 370px;
    animation: fadeInZoom 0.5s ease;
}

@keyframes fadeInZoom {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}

.login-container .logo {
    width: 150px;
    margin-bottom: 1.5rem;
}

.login-container input {
    width: 77%;
    padding: 1rem;
    margin-bottom: 1.2rem;
    border: 2px solid #FBBF24; /* Bright Yellow */
    border-radius: 10px;
    font-size: 1rem;
    outline: none;
    background-color: rgba(255, 255, 255, 0.9); /* White with opacity */
    color: #003A6C; /* Ateneo Blue */
}

.login-container button {
    width: 86%;
    padding: 1rem;
    background: #003A6C; /* Ateneo Blue */
    color: #FFFFFF; /* White text */
    border: none;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: bold; /* Bold text */
    cursor: pointer;
    transition: background 0.3s;
}

.login-container button:hover {
    background: #0066CC; /* Lighter Ateneo Blue for hover */
}

.login-container a {
    color: #0066CC; /* Lighter Ateneo Blue */
    text-decoration: none;
}

.login-container a:hover {
    text-decoration: underline;
}

/* === Sidebar === */
.sidebar-profile {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 2rem;
}

.sidebar-profile-pic {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 1rem;
    border: 2px solid #0066CC; /* Lighter Ateneo Blue */
}

.sidebar-username, .sidebar-email {
    color: #F5F5F5; /* Light Grayish-White */
    font-size: 0.9rem;
    margin: 0.2rem 0;
    text-align: center;
    max-width: 180px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.sidebar {
    position: fixed;
    top: 0;
    left: -240px;
    width: 220px;
    height: 100%;
    background: linear-gradient(135deg, #003A6C, #0066CC); /* Ateneo Blue to Lighter Blue */
    color: #F5F5F5; /* Light Grayish-White */
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 2rem;
    transition: left 0.3s ease;
    z-index: 1000;
    box-shadow: 2px 0 8px rgba(0,0,0,0.2);
}

.sidebar.active {
    left: 0;
}

.sidebar-logo {
    width: 100px;
    margin-bottom: 2rem;
}

.sidebar ul {
    list-style: none;
    padding: 0;
    width: 100%;
}

.sidebar ul li {
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2); /* White with opacity */
    cursor: pointer;
    text-align: left;
    transition: background 0.3s;
    padding-left: 2rem;
}

.sidebar ul li:hover {
    background: rgba(255, 255, 255, 0.1); /* White with opacity */
}

/* === Toggle Button === */
.sidebar-toggle {
    position: fixed;
    top: 20px;
    left: 20px;
    font-size: 1.5rem;
    cursor: pointer;
    background: linear-gradient(135deg, #003A6C, #0066CC); /* Ateneo Blue to Lighter Blue */
    color: #F5F5F5; /* Light Grayish-White */
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    z-index: 1100;
}

/* === Content === */
.dashboard {
    display: flex;
    height: 100vh;
    overflow: hidden;
}

.content {
    flex: 1;
    margin-left: 0;
    padding: 2rem;
    transition: margin-left 0.3s ease;
    overflow-y: auto;
    width: 100%;
    background: #F3F4F6; /* Light Gray */
}

/* === Tabs === */
.tab {
    display: none;
}

.tab.active {
    display: block;
}

/* === Unified Header Styling for All Tabs === */
.tab header {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    padding-left: 40px;
}

.tab header .title-container {
    display: flex;
    align-items: center;
}

.tab header i {
    margin-right: 0.5rem;
    font-size: 1.5rem;
    color: #003A6C; /* Ateneo Blue */
}

.tab header h2 {
    margin: 0;
    font-size: 1.5rem;
    color: #003A6C; /* Ateneo Blue */
}

.tab header p {
    margin: 0.5rem 0 0 0;
    font-size: 1rem;
    color: #003A6C; /* Ateneo Blue */
}

/* === Cards and Tables === */
.balance-section {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    justify-content: space-between;
    margin: 1.5rem 0;
    padding: 0 1rem;
}

.balance-card {
    background: linear-gradient(135deg, #003A6C, #0066CC); /* Ateneo Blue to Lighter Blue */
    color: #F5F5F5; /* Light Grayish-White */
    padding: 1.5rem;
    border-radius: 15px;
    flex: 1;
    min-width: 250px;
    max-width: 300px;
    width: 100%; /* Ensure it respects the max-width */
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    overflow: hidden; /* Clip any overflow */
    display: flex;
    flex-direction: column;
}

.balance-card .label {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 0.5rem;
}

.balance-card h1 {
    font-size: 2rem;
    margin: 0;
    font-weight: bold;
}

.chart-card {
    background: #F3F4F6; /* Light Gray */
    padding: 1.5rem;
    border-radius: 15px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    flex: 2;
    min-width: 300px;
    width: 100%;
    max-height: none;
}

.notifications-card {
    background: #F3F4F6; /* Light Gray */
    padding: 1.5rem;
    border-radius: 15px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    flex: 1;
    min-width: 250px;
    max-width: 300px;
    max-height: none;
}

.chart-card canvas {
    width: 100% !important;
    height: 25vw !important;
    max-height: 400px;
    min-height: 200px;
}

.chart-card h4, .notifications-card h4 {
    margin: 0 0 1rem;
    color: #003A6C; /* Ateneo Blue */
}

/* === Recent Activity Subtitle === */
.activity-subtitle {
    font-size: 0.8rem;
    color: #666; /* Medium gray for subtitle text */
    margin-top: 0.25rem;
    font-style: italic; /* Optional: makes subtitle distinct */
}

/* === Notification Items === */
.notification-item {
    padding: 0.75rem 0;
    border-bottom: 1px solid #D1D5DB; /* Medium Gray */
}

.notification-item:last-child {
    border-bottom: none;
}

.notification-item p {
    margin: 0.25rem 0;
    font-size: 0.95rem;
    color: #003A6C; /* Ateneo Blue */
}

/* === Table Header === */
.table-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    padding-left: 40px;
}

.table-title-section h3 {
    margin: 0;
    font-size: 1.2rem;
    color: #003A6C; /* Ateneo Blue */
}

.table-title-section p {
    margin: 0.5rem 0 0 0;
    font-size: 0.9rem;
    color: #003A6C; /* Ateneo Blue */
}

.table-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

.table-actions select {
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid #003A6C; /* Ateneo Blue */
    font-size: 0.9rem;
    background: #F3F4F6; /* Light Gray */
    color: #003A6C; /* Ateneo Blue */
}

/* === Add Button === */
.add-btn {
    padding: 10px 16px;
    background: linear-gradient(135deg, #003A6C, #0066CC); /* Ateneo Blue to Lighter Blue */
    color: #F5F5F5; /* Light Grayish-White */
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: opacity 0.3s;
}

.add-btn:hover {
    opacity: 0.9;
}

.add-btn i {
    font-size: 0.9rem;
}

/* === Bulk Upload Button === */
.bulk-btn {
    background: linear-gradient(135deg, #f0ad4e, #ec971f); /* Orange for bulk */
}

.bulk-btn:hover {
    opacity: 0.9;
}

/* === Table === */
table {
    width: 100%;
    border-collapse: collapse;
    background: #F3F4F6; /* Light Gray */
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    table-layout: fixed;
}

thead {
    background: linear-gradient(135deg, #003A6C, #0066CC); /* Ateneo Blue to Lighter Blue */
    color: #F5F5F5; /* Light Grayish-White */
}

td, th {
    padding: 0.8rem;
    text-align: left;
    border-bottom: 1px solid #D1D5DB; /* Medium Gray */
    white-space: normal;
    word-wrap: break-word;
}

tbody tr:hover {
    background: rgba(0, 58, 108, 0.1); /* Ateneo Blue with opacity */
}

/* === Modal === */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 2000;
    overflow-y: auto;
    padding: 20px 0;
}

.modal-content {
    background: #F3F4F6; /* Light Gray */
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    width: 320px;
    text-align: center;
}

.modal-content input {
    width: 90%;
    padding: 0.75rem;
    margin-bottom: 1rem;
    border: 1px solid #003A6C; /* Ateneo Blue */
    border-radius: 8px;
    background-color: #fff;
    color: #003A6C; /* Ateneo Blue */
}

.modal-content button {
    padding: 0.6rem 1.2rem;
    margin: 0.3rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    background: linear-gradient(135deg, #003A6C, #0066CC); /* Ateneo Blue to Lighter Blue */
    color: #F5F5F5; /* Light Grayish-White */
}

.modal-content button:last-child {
    background: linear-gradient(135deg, #D1D5DB, #D1D5DB); /* Medium Gray */
    color: black;
}

/* === Bulk Upload Modal === */
.bulk-upload-modal {
    width: 400px;
    text-align: center;
}

#bulk-file {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #003A6C;
    border-radius: 8px;
    margin-bottom: 0.5rem;
}

/* === Add Form Modal === */
.add-form-modal {
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    text-align: left;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #003A6C;
}

.modal-header h3 {
    margin: 0;
    color: #003A6C;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.close-modal {
    font-size: 2rem;
    cursor: pointer;
    color: #003A6C;
    font-weight: bold;
    line-height: 1;
}

.close-modal:hover {
    color: #0066CC;
}

/* === Form Sections === */
.form-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.form-section h4 {
    margin: 0 0 1.5rem 0;
    color: #003A6C;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #D1D5DB;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.section-header h4 {
    margin: 0;
    border-bottom: none;
    padding-bottom: 0;
}

.add-student-btn, .add-driver-btn {
    padding: 8px 12px;
    background: linear-gradient(135deg, #5cb85c, #4cae4c);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 6px;
}

.add-student-btn:hover, .add-driver-btn:hover {
    opacity: 0.9;
}

/* === Form Rows and Groups === */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-size: 0.9rem;
    color: #003A6C;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.form-group input, .form-group select {
    padding: 0.75rem;
    border: 1px solid #003A6C;
    border-radius: 8px;
    font-size: 1rem;
    background: #fff;
    color: #003A6C;
    box-sizing: border-box;
}

.form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: #0066CC;
    box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.2);
}

/* === Student/Driver Forms === */
.student-form, .driver-form {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 10px;
    border: 1px solid #D1D5DB;
}

.student-header, .driver-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #D1D5DB;
}

.student-header h5, .driver-header h5 {
    margin: 0;
    color: #003A6C;
    font-size: 1.1rem;
}

.remove-student-btn, .remove-driver-btn {
    padding: 6px 10px;
    background: #d9534f;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 4px;
}

.remove-student-btn:hover, .remove-driver-btn:hover {
    background: #c9302c;
}

/* === Modal Actions === */
.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #D1D5DB;
}

.cancel-btn {
    padding: 0.75rem 1.5rem;
    background: #D1D5DB;
    color: #333;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
}

.cancel-btn:hover {
    background: #c3c9d0;
}

.submit-btn {
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #003A6C, #0066CC);
    color: #F5F5F5;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
}

.submit-btn:hover {
    opacity: 0.9;
}

.submit-btn:disabled {
    background: #D1D5DB;
    cursor: not-allowed;
    opacity: 0.7;
}

/* === Modal Confirm === */
.modal-confirm {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 3000;
}

.modal-confirm-content {
    background: #F3F4F6; /* Light Gray */
    padding: 2rem;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    width: 400px;
}

.modal-confirm-content h3 {
    margin: 0 0 1rem 0;
    color: #003A6C;
}

.modal-confirm-content p {
    margin-bottom: 1.5rem;
    color: #666;
}

.modal-confirm-content button {
    margin: 0 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
}

.confirm-action {
    background: #d9534f;
    color: white;
}

.cancel-action {
    background: #D1D5DB;
    color: #333;
}

/* === Password Toggle === */
.password-wrapper {
    position: relative;
}

.toggle-password {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    font-size: 1rem;
    color: #003A6C; /* Ateneo Blue */
}

.toggle-password:hover {
    color: #0066CC; /* Lighter Ateneo Blue */
}

.form-group .password-wrapper .toggle-password {
    top: 65%;
    transform: translateY(-50%);
}

.login-container .password-wrapper .toggle-password {
    right: 45px; /* Adjusted to align within login input field */
    top: 35%; /* Adjusted to vertically center in login input */
}

/* === Profile Tab === */
#profile header h2 {
    font-size: 1.5rem;
    color: #003A6C; /* Ateneo Blue */
    margin-left: 40px;
    margin-top: 2px;
    margin-bottom: 1.5rem;
}

.profile-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 2rem;
    padding: 0 40px;
    max-width: 1200px;
    margin: 0 auto;
}

.profile-card {
    background: #F3F4F6; /* Light Gray */
    padding: 1.5rem;
    border-radius: 15px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.profile-card h3 {
    margin: 0 0 1rem;
    color: #003A6C; /* Ateneo Blue */
    font-size: 1.2rem;
}

.profile-card .info-row p {
    margin: 0.5rem 0;
    font-size: 1rem;
    color: #003A6C; /* Ateneo Blue */
}

.profile-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.profile-form .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.profile-form label {
    font-size: 0.9rem;
    color: #003A6C; /* Ateneo Blue */
    font-weight: 500;
}

.profile-form input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #003A6C; /* Ateneo Blue */
    border-radius: 8px;
    font-size: 1rem;
    background: #fff;
    box-sizing: border-box;
    color: #003A6C; /* Ateneo Blue */
}

.profile-form .password-wrapper .toggle-password {
    right: 10px;
    top: 65%;
    transform: translateY(-50%);
}

.profile-button {
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #003A6C, #0066CC); /* Ateneo Blue to Lighter Blue */
    color: #F5F5F5; /* Light Grayish-White */
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    font-size: 1rem;
    transition: opacity 0.3s;
}

.profile-button:hover {
    opacity: 0.9;
}

.profile-button:disabled {
    background: linear-gradient(135deg, #D1D5DB, #D1D5DB); /* Medium Gray */
    cursor: not-allowed;
    opacity: 0.7;
}

/* === Profile Picture === */
.profile-picture-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 1.5rem;
}

.profile-picture-upload {
    margin-top: 0.5rem;
}

.profile-picture-upload button {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    background: linear-gradient(135deg, #003A6C, #0066CC); /* Ateneo Blue to Lighter Blue */
    color: #F5F5F5; /* Light Grayish-White */
    border: none;
    border-radius: 8px;
    cursor: pointer;
}

#profile-picture-error {
    text-align: center;
    color: #d9534f; /* Unchanged: Error text */
}

/* === Search Bar & Table Actions === */
.search-container {
    position: relative;
    width: 320px;
    max-width: 100%;
    margin-bottom: 1rem;
}

.search-container input {
    width: 100%;
    padding: 10px 40px 10px 12px;
    font-size: 15px;
    border: 1px solid #003A6C; /* Ateneo Blue */
    border-radius: 6px;
    background: #fff;
    color: #003A6C; /* Ateneo Blue */
}

.users-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 10px;
}

.add-user-btn {
    padding: 10px 16px;
    background: linear-gradient(135deg, #003A6C, #0066CC); /* Ateneo Blue to Lighter Blue */
    color: #F5F5F5; /* Light Grayish-White */
    font-weight: bold;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: opacity 0.3s;
}

.add-user-btn:hover {
    opacity: 0.9;
}

/* === Status Badges === */
.status-badge {
    padding: 0.3rem 0.6rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
    color: white;
}

.badge-pending {
    background: #f0ad4e;
}

.badge-released {
    background: #5cb85c;
}

.badge-denied {
    background: #d9534f;
}

.badge-liquidated {
    background: #5cb85c;
}

.badge-active {
    background: #5cb85c;
}

.badge-inactive {
    background: #d9534f;
}

.badge-maintenance {
    background: #f0ad4e;
}

/* === Toast Notification === */
#toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(135deg, #008000, #2a6f2a); /* Unchanged: Green for toast */
    color: #fff;
    padding: 1rem 1.5rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    display: none;
    animation: fadeInOut 4s forwards;
    z-index: 3000;
    font-size: 1rem;
}

@keyframes fadeInOut {
    0% { opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { opacity: 0; }
}

/* === Delete Icon Button === */
.delete-icon-btn {
    background: none;
    border: none;
    padding: 5px 8px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
}

.delete-icon-btn i.fas.fa-trash-alt {
    color: #d9534f; /* Unchanged: Red */
    font-size: 14px;
}

.delete-icon-btn:hover i.fas.fa-trash-alt {
    color: #003A6C; /* Ateneo Blue */
}

/* === Action Buttons === */
.action-btn {
    padding: 6px 10px;
    border: none;
    border-radius: 6px;
    background: linear-gradient(135deg, #5cb85c, #4cae4c);
    color: white;
    cursor: pointer;
    font-size: 0.85rem;
}

.track-btn {
    background: linear-gradient(135deg, #337ab7, #286090);
}

/* === Ellipsis Dropdown === */
.actions-dropdown {
    position: relative;
    display: inline-block;
}

.ellipsis-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: #666;
    padding: 5px;
    font-size: 1rem;
}

.ellipsis-btn:hover {
    color: #003A6C;
}

.dropdown-menu {
    position: absolute;
    right: 0;
    top: 100%;
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    z-index: 10;
    min-width: 120px;
}

.dropdown-item {
    display: block;
    width: 100%;
    padding: 8px 12px;
    border: none;
    background: none;
    text-align: left;
    cursor: pointer;
    color: #333;
    font-size: 0.9rem;
}

.dropdown-item i {
    margin-right: 8px;
    width: 12px;
}

.dropdown-item:hover {
    background: #f5f5f5;
}

.dropdown-item.delete {
    color: #d9534f;
    border-top: 1px solid #eee;
}

.dropdown-item.delete:hover {
    background: #f8d7da;
}

/* === Shuttles Tab Specific Styles === */
#shuttles .search-container {
    display: flex;
    align-items: center;
    gap: 10px;
    padding-left: 40px;
    margin-bottom: 1rem;
}

#shuttles .search-container input {
    flex: 1;
    width: 100%;
    min-width: 300px;
    max-width: 1200px; /* Further extended width for better visibility */
}

#shuttles .search-container select {
    padding: 10px;
    border: 1px solid #003A6C;
    border-radius: 6px;
    background: #fff;
    color: #003A6C;
    font-size: 0.9rem;
}

/* === Students Tab Specific Styles === */
#students .search-container {
    display: flex;
    align-items: center;
    gap: 10px;
    padding-left: 40px;
    margin-bottom: 1rem;
}

#students .search-container input {
    flex: 1;
    width: 100%;
    min-width: 300px;
    max-width: 1200px; /* Extended width for better visibility */
}

#students .search-container select {
    padding: 10px;
    border: 1px solid #003A6C;
    border-radius: 6px;
    background: #fff;
    color: #003A6C;
    font-size: 0.9rem;
}

/* === Students Tab Contact Column Icons === */
#students td i.fa-phone,
#students td i.fa-envelope {
    margin-right: 8px;
    width: 16px;
    text-align: center;
}
#students td small {
    color: #666;
    font-size: 0.85rem;
}

/* === Students Table Column Widths === */
#students table th:nth-child(1), #students table td:nth-child(1) { /* Student */
    width: 20%;
    max-width: 200px;
}
#students table th:nth-child(2), #students table td:nth-child(2) { /* Parent/Guardian */
    width: 15%;
    max-width: 150px;
}
#students table th:nth-child(3), #students table td:nth-child(3) { /* Contact */
    width: 25%;
    max-width: 250px;
}
#students table th:nth-child(4), #students table td:nth-child(4) { /* Assigned Shuttle */
    width: 15%;
    max-width: 150px;
}
#students table th:nth-child(5), #students table td:nth-child(5) { /* Status */
    width: 10%;
    max-width: 100px;
}
#students table th:nth-child(6), #students table td:nth-child(6) { /* Check-in Time */
    width: 10%;
    max-width: 100px;
}
#students table th:nth-child(7), #students table td:nth-child(7) { /* Current Location */
    width: 15%;
    max-width: 150px;
}
#students table th:nth-child(8), #students table td:nth-child(8) { /* Actions */
    width: 10%;
    max-width: 100px;
}

/* === Status Badges for Students Tab === */
.badge-checked-in {
    background: #5cb85c; /* Green for Checked in */
}
.badge-checked-out {
    background: #f0ad4e; /* Orange for Checked out */
}
.badge-not-boarded {
    background: #d9534f; /* Red for Not boarded */
}

/* === Notifications Tab Specific Styles === */
#notifications .table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-left: 40px;
    margin-bottom: 1rem;
}

#notifications .table-header h3 {
    margin: 0;
    font-size: 1.2rem;
    color: #003A6C;
}

#notifications .table-header .table-actions {
    display: flex;
    gap: 10px;
}

#notifications .table-header .action-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    background: linear-gradient(135deg, #5cb85c, #4cae4c);
    color: white;
    cursor: pointer;
    font-size: 0.9rem;
}

#notifications .table-header .action-btn:nth-child(2) {
    background: linear-gradient(135deg, #d9534f, #c9302c);
}

#notifications .search-container {
    display: flex;
    align-items: center;
    gap: 10px;
    padding-left: 40px;
    margin-bottom: 1rem;
}

#notifications .search-container input {
    flex: 1;
    width: 100%;
    min-width: 300px;
    max-width: 1200px;
}

#notifications .search-container select {
    padding: 10px;
    border: 1px solid #003A6C;
    border-radius: 6px;
    background: #fff;
    color: #003A6C;
    font-size: 0.9rem;
}

#notifications table th:nth-child(1), #notifications table td:nth-child(1) { /* Notification Message */
    width: 60%;
    max-width: 600px;
}
#notifications table th:nth-child(2), #notifications table td:nth-child(2) { /* Timestamp */
    width: 30%;
    max-width: 300px;
}
#notifications table th:nth-child(3), #notifications table td:nth-child(3) { /* Status */
    width: 10%;
    max-width: 100px;
}

/* === Status Badges for Notifications Tab === */
.badge-unread {
    background: #d9534f; /* Red for Unread */
}
.badge-read {
    background: #5cb85c; /* Green for Read */
}

/* === Live Map Tracking Tab Specific Styles === */
#live-map .table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-left: 40px;
    margin-bottom: 1rem;
}

#live-map .table-header h3 {
    margin: 0;
    font-size: 1.2rem;
    color: #003A6C;
}

#live-map .table-header .table-actions {
    display: flex;
    gap: 10px;
}

#live-map .table-header .action-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    background: linear-gradient(135deg, #5cb85c, #4cae4c);
    color: white;
    cursor: pointer;
    font-size: 0.9rem;
}

#live-map .table-header .action-btn:nth-child(2) {
    background: linear-gradient(135deg, #337ab7, #286090); /* Layers */
}

#live-map .table-header .action-btn:nth-child(3) {
    background: linear-gradient(135deg, #f0ad4e, #ec971f); /* Zoom In */
}

#live-map .table-header .action-btn:nth-child(4) {
    background: linear-gradient(135deg, #f0ad4e, #ec971f); /* Zoom Out */
}

#live-map .table-header .action-btn:nth-child(5) {
    background: linear-gradient(135deg, #d9534f, #c9302c); /* Full Screen */
}

#live-map .map-container {
    padding-left: 40px;
    padding-right: 40px;
}

#live-map .active-shuttles h3 {
    margin: 0;
    font-size: 1.2rem;
    color: #003A6C;
}

#live-map .active-shuttles p {
    margin: 0.5rem 0 1rem 0;
    font-size: 0.9rem;
    color: #003A6C;
}

#live-map .shuttle-item {
    padding: 10px;
    border-bottom: 1px solid #ddd;
}

#live-map .shuttle-item p {
    margin: 0 0 10px 0;
    font-size: 0.9rem;
}

#live-map .shuttle-item .action-btn {
    padding: 6px 10px;
    background: linear-gradient(135deg, #5cb85c, #4cae4c);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
}

/* === Recent Activity List === */
#recent-activity-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

/* === Drivers Tab Specific Styles === */
#drivers .search-container {
    display: flex;
    align-items: center;
    gap: 10px;
    padding-left: 40px;
    margin-bottom: 1rem;
}

#drivers .search-container input {
    flex: 1;
    width: 100%;
    min-width: 300px;
    max-width: 1200px; /* Extended width for better visibility */
}

#drivers .search-container select {
    padding: 10px;
    border: 1px solid #003A6C;
    border-radius: 6px;
    background: #fff;
    color: #003A6C;
    font-size: 0.9rem;
}

/* === Drivers Table Column Widths === */
#drivers table th:nth-child(1), #drivers table td:nth-child(1) { /* Driver */
    width: 15%;
    max-width: 150px;
}
#drivers table th:nth-child(2), #drivers table td:nth-child(2) { /* Operator */
    width: 20%;
    max-width: 200px;
}
#drivers table th:nth-child(3), #drivers table td:nth-child(3) { /* Contact */
    width: 20%;
    max-width: 200px;
}
#drivers table th:nth-child(4), #drivers table td:nth-child(4) { /* License Number */
    width: 15%;
    max-width: 150px;
}
#drivers table th:nth-child(5), #drivers table td:nth-child(5) { /* Emergency Contact */
    width: 15%;
    max-width: 150px;
}
#drivers table th:nth-child(6), #drivers table td:nth-child(6) { /* Status */
    width: 10%;
    max-width: 100px;
}
#drivers table th:nth-child(7), #drivers table td:nth-child(7) { /* Actions */
    width: 10%;
    max-width: 100px;
}

/* === Drivers Tab Contact and Operator Column Icons === */
#drivers td i.fa-phone,
#drivers td i.fa-envelope {
    margin-right: 8px;
    width: 16px;
    text-align: center;
}
#drivers td small {
    color: #666;
    font-size: 0.85rem;
}

#recent-activity-list li {
    padding: 0.75rem 0;
    border-bottom: 1px solid #D1D5DB; /* Medium Gray */
    color: #003A6C; /* Ateneo Blue for main text */
}

#recent-activity-list li:last-child {
    border-bottom: none;
}

/* === Error Text === */
.error-text {
    color: #d9534f;
    font-size: 0.9rem;
    margin: 0.5rem 0;
}

/* === Responsive Adjustments === */
@media (max-width: 768px) {
    .balance-section {
        flex-direction: column;
        align-items: stretch;
        padding: 0 0.5rem;
    }
    .balance-card, .chart-card, .notifications-card {
        flex: none;
        width: 100%;
        max-width: none;
    }
    .chart-card canvas {
        height: 50vw !important;
        max-height: 300px;
    }
    .modal-content, .popup-card {
        width: 90%;
    }
    .profile-section {
        grid-template-columns: 1fr;
        padding: 0 20px;
    }
    .add-form-modal {
        width: 95%;
        padding: 1rem;
    }
    .form-row {
        grid-template-columns: 1fr;
    }
    .table-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    .modal-actions {
        flex-direction: column;
        gap: 0.5rem;
    }
    .dropdown-menu {
        right: -50px;
        min-width: 140px;
    }
    .sidebar {
        left: -100%;
    }
    .content.content-shift {
        margin-left: 0;
    }
}

main :
config :
GlobalExceptionHandler :
package com.example.shuttlemonitor.config;

import com.example.shuttlemonitor.exception.UnauthorizedAccessException;
import io.swagger.v3.oas.annotations.Hidden; // Add this import
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

@Hidden
@ControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(IllegalArgumentException.class)
    public ResponseEntity<Map<String, String>> handleIllegalArgumentException(IllegalArgumentException ex) {
        Map<String, String> errorResponse = new HashMap<>();
        errorResponse.put("error", ex.getMessage());
        return new ResponseEntity<>(errorResponse, HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(IOException.class)
    public ResponseEntity<Map<String, String>> handleIOException(IOException ex) {
        Map<String, String> errorResponse = new HashMap<>();
        errorResponse.put("error", "Failed to upload images: " + ex.getMessage());
        return new ResponseEntity<>(errorResponse, HttpStatus.INTERNAL_SERVER_ERROR);
    }

    @ExceptionHandler(UnauthorizedAccessException.class)
    public ResponseEntity<Map<String, String>> handleUnauthorizedAccessException(UnauthorizedAccessException ex) {
        Map<String, String> errorResponse = new HashMap<>();
        errorResponse.put("error", ex.getMessage());
        return new ResponseEntity<>(errorResponse, HttpStatus.FORBIDDEN);
    }

    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<Map<String, String>> handleAccessDeniedException(AccessDeniedException ex) {
        Map<String, String> errorResponse = new HashMap<>();
        errorResponse.put("error", "Only admins can perform this action");
        return new ResponseEntity<>(errorResponse, HttpStatus.FORBIDDEN);
    }

    @ExceptionHandler(UsernameNotFoundException.class)
    public ResponseEntity<Map<String, String>> handleUsernameNotFoundException(UsernameNotFoundException ex) {
        Map<String, String> errorResponse = new HashMap<>();
        errorResponse.put("error", ex.getMessage());
        return new ResponseEntity<>(errorResponse, HttpStatus.UNAUTHORIZED);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<Map<String, String>> handleGeneralException(Exception ex) {
        Map<String, String> errorResponse = new HashMap<>();
        errorResponse.put("error", "An unexpected error occurred: " + ex.getMessage());
        return new ResponseEntity<>(errorResponse, HttpStatus.INTERNAL_SERVER_ERROR);
    }
}

JwtFilter :
package com.example.shuttlemonitor.config;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;

@Component
public class JwtFilter extends OncePerRequestFilter {

    @Autowired
    private JwtUtil jwtUtil;

    @Autowired
    private UserDetailsService userDetailsService;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        String authorization = request.getHeader("Authorization");
        String token = null;
        String username = null;

        if (null != authorization && authorization.startsWith("Bearer ")) {
            token = authorization.substring(7);
            username = jwtUtil.getUsernameFromToken(token);
        }

        if (null != username && SecurityContextHolder.getContext().getAuthentication() == null) {
            UserDetails userDetails = userDetailsService.loadUserByUsername(username);
            if (jwtUtil.validateToken(token, userDetails)) {
                UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken = new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
                usernamePasswordAuthenticationToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                SecurityContextHolder.getContext().setAuthentication(usernamePasswordAuthenticationToken);
            }
        }

        filterChain.doFilter(request, response);
    }
}

JwtUtil:
package com.example.shuttlemonitor.config;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.security.Keys;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Component;

import javax.crypto.SecretKey;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.function.Function;
import java.util.stream.Collectors;

@Component
public class JwtUtil {
    public static final long JWT_TOKEN_VALIDITY = 5 * 60 * 60 * 1000; // 5 hours
    public static final long JWT_REFRESH_TOKEN_VALIDITY = 7 * 24 * 60 * 60 * 1000; // 7 days

    @Value("${jwt.secret}")
    private String secret;

    private SecretKey getSigningKey() {
        return Keys.hmacShaKeyFor(secret.getBytes());
    }

    public String getUsernameFromToken(String token) {
        return getClaimFromToken(token, Claims::getSubject);
    }

    public Date getExpirationDateFromToken(String token) {
        return getClaimFromToken(token, Claims::getExpiration);
    }

    public <T> T getClaimFromToken(String token, Function<Claims, T> claimsResolver) {
        final Claims claims = getAllClaimsFromToken(token);
        return claimsResolver.apply(claims);
    }

    private Claims getAllClaimsFromToken(String token) {
        return Jwts.parserBuilder()
                .setSigningKey(getSigningKey())
                .build()
                .parseClaimsJws(token)
                .getBody();
    }

    private Boolean isTokenExpired(String token) {
        final Date expiration = getExpirationDateFromToken(token);
        return expiration.before(new Date());
    }

    public String generateToken(UserDetails userDetails) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("roles", userDetails.getAuthorities().stream()
                .map(GrantedAuthority::getAuthority)
                .collect(Collectors.toList()));
        return doGenerateToken(claims, userDetails.getUsername(), JWT_TOKEN_VALIDITY);
    }

    public String generateRefreshToken(UserDetails userDetails) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("roles", userDetails.getAuthorities().stream()
                .map(GrantedAuthority::getAuthority)
                .collect(Collectors.toList()));
        return doGenerateToken(claims, userDetails.getUsername(), JWT_REFRESH_TOKEN_VALIDITY);
    }

    private String doGenerateToken(Map<String, Object> claims, String subject, long validity) {
        return Jwts.builder()
                .setClaims(claims)
                .setSubject(subject)
                .setIssuedAt(new Date(System.currentTimeMillis()))
                .setExpiration(new Date(System.currentTimeMillis() + validity))
                .signWith(getSigningKey())
                .compact();
    }

    public Boolean validateToken(String token, UserDetails userDetails) {
        final String username = getUsernameFromToken(token);
        return username.equals(userDetails.getUsername()) && !isTokenExpired(token);
    }

    public Boolean validateRefreshToken(String token) {
        try {
            getAllClaimsFromToken(token);
            return !isTokenExpired(token);
        } catch (Exception e) {
            return false;
        }
    }
}

SecurityConfig :
package com.example.shuttlemonitor.config;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpStatus;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.HttpStatusEntryPoint;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.cors.CorsConfiguration;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Autowired
    private JwtFilter jwtFilter;

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf(csrf -> csrf.disable())
                .cors(cors -> cors.configurationSource(request -> {
                    CorsConfiguration config = new CorsConfiguration();
                    config.addAllowedOrigin("*");
                    config.addAllowedMethod("*");
                    config.addAllowedHeader("*");
                    return config;
                }))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/api/auth/**", "/api/forgotPassword/**", "/**").permitAll()
                        .requestMatchers("/api/users/{userId}/profile-picture").authenticated()
                        .requestMatchers("/api/students/**", "/api/parents/**", "/api/operators/**", "/api/drivers/**").authenticated()
                        .requestMatchers("/api/admin/bulk-upload/**").hasRole("ADMIN")
                        .requestMatchers("/swagger-ui/**", "/v3/api-docs/**").permitAll()
                        .requestMatchers("/api/check-in/log").permitAll()
                        .requestMatchers("/api/shuttles/**").authenticated()
                        .anyRequest().authenticated())
                .exceptionHandling(handling -> handling
                        .authenticationEntryPoint(new HttpStatusEntryPoint(HttpStatus.UNAUTHORIZED)))
                .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class);
        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration authenticationConfiguration) throws Exception {
        return authenticationConfiguration.getAuthenticationManager();
    }
}

controller :
AuthController :
package com.example.shuttlemonitor.controller;

import com.example.shuttlemonitor.Entity.Driver;
import com.example.shuttlemonitor.Entity.Operator;
import com.example.shuttlemonitor.Entity.Parent;
import com.example.shuttlemonitor.Entity.Role;
import com.example.shuttlemonitor.Entity.Student;
import com.example.shuttlemonitor.Entity.User;
import com.example.shuttlemonitor.Repository.DriverRepository;
import com.example.shuttlemonitor.Repository.OperatorRepository;
import com.example.shuttlemonitor.Repository.ParentRepository;
import com.example.shuttlemonitor.Repository.StudentRepository;
import com.example.shuttlemonitor.Repository.UserRepository;
import com.example.shuttlemonitor.config.JwtUtil;
import com.example.shuttlemonitor.dto.OperatorSignUpDTO;
import com.example.shuttlemonitor.dto.ParentSignUpDTO;
import com.example.shuttlemonitor.dto.UserSignUpDTO;
import com.example.shuttlemonitor.service.LoginService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.web.bind.annotation.*;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/auth")
public class AuthController {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private ParentRepository parentRepository;

    @Autowired
    private StudentRepository studentRepository;

    @Autowired
    private OperatorRepository operatorRepository;

    @Autowired
    private DriverRepository driverRepository;

    @Autowired
    private PasswordEncoder encoder;

    @Autowired
    private LoginService loginService;

    @Autowired
    private JwtUtil jwtUtil;

    @PostMapping("/sign-in")
    public ResponseEntity<?> signIn(@RequestBody Map<String, String> credentials) {
        String usernameOrEmail = credentials.get("usernameOrEmail");
        String password = credentials.get("password");

        Map<String, Object> response = new HashMap<>();
        if (usernameOrEmail == null || usernameOrEmail.isEmpty() || password == null || password.isEmpty()) {
            response.put("error", "Username or email and password are required");
            return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST);
        }

        User user = userRepository.findByUsernameOrEmail(usernameOrEmail, usernameOrEmail)
                .orElse(null);
        if (user == null || !encoder.matches(password, user.getPassword())) {
            response.put("error", "Invalid credentials");
            return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST);
        }

        UserDetails userDetails = loginService.loadUserByUsername(user.getUsername());
        String accessToken = jwtUtil.generateToken(userDetails);
        String refreshToken = jwtUtil.generateRefreshToken(userDetails);
        return ResponseEntity.ok(Map.of(
                "access_token", accessToken,
                "refresh_token", refreshToken,
                "user_id", user.getUserId(),
                "username", user.getUsername(),
                "email", user.getEmail(),
                "status", "success"
        ));
    }

    @PostMapping("/refresh-token")
    public ResponseEntity<?> refreshToken(@RequestBody Map<String, String> tokenRequest) {
        String refreshToken = tokenRequest.get("refresh_token");
        Map<String, Object> response = new HashMap<>();
        if (refreshToken == null || refreshToken.isEmpty()) {
            response.put("error", "Refresh token is required");
            return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST);
        }

        if (jwtUtil.validateRefreshToken(refreshToken)) {
            String username = jwtUtil.getUsernameFromToken(refreshToken);
            User user = userRepository.findByUsername(username);
            if (user != null) {
                UserDetails userDetails = loginService.loadUserByUsername(username);
                String newAccessToken = jwtUtil.generateToken(userDetails);
                return ResponseEntity.ok(Map.of(
                        "access_token", newAccessToken,
                        "refresh_token", refreshToken,
                        "user_id", user.getUserId(),
                        "status", "success"
                ));
            }
        }
        response.put("error", "Invalid refresh token");
        return new ResponseEntity<>(response, HttpStatus.UNAUTHORIZED);
    }

    @PostMapping("/sign-up/parents")
    public ResponseEntity<?> signUpParents(@RequestBody ParentSignUpDTO dto) {
        if (!"PARENT".equals(dto.parent().role())) {
            return ResponseEntity.badRequest().body(Map.of("error", "Invalid role for parent"));
        }
        for (UserSignUpDTO s : dto.students()) {
            if (!"STUDENT".equals(s.role())) {
                return ResponseEntity.badRequest().body(Map.of("error", "Invalid role for student"));
            }
        }

        if (userRepository.findByUsernameOrEmail(dto.parent().username(), dto.parent().email()).isPresent()) {
            return ResponseEntity.status(HttpStatus.CONFLICT).body(Map.of("error", "Parent username or email already exists"));
        }

        User parentUser = new User();
        parentUser.setUsername(dto.parent().username());
        parentUser.setEmail(dto.parent().email());
        parentUser.setPassword(encoder.encode(dto.parent().password()));
        parentUser.setRole(Role.valueOf(dto.parent().role()));
        userRepository.save(parentUser);

        Parent parent = new Parent();
        parent.setUser(parentUser);
        parent.setCurrentAddress(dto.parent().currentAddress());
        parent.setFullName(dto.parent().fullName());
        parent.setContactPhone(dto.parent().contactPhone());
        parentRepository.save(parent);

        List<Student> students = new ArrayList<>();
        for (UserSignUpDTO sd : dto.students()) {
            if (userRepository.findByUsernameOrEmail(sd.username(), sd.email()).isPresent()) {
                return ResponseEntity.status(HttpStatus.CONFLICT).body(Map.of("error", "Student username or email already exists"));
            }
            User studentUser = new User();
            studentUser.setUsername(sd.username());
            studentUser.setEmail(sd.email());
            studentUser.setPassword(encoder.encode(sd.password()));
            studentUser.setRole(Role.valueOf(sd.role()));
            userRepository.save(studentUser);

            Student student = new Student();
            student.setUser(studentUser);
            student.setCurrentAddress(sd.currentAddress());
            student.setFullName(sd.fullName());
            student.setContactPhone(sd.contactPhone());
            student.setGrade(sd.grade());
            student.setSection(sd.section());
            student.setParent(parent);
            studentRepository.save(student);
            students.add(student);
        }

        Map<String, Object> resp = new HashMap<>();
        resp.put("parent", parent);
        resp.put("students", students);
        return ResponseEntity.ok(resp);
    }

    @PostMapping("/sign-up/operators")
    public ResponseEntity<?> signUpOperators(@RequestBody OperatorSignUpDTO dto) {
        if (!"OPERATOR".equals(dto.operator().role())) {
            return ResponseEntity.badRequest().body(Map.of("error", "Invalid role for operator"));
        }
        for (UserSignUpDTO d : dto.drivers()) {
            if (!"DRIVER".equals(d.role())) {
                return ResponseEntity.badRequest().body(Map.of("error", "Invalid role for driver"));
            }
        }

        if (userRepository.findByUsernameOrEmail(dto.operator().username(), dto.operator().email()).isPresent()) {
            return ResponseEntity.status(HttpStatus.CONFLICT).body(Map.of("error", "Operator username or email already exists"));
        }

        User operatorUser = new User();
        operatorUser.setUsername(dto.operator().username());
        operatorUser.setEmail(dto.operator().email());
        operatorUser.setPassword(encoder.encode(dto.operator().password()));
        operatorUser.setRole(Role.valueOf(dto.operator().role()));
        userRepository.save(operatorUser);

        Operator operator = new Operator();
        operator.setUser(operatorUser);
        operator.setFullName(dto.operator().fullName());
        operator.setContactPhone(dto.operator().contactPhone());
        operatorRepository.save(operator);

        List<Driver> drivers = new ArrayList<>();
        for (UserSignUpDTO dd : dto.drivers()) {
            if (userRepository.findByUsernameOrEmail(dd.username(), dd.email()).isPresent()) {
                return ResponseEntity.status(HttpStatus.CONFLICT).body(Map.of("error", "Driver username or email already exists"));
            }
            User driverUser = new User();
            driverUser.setUsername(dd.username());
            driverUser.setEmail(dd.email());
            driverUser.setPassword(encoder.encode(dd.password()));
            driverUser.setRole(Role.valueOf(dd.role()));
            userRepository.save(driverUser);

            Driver driver = new Driver();
            driver.setUser(driverUser);
            driver.setLicenseNumber(dd.licenseNumber());
            driver.setContactPhone(dd.contactPhone());
            driver.setEmergencyContact(dd.emergencyContact());
            driver.setOperator(operator);
            driverRepository.save(driver);
            drivers.add(driver);
        }

        Map<String, Object> resp = new HashMap<>();
        resp.put("operator", operator);
        resp.put("drivers", drivers);
        return ResponseEntity.ok(resp);
    }

    @PostMapping("/sign-up/students")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<?> setupStudent(@RequestBody Map<String, Object> req) {
        Long studentId = Long.parseLong(req.get("studentId").toString());
        String rfidTag = (String) req.get("rfidTag");
        String fingerprintHash = (String) req.get("fingerprintHash");

        Student student = studentRepository.findById(studentId)
                .orElseThrow(() -> new IllegalArgumentException("Student not found"));

        if (student.getUser().getRole() != Role.STUDENT) {
            throw new IllegalArgumentException("Not a student");
        }

        student.setRfidTag(rfidTag);
        student.setFingerprintHash(fingerprintHash);
        studentRepository.save(student);

        return ResponseEntity.ok(student);
    }
}

BulkUploadController :
package com.example.shuttlemonitor.controller;

import com.example.shuttlemonitor.service.BulkUploadService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.util.Map;

@RestController
@RequestMapping("/api/admin/bulk-upload")
public class BulkUploadController {

    @Autowired
    private BulkUploadService bulkUploadService;

    @PostMapping("/parents-students")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<Map<String, Object>> uploadBulkParentsStudents(@RequestParam("file") MultipartFile file) {
        if (file.isEmpty()) {
            return ResponseEntity.badRequest().body(Map.of("error", "File is required"));
        }
        if (!file.getContentType().startsWith("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet") &&
                !file.getContentType().startsWith("application/vnd.ms-excel")) {
            return ResponseEntity.badRequest().body(Map.of("error", "Only Excel files are allowed"));
        }

        try {
            Map<String, Object> result = bulkUploadService.processBulkParentsStudents(file);
            return ResponseEntity.ok(result);
        } catch (IOException e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of("error", "Failed to process file: " + e.getMessage()));
        }
    }

    @PostMapping("/operators-drivers")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<Map<String, Object>> uploadBulkOperatorsDrivers(@RequestParam("file") MultipartFile file) {
        if (file.isEmpty()) {
            return ResponseEntity.badRequest().body(Map.of("error", "File is required"));
        }
        if (!file.getContentType().startsWith("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet") &&
                !file.getContentType().startsWith("application/vnd.ms-excel")) {
            return ResponseEntity.badRequest().body(Map.of("error", "Only Excel files are allowed"));
        }

        try {
            Map<String, Object> result = bulkUploadService.processBulkOperatorsDrivers(file);
            return ResponseEntity.ok(result);
        } catch (IOException e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of("error", "Failed to process file: " + e.getMessage()));
        }
    }
}

CheckInController :
package com.example.shuttlemonitor.controller;

import com.example.shuttlemonitor.Entity.CheckIn;
import com.example.shuttlemonitor.Entity.Student;
import com.example.shuttlemonitor.service.CheckInService;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;

@SecurityRequirement(name = "bearerAuth") // For Swagger JWT
@RestController
@RequestMapping("/api/check-in")
public class CheckInController {

    @Autowired
    private CheckInService checkInService;

    @PostMapping("/register-device/{studentId}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<Map<String, Object>> registerDevice(@PathVariable Long studentId,
                                                              @RequestBody Map<String, String> deviceData) {
        String rfidTag = deviceData.get("rfidTag");
        String fingerprintHash = deviceData.get("fingerprintHash");
        if (rfidTag == null || fingerprintHash == null) {
            Map<String, Object> errorResponse = new HashMap<>();
            errorResponse.put("error", "RFID tag and fingerprint hash required");
            return ResponseEntity.badRequest().body(errorResponse);
        }

        checkInService.registerDevice(studentId, rfidTag, fingerprintHash);

        // Fetch updated student for detailed response
        Student student = checkInService.getStudentById(studentId); // Add this method to CheckInService if needed

        Map<String, Object> response = new HashMap<>();
        response.put("message", "Device registered successfully");
        response.put("studentId", studentId);
        response.put("studentUsername", student.getUser().getUsername());
        response.put("rfidTag", rfidTag);
        response.put("fingerprintHash", fingerprintHash);
        response.put("timestamp", java.time.LocalDateTime.now().toString());

        return ResponseEntity.ok(response);
    }

    @PostMapping("/log")
    public ResponseEntity<Map<String, Object>> logCheckIn(@RequestBody Map<String, Object> request) {
        Long studentId = Long.parseLong(request.get("studentId").toString());
        Long shuttleId = Long.parseLong(request.get("shuttleId").toString());
        String rfidTag = (String) request.get("rfidTag");
        String fingerprintHash = (String) request.get("fingerprintHash");
        String type = (String) request.get("type"); // "in" or "out"

        CheckIn checkIn = checkInService.logCheckIn(studentId, shuttleId, rfidTag, fingerprintHash, type);

        Map<String, Object> response = new HashMap<>();
        response.put("message", checkIn.getStatus().equals("success") ? "Check-in successful" : "Check-in failed (invalid credentials)");
        response.put("checkInId", checkIn.getCheckInId());
        response.put("studentId", studentId);
        response.put("shuttleId", shuttleId);
        response.put("type", type);
        response.put("status", checkIn.getStatus());
        response.put("timestamp", checkIn.getTimestamp().toString());

        return ResponseEntity.ok(response);
    }
}
DriverController :
package com.example.shuttlemonitor.controller;

import com.example.shuttlemonitor.Entity.Driver;
import com.example.shuttlemonitor.Entity.Role;
import com.example.shuttlemonitor.Repository.DriverRepository;
import com.example.shuttlemonitor.Repository.UserRepository;
import com.example.shuttlemonitor.exception.UnauthorizedAccessException;
import com.example.shuttlemonitor.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Sort;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/drivers")
public class DriverController {

    @Autowired
    private DriverRepository driverRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private UserService userService;

    @GetMapping("/{id}")
    public ResponseEntity<Driver> getDriver(@PathVariable Long id) {
        Driver driver = driverRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Driver not found"));
        userService.checkAccessForDriver(driver);
        return ResponseEntity.ok(driver);
    }

    @GetMapping("/all")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<List<Driver>> getAllDrivers(
            @RequestParam(defaultValue = "driverId") String sortBy,
            @RequestParam(defaultValue = "desc") String sortOrder) {
        Sort sort = Sort.by(sortOrder.equalsIgnoreCase("asc") ? Sort.Direction.ASC : Sort.Direction.DESC, sortBy);
        List<Driver> drivers = driverRepository.findAll(sort);
        return ResponseEntity.ok(drivers);
    }

    @PutMapping("/{id}")
    @PreAuthorize("@userService.isOwnerOrAdminOrOperatorForDriver(#id)")
    public ResponseEntity<Driver> updateDriver(@PathVariable Long id, @RequestBody Driver updatedDriver) {
        Driver driver = driverRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Driver not found"));
        // Update fields as needed
        driver.setContactPhone(updatedDriver.getContactPhone());
        driver.setLicenseNumber(updatedDriver.getLicenseNumber());
        driver.setEmergencyContact(updatedDriver.getEmergencyContact());
        // etc.
        driverRepository.save(driver);
        return ResponseEntity.ok(driver);
    }

    @DeleteMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    @Transactional
    public ResponseEntity<?> deleteDriver(@PathVariable Long id) {
        Driver driver = driverRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Driver not found"));
        driverRepository.delete(driver);
        userRepository.delete(driver.getUser());
        return ResponseEntity.ok(Map.of("message", "Driver deleted successfully"));
    }
}

ForgotPasswordController :
package com.example.shuttlemonitor.controller;

import com.example.shuttlemonitor.Entity.ForgotPassword;
import com.example.shuttlemonitor.Entity.User;
import com.example.shuttlemonitor.Repository.ForgotPasswordRepository;
import com.example.shuttlemonitor.Repository.UserRepository;
import com.example.shuttlemonitor.dto.MailBody;
import com.example.shuttlemonitor.service.EmailService;
import com.example.shuttlemonitor.util.ChangePassword;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.*;

import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.Random;

@RestController
@RequestMapping("/api/forgotPassword")
@CrossOrigin(origins = "*")
public class ForgotPasswordController {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private EmailService emailService;

    @Autowired
    private ForgotPasswordRepository forgotPasswordRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @Value("${otp.expiration.minutes:20}")
    private int otpExpirationMinutes;

    @PostMapping("/verifyMail")
    @Transactional
    public ResponseEntity<Map<String, String>> verifyEmail(@RequestBody Map<String, String> request) {
        Map<String, String> response = new HashMap<>();
        String email = request.get("email");
        if (email == null || email.isEmpty()) {
            response.put("status", "error");
            response.put("message", "Email is required");
            return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST);
        }

        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> {
                    response.put("status", "error");
                    response.put("message", "Email not found");
                    return new UsernameNotFoundException("Email not found");
                });

        forgotPasswordRepository.deleteByUser(user);
        int otp = otpGenerator();
        MailBody mailBody = MailBody.builder()
                .to(email)
                .text("Your OTP for password reset is: " + otp + ". Valid for " + otpExpirationMinutes + " minutes.")
                .subject("Password Reset OTP")
                .build();

        ForgotPassword fp = ForgotPassword.builder()
                .otp(otp)
                .expirationTime(new Date(System.currentTimeMillis() + otpExpirationMinutes * 60 * 1000))
                .user(user)
                .build();

        try {
            emailService.sendSimpleMessage(mailBody);
            forgotPasswordRepository.save(fp);
            response.put("status", "success");
            response.put("message", "OTP sent to your email for verification");
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            forgotPasswordRepository.deleteByUser(user);
            response.put("status", "error");
            response.put("message", "Failed to send OTP");
            return new ResponseEntity<>(response, HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }

    @PostMapping("/verifyOtp")
    public ResponseEntity<Map<String, String>> verifyOtp(@RequestBody Map<String, Object> request) {
        Map<String, String> response = new HashMap<>();
        String email = (String) request.get("email");
        Integer otp = Integer.parseInt(request.get("otp").toString());

        ForgotPassword fp = validateOtp(email, otp);
        if (fp == null) {
            response.put("status", "error");
            response.put("message", "Invalid or expired OTP");
            return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST);
        }

        response.put("status", "success");
        response.put("message", "OTP verified successfully");
        return ResponseEntity.ok(response);
    }

    @PostMapping("/changePassword")
    @Transactional
    public ResponseEntity<Map<String, String>> changePassword(@RequestBody Map<String, Object> request) {
        Map<String, String> response = new HashMap<>();
        String email = (String) request.get("email");
        Integer otp = Integer.parseInt(request.get("otp").toString());
        String password = (String) request.get("password");
        String repeatPassword = (String) request.get("repeatPassword");

        ForgotPassword fp = validateOtp(email, otp);
        if (fp == null) {
            response.put("status", "error");
            response.put("message", "Invalid or expired OTP");
            return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST);
        }

        if (!password.equals(repeatPassword)) {
            response.put("status", "error");
            response.put("message", "Passwords do not match");
            return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST);
        }

        String encodedPassword = passwordEncoder.encode(password);
        userRepository.updatePassword(email, encodedPassword);
        forgotPasswordRepository.deleteById(fp.getForgotPasswordId());

        response.put("status", "success");
        response.put("message", "Password changed successfully");
        return ResponseEntity.ok(response);
    }

    private ForgotPassword validateOtp(String email, Integer otp) {
        User user = userRepository.findByEmail(email)
                .orElse(null);
        if (user == null) {
            return null;
        }

        ForgotPassword fp = forgotPasswordRepository.findByOtpAndUser(otp, user)
                .orElse(null);
        if (fp == null || fp.getExpirationTime().before(new Date())) {
            if (fp != null) {
                forgotPasswordRepository.deleteById(fp.getForgotPasswordId());
            }
            return null;
        }
        return fp;
    }

    private Integer otpGenerator() {
        Random random = new Random();
        return random.nextInt(100_000, 999_999);
    }

    @PostMapping("/reset-password")
    @Transactional
    public ResponseEntity<Map<String, String>> resetPassword(@RequestBody ChangePassword changePassword,
                                                             @RequestParam("email") String email) {
        Map<String, String> response = new HashMap<>();
        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> {
                    response.put("error", "Invalid email: " + email);
                    return new UsernameNotFoundException("Invalid email");
                });

        String currentUsername = getCurrentUsername();
        User currentUser = userRepository.findByUsername(currentUsername);
        if (currentUser == null) {
            response.put("error", "Current user not authenticated");
            return new ResponseEntity<>(response, HttpStatus.UNAUTHORIZED);
        }

        boolean isAdmin = SecurityContextHolder.getContext().getAuthentication().getAuthorities()
                .stream().anyMatch(auth -> auth.getAuthority().equals("ROLE_ADMIN"));

        if (!isAdmin) {
            // Non-admin can only reset their own password
            if (!currentUser.getEmail().equals(email)) {
                response.put("error", "Unauthorized: You can only reset your own password");
                return new ResponseEntity<>(response, HttpStatus.FORBIDDEN);
            }
            if (changePassword.currentPassword() == null) {
                response.put("error", "Current password is required");
                return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST);
            }
            if (!passwordEncoder.matches(changePassword.currentPassword(), currentUser.getPassword())) {
                response.put("error", "Current password is incorrect");
                return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST);
            }
        } else {
            // Admin can reset any password without currentPassword
            if (changePassword.currentPassword() != null && !passwordEncoder.matches(changePassword.currentPassword(), currentUser.getPassword())) {
                response.put("error", "Admin provided incorrect current password (optional for admins)");
                return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST);
            }
        }

        if (!changePassword.newPassword().equals(changePassword.repeatPassword())) {
            response.put("error", "Passwords do not match");
            return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST);
        }

        String encodedPassword = passwordEncoder.encode(changePassword.newPassword());
        userRepository.updatePassword(email, encodedPassword);
        response.put("message", "Password reset successfully!");
        return ResponseEntity.ok(response);
    }

    private String getCurrentUsername() {
        Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        if (principal instanceof UserDetails) {
            return ((UserDetails) principal).getUsername();
        }
        throw new IllegalStateException("User not authenticated");
    }
}

OperatorController :
package com.example.shuttlemonitor.controller;

import com.example.shuttlemonitor.Entity.Operator;
import com.example.shuttlemonitor.Repository.OperatorRepository;
import com.example.shuttlemonitor.Repository.UserRepository;
import com.example.shuttlemonitor.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Sort;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/operators")
public class OperatorController {

    @Autowired
    private OperatorRepository operatorRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private UserService userService;

    @GetMapping("/{id}")
    public ResponseEntity<Operator> getOperator(@PathVariable Long id) {
        Operator operator = operatorRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Operator not found"));
        userService.checkAccessForOperator(operator);
        return ResponseEntity.ok(operator);
    }

    @GetMapping("/all")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<List<Operator>> getAllOperators(
            @RequestParam(defaultValue = "operatorId") String sortBy,
            @RequestParam(defaultValue = "desc") String sortOrder) {
        Sort sort = Sort.by(sortOrder.equalsIgnoreCase("asc") ? Sort.Direction.ASC : Sort.Direction.DESC, sortBy);
        List<Operator> operators = operatorRepository.findAll(sort);
        return ResponseEntity.ok(operators);
    }

    @PutMapping("/{id}")
    @PreAuthorize("@userService.isOwnerOrAdminForOperator(#id)")
    public ResponseEntity<Operator> updateOperator(@PathVariable Long id, @RequestBody Operator updatedOperator) {
        Operator operator = operatorRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Operator not found"));
        // Update fields
        operator.setFullName(updatedOperator.getFullName());
        operator.setContactPhone(updatedOperator.getContactPhone());
        // etc.
        operatorRepository.save(operator);
        return ResponseEntity.ok(operator);
    }

    @DeleteMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    @Transactional
    public ResponseEntity<?> deleteOperator(@PathVariable Long id) {
        Operator operator = operatorRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Operator not found"));
        operatorRepository.delete(operator);
        userRepository.delete(operator.getUser());
        return ResponseEntity.ok(Map.of("message", "Operator deleted successfully"));
    }
}
ParentController :
package com.example.shuttlemonitor.controller;

import com.example.shuttlemonitor.Entity.Parent;
import com.example.shuttlemonitor.Repository.ParentRepository;
import com.example.shuttlemonitor.Repository.UserRepository;
import com.example.shuttlemonitor.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Sort;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/parents")
public class ParentController {

    @Autowired
    private ParentRepository parentRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private UserService userService;

    @GetMapping("/{id}")
    public ResponseEntity<Parent> getParent(@PathVariable Long id) {
        Parent parent = parentRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Parent not found"));
        userService.checkAccessForParent(parent);
        return ResponseEntity.ok(parent);
    }

    @GetMapping("/all")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<List<Parent>> getAllParents(
            @RequestParam(defaultValue = "parentId") String sortBy,
            @RequestParam(defaultValue = "desc") String sortOrder) {
        Sort sort = Sort.by(sortOrder.equalsIgnoreCase("asc") ? Sort.Direction.ASC : Sort.Direction.DESC, sortBy);
        List<Parent> parents = parentRepository.findAll(sort);
        return ResponseEntity.ok(parents);
    }

    @PutMapping("/{id}")
    @PreAuthorize("@userService.isOwnerOrAdminForParent(#id)")
    public ResponseEntity<Parent> updateParent(@PathVariable Long id, @RequestBody Parent updatedParent) {
        Parent parent = parentRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Parent not found"));
        // Update fields
        parent.setCurrentAddress(updatedParent.getCurrentAddress());
        parent.setFullName(updatedParent.getFullName());
        parent.setContactPhone(updatedParent.getContactPhone());
        // etc.
        parentRepository.save(parent);
        return ResponseEntity.ok(parent);
    }

    @DeleteMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    @Transactional
    public ResponseEntity<?> deleteParent(@PathVariable Long id) {
        Parent parent = parentRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Parent not found"));
        parentRepository.delete(parent);
        userRepository.delete(parent.getUser());
        return ResponseEntity.ok(Map.of("message", "Parent deleted successfully"));
    }
}

ShuttleController:
package com.example.shuttlemonitor.controller;

import com.example.shuttlemonitor.Entity.Driver;
import com.example.shuttlemonitor.Entity.Operator;
import com.example.shuttlemonitor.Entity.Shuttle;
import com.example.shuttlemonitor.Entity.Status;
import com.example.shuttlemonitor.Repository.DriverRepository;
import com.example.shuttlemonitor.Repository.OperatorRepository;
import com.example.shuttlemonitor.Repository.ShuttleRepository;
import com.example.shuttlemonitor.service.ShuttleService;
import com.example.shuttlemonitor.service.UserService;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Sort;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@SecurityRequirement(name = "bearerAuth")
@RestController
@RequestMapping("/api/shuttles")
public class ShuttleController {

    @Autowired
    private ShuttleRepository shuttleRepository;

    @Autowired
    private DriverRepository driverRepository;

    @Autowired
    private OperatorRepository operatorRepository;

    @Autowired
    private UserService userService;

    @Autowired
    private ShuttleService shuttleService;

    @PostMapping
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<Map<String, Object>> createShuttle(@RequestBody Map<String, Object> request) {
        Long driverId = Long.parseLong(request.get("driverId").toString());
        Long operatorId = Long.parseLong(request.get("operatorId").toString());
        String route = (String) request.get("route");
        String name = (String) request.get("name");
        Integer maxCapacity = request.get("maxCapacity") != null ? Integer.parseInt(request.get("maxCapacity").toString()) : 50;

        if (route == null || route.trim().isEmpty()) {
            Map<String, Object> errorResponse = new HashMap<>();
            errorResponse.put("error", "Route is required");
            return ResponseEntity.badRequest().body(errorResponse);
        }

        Driver driver = driverRepository.findById(driverId)
                .orElseThrow(() -> new IllegalArgumentException("Driver not found"));
        userService.checkAccessForDriver(driver);

        Operator operator = operatorRepository.findById(operatorId)
                .orElseThrow(() -> new IllegalArgumentException("Operator not found"));
        userService.checkAccessForOperator(operator);

        Shuttle shuttle = new Shuttle();
        shuttle.setName(name != null ? name : "Shuttle " + route);
        shuttle.setMaxCapacity(maxCapacity);
        shuttle.setDriver(driver);
        shuttle.setOperator(operator);
        shuttle.setRoute(route);
        shuttle = shuttleRepository.save(shuttle);

        Map<String, Object> response = new HashMap<>();
        response.put("message", "Shuttle created successfully");
        response.put("shuttleId", shuttle.getShuttleId());
        response.put("name", shuttle.getName());
        response.put("route", shuttle.getRoute());
        response.put("status", shuttle.getStatus());
        response.put("maxCapacity", shuttle.getMaxCapacity());
        response.put("occupancy", shuttleService.calculateOccupancy(shuttle));
        response.put("nextStop", shuttleService.getNextStop(shuttle));
        response.put("eta", shuttleService.getETA(shuttle));
        response.put("driverId", driverId);
        response.put("operatorId", operatorId);
        response.put("createdAt", shuttle.getCreatedAt().toString());

        return ResponseEntity.ok(response);
    }

    @GetMapping("/{id}")
    public ResponseEntity<Map<String, Object>> getShuttle(@PathVariable Long id) {
        Shuttle shuttle = shuttleRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Shuttle not found"));

        Map<String, Object> response = new HashMap<>();
        response.put("shuttleId", shuttle.getShuttleId());
        response.put("name", shuttle.getName());
        response.put("status", shuttle.getStatus());
        response.put("maxCapacity", shuttle.getMaxCapacity() != null ? shuttle.getMaxCapacity() : 50);  // Fix: Fallback in response
        response.put("occupancy", shuttleService.calculateOccupancy(shuttle));
        response.put("nextStop", shuttleService.getNextStop(shuttle));
        response.put("eta", shuttleService.getETA(shuttle));
        response.put("route", shuttle.getRoute());
        response.put("driver", Map.of(
                "driverId", shuttle.getDriver().getDriverId(),
                "username", shuttle.getDriver().getUser().getUsername()
        ));
        response.put("operator", Map.of(
                "operatorId", shuttle.getOperator().getOperatorId(),
                "username", shuttle.getOperator().getUser().getUsername()
        ));
        response.put("createdAt", shuttle.getCreatedAt().toString());

        return ResponseEntity.ok(response);
    }

    @GetMapping("/all")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<List<Shuttle>> getAllShuttles(
            @RequestParam(defaultValue = "shuttleId") String sortBy,
            @RequestParam(defaultValue = "desc") String sortOrder) {
        Sort sort = Sort.by(sortOrder.equalsIgnoreCase("asc") ? Sort.Direction.ASC : Sort.Direction.DESC, sortBy);
        List<Shuttle> shuttles = shuttleRepository.findAll(sort);
        return ResponseEntity.ok(shuttles);
    }

    @PutMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN') OR hasRole('DRIVER') OR hasRole('OPERATOR')")
    public ResponseEntity<Map<String, Object>> updateShuttle(@PathVariable Long id, @RequestBody Map<String, Object> request) {
        Shuttle shuttle = shuttleRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Shuttle not found"));

        // Editable fields: status, maxCapacity (by DRIVER/OPERATOR/ADMIN)
        if (request.containsKey("status")) {
            shuttle.setStatus(Status.valueOf((String) request.get("status")));
        }
        if (request.containsKey("maxCapacity")) {
            shuttle.setMaxCapacity(Integer.parseInt(request.get("maxCapacity").toString()));
        }

        // Route/driver/operator updates (admin-only, but since PreAuthorize allows, add check if needed)
        if (request.containsKey("route")) {
            shuttle.setRoute((String) request.get("route"));
        }
        if (request.containsKey("driverId")) {
            Long driverId = Long.parseLong(request.get("driverId").toString());
            Driver driver = driverRepository.findById(driverId)
                    .orElseThrow(() -> new IllegalArgumentException("Driver not found"));
            shuttle.setDriver(driver);
        }
        if (request.containsKey("operatorId")) {
            Long operatorId = Long.parseLong(request.get("operatorId").toString());
            Operator operator = operatorRepository.findById(operatorId)
                    .orElseThrow(() -> new IllegalArgumentException("Operator not found"));
            shuttle.setOperator(operator);
        }

        shuttle = shuttleRepository.save(shuttle);

        Map<String, Object> response = new HashMap<>();
        response.put("message", "Shuttle updated successfully");
        response.put("shuttleId", shuttle.getShuttleId());
        response.put("name", shuttle.getName());
        response.put("status", shuttle.getStatus());
        response.put("maxCapacity", shuttle.getMaxCapacity() != null ? shuttle.getMaxCapacity() : 50);  // Fix: Fallback in response
        response.put("occupancy", shuttleService.calculateOccupancy(shuttle));
        response.put("nextStop", shuttleService.getNextStop(shuttle));
        response.put("eta", shuttleService.getETA(shuttle));
        response.put("route", shuttle.getRoute());

        return ResponseEntity.ok(response);
    }

    @DeleteMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<Map<String, Object>> deleteShuttle(@PathVariable Long id) {
        shuttleService.deleteShuttle(id);

        Map<String, Object> response = new HashMap<>();
        response.put("message", "Shuttle deleted successfully");
        response.put("shuttleId", id);

        return ResponseEntity.ok(response);
    }
}

StudentController :
package com.example.shuttlemonitor.controller;

import com.example.shuttlemonitor.Entity.Shuttle;
import com.example.shuttlemonitor.Entity.Student;
import com.example.shuttlemonitor.Repository.StudentRepository;
import com.example.shuttlemonitor.Repository.UserRepository;
import com.example.shuttlemonitor.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Sort;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/students")
public class StudentController {

    @Autowired
    private StudentRepository studentRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private UserService userService;

    @GetMapping("/{id}")
    public ResponseEntity<Student> getStudent(@PathVariable Long id) {
        Student student = studentRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Student not found"));
        userService.checkAccessForStudent(student);
        return ResponseEntity.ok(student);
    }

    @GetMapping("/rfid/{rfid}")
    public ResponseEntity<Student> getStudentByRfid(@PathVariable String rfid) {
        Student student = studentRepository.findByRfidTag(rfid)
                .orElseThrow(() -> new IllegalArgumentException("Student not found by RFID"));
        userService.checkAccessForStudent(student);
        return ResponseEntity.ok(student);
    }

    @GetMapping("/all")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<List<Student>> getAllStudents(
            @RequestParam(defaultValue = "studentId") String sortBy,
            @RequestParam(defaultValue = "desc") String sortOrder) {
        Sort sort = Sort.by(sortOrder.equalsIgnoreCase("asc") ? Sort.Direction.ASC : Sort.Direction.DESC, sortBy);
        List<Student> students = studentRepository.findAll(sort);
        return ResponseEntity.ok(students);
    }

    // New: Assign or update shuttle for student (admin-only)
    @PutMapping("/{studentId}/assigned-shuttle")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<Map<String, Object>> assignShuttle(@PathVariable Long studentId, @RequestBody Map<String, Long> request) {
        Long shuttleId = request.get("shuttleId");
        if (shuttleId == null) {
            Map<String, Object> errorResponse = Map.of("error", "Shuttle ID is required");
            return ResponseEntity.badRequest().body(errorResponse);
        }

        Student updatedStudent = userService.assignShuttleToStudent(studentId, shuttleId);

        Map<String, Object> response = Map.of(
                "message", "Shuttle assigned successfully",
                "studentId", studentId,
                "assignedShuttleId", updatedStudent.getAssignedShuttle() != null ? updatedStudent.getAssignedShuttle().getShuttleId() : null,
                "route", updatedStudent.getAssignedShuttle() != null ? updatedStudent.getAssignedShuttle().getRoute() : null
        );
        return ResponseEntity.ok(response);
    }

    // New: Get assigned shuttle for student (admin, student, or parent)
    @GetMapping("/{studentId}/assigned-shuttle")
    public ResponseEntity<Map<String, Object>> getAssignedShuttle(@PathVariable Long studentId) {
        Student student = studentRepository.findById(studentId)
                .orElseThrow(() -> new IllegalArgumentException("Student not found"));
        userService.checkAccessForStudent(student);

        Map<String, Object> response = new HashMap<>();
        response.put("studentId", studentId);
        if (student.getAssignedShuttle() != null) {
            Shuttle shuttle = student.getAssignedShuttle();
            response.put("assignedShuttleId", shuttle.getShuttleId());
            response.put("route", shuttle.getRoute());
            response.put("driverId", shuttle.getDriver() != null ? shuttle.getDriver().getDriverId() : null);
            response.put("operatorId", shuttle.getOperator() != null ? shuttle.getOperator().getOperatorId() : null);
        } else {
            response.put("message", "No shuttle assigned");
        }
        return ResponseEntity.ok(response);
    }

    @PutMapping("/{id}")
    @PreAuthorize("@userService.isOwnerOrAdminOrParentForStudent(#id)")
    public ResponseEntity<Student> updateStudent(@PathVariable Long id, @RequestBody Student updatedStudent) {
        Student student = studentRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Student not found"));
        // Update fields
        student.setCurrentAddress(updatedStudent.getCurrentAddress());
        student.setFullName(updatedStudent.getFullName());
        student.setContactPhone(updatedStudent.getContactPhone());
        student.setGrade(updatedStudent.getGrade());
        student.setSection(updatedStudent.getSection());
        // etc.
        studentRepository.save(student);
        return ResponseEntity.ok(student);
    }

    @DeleteMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<?> deleteStudent(@PathVariable Long id) {
        Student student = studentRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Student not found"));
        userRepository.delete(student.getUser());
        studentRepository.delete(student);
        return ResponseEntity.ok(Map.of("message", "Student deleted successfully"));
    }
}

UserController :
package com.example.shuttlemonitor.controller;

import com.example.shuttlemonitor.Entity.User;
import com.example.shuttlemonitor.Repository.UserRepository;
import com.example.shuttlemonitor.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.io.FileSystemResource;
import org.springframework.core.io.Resource;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import javax.imageio.ImageIO;
import java.awt.image.BufferedImage;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

@RestController
@RequestMapping("/api/users")
@CrossOrigin(origins = "*")
public class UserController {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private UserService userService;

    @GetMapping("/{userId}")
    public ResponseEntity<?> getUserWithDetails(@PathVariable Long userId) {
        Map<String, String> response = new HashMap<>();
        ResponseEntity<User> result = userService.getUserWithDetails(userId);
        if (result.getStatusCode() == HttpStatus.OK) {
            return ResponseEntity.ok(result.getBody());
        } else {
            response.put("error", "User not found");
            return new ResponseEntity<>(response, HttpStatus.NOT_FOUND);
        }
    }

    @GetMapping("/all")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<List<User>> getAllUsers(
            @RequestParam(defaultValue = "createdAt") String sortBy,
            @RequestParam(defaultValue = "desc") String sortOrder) {
        List<User> users = userService.getAllUsers(sortBy, sortOrder);
        return ResponseEntity.ok(users);
    }

    @PostMapping("/{userId}/profile-picture")
    public ResponseEntity<Map<String, String>> uploadProfilePicture(
            @PathVariable Long userId,
            @RequestParam("file") MultipartFile file) {
        Map<String, String> response = new HashMap<>();
        try {
            User user = userRepository.findById(userId)
                    .orElseThrow(() -> new IllegalArgumentException("User not found"));

            if (file.isEmpty()) {
                response.put("error", "Image file is required");
                return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST);
            }

            String contentType = file.getContentType();
            if (contentType == null || !contentType.startsWith("image/")) {
                response.put("error", "Only image files are allowed");
                return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST);
            }

            BufferedImage image = ImageIO.read(file.getInputStream());
            if (image == null) {
                response.put("error", "Invalid image file");
                return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST);
            }

            String uploadDir = "Uploads/profile-pictures/";
            Path uploadPath = Paths.get(uploadDir);
            if (!Files.exists(uploadPath)) {
                Files.createDirectories(uploadPath);
            }

            String fileName = UUID.randomUUID() + ".jpg";
            Path filePath = uploadPath.resolve(fileName);

            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            ImageIO.write(image, "jpg", baos);
            Files.write(filePath, baos.toByteArray());

            user.setProfilePicturePath(uploadDir + fileName);
            userRepository.save(user);

            response.put("message", "Profile picture uploaded successfully");
            response.put("path", user.getProfilePicturePath());
            return ResponseEntity.ok(response);
        } catch (IOException e) {
            response.put("error", "Failed to upload profile picture: " + e.getMessage());
            return new ResponseEntity<>(response, HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }

    @GetMapping("/{userId}/profile-picture")
    public ResponseEntity<?> getProfilePicture(@PathVariable Long userId) {
        Map<String, String> response = new HashMap<>();
        try {
            User user = userRepository.findById(userId)
                    .orElseThrow(() -> new IllegalArgumentException("User not found"));

            String imagePath = user.getProfilePicturePath();
            if (imagePath == null || imagePath.isEmpty()) {
                imagePath = "Uploads/profile-pictures/default-profile.jpg"; // Default image
            }

            File file = new File(imagePath);
            if (!file.exists() || !file.isFile()) {
                response.put("error", "Profile picture not found");
                return new ResponseEntity<>(response, HttpStatus.NOT_FOUND);
            }

            Resource resource = new FileSystemResource(file);
            String contentType = Files.probeContentType(file.toPath());
            if (contentType == null) {
                contentType = "image/jpeg";
            }

            return ResponseEntity.ok()
                    .contentType(MediaType.parseMediaType(contentType))
                    .header(HttpHeaders.CONTENT_DISPOSITION, "inline; filename=\"" + file.getName() + "\"")
                    .body(resource);
        } catch (IOException e) {
            response.put("error", "Failed to retrieve profile picture: " + e.getMessage());
            return new ResponseEntity<>(response, HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
}

dto :
BulkDriverDTO :
package com.example.shuttlemonitor.dto;

public record BulkDriverDTO(
        String username,
        String email,
        String password,
        String licenseNumber,
        String contactPhone,
        String emergencyContact
) {}

BulkOperatorDriverDTO :
package com.example.shuttlemonitor.dto;

import java.util.List;

public record BulkOperatorDriverDTO(
        String operatorUsername,
        String operatorEmail,
        String operatorPassword,
        String operatorFullName,
        String operatorContactPhone,
        List<BulkDriverDTO> drivers  // Up to 5 drivers per operator
) {}

BulkParentStudentDTO :
package com.example.shuttlemonitor.dto;

import java.util.List;

public record BulkParentStudentDTO(
        String parentUsername,
        String parentEmail,
        String parentPassword,
        String parentFullName,
        String parentContactPhone,
        String parentCurrentAddress,
        List<BulkStudentDTO> students  // Up to 5 students per parent
) {}
BulkStudentDTO :
package com.example.shuttlemonitor.dto;

public record BulkStudentDTO(
        String username,
        String email,
        String password,
        String fullName,
        String contactPhone,
        String currentAddress,
        String grade,
        String section
) {}

MailBody :
package com.example.shuttlemonitor.dto;

import lombok.Builder;

@Builder
public record MailBody(String to, String subject, String text) {
}

OperatorSignUpDTO :
package com.example.shuttlemonitor.dto;

import java.util.List;

public record OperatorSignUpDTO(UserSignUpDTO operator, List<UserSignUpDTO> drivers) {
}

ParentSignUpDTO :
package com.example.shuttlemonitor.dto;

import java.util.List;

public record ParentSignUpDTO(UserSignUpDTO parent, List<UserSignUpDTO> students) {
}

UserSignUpDTO:
package com.example.shuttlemonitor.dto;

public record UserSignUpDTO(
        String username,
        String email,
        String password,
        String role,
        String currentAddress,
        String fullName,
        String contactPhone,
        String grade,
        String section,
        String licenseNumber,
        String emergencyContact
) {}

Entity :
CheckIn:
package com.example.shuttlemonitor.Entity;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

@Entity
@Data
@AllArgsConstructor
@NoArgsConstructor
@Table(name = "check_ins")
public class CheckIn {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long checkInId;

    @ManyToOne
    @JoinColumn(name = "student_id")
    private Student student;

    @ManyToOne
    @JoinColumn(name = "shuttle_id")
    private Shuttle shuttle;

    private String type; // "in" or "out"

    private String status; // "success" or "failed"

    private LocalDateTime timestamp;

    private String rfidTag; // Logged for audit

    private String fingerprintHash; // Logged for audit

    @PrePersist
    protected void onCreate() {
        timestamp = LocalDateTime.now();
    }
}
Driver:
package com.example.shuttlemonitor.Entity;

import jakarta.persistence.*;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Entity
@Data
@AllArgsConstructor
@NoArgsConstructor
public class Driver {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long driverId;

    @OneToOne
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    private String licenseNumber;

    private String contactPhone;

    private String emergencyContact;

    @ManyToOne
    @JoinColumn(name = "operator_id")
    private Operator operator;
}

ForgotPassword :
package com.example.shuttlemonitor.Entity;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;

import java.util.Date;

@Entity
@NoArgsConstructor
@AllArgsConstructor
@Getter
@Builder
public class ForgotPassword {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer forgotPasswordId;

    @Column(nullable = false)
    private Integer otp;

    @Column(nullable = false)
    private Date expirationTime;

    @ManyToOne
    @JoinColumn(name = "user_id", nullable = false)
    private User user;
}

Operator :
package com.example.shuttlemonitor.Entity;

import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.ArrayList;
import java.util.List;

@Entity
@Data
@AllArgsConstructor
@NoArgsConstructor
public class Operator {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long operatorId;

    @OneToOne
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    private String fullName;

    private String contactPhone;

    @OneToMany(mappedBy = "operator", cascade = CascadeType.ALL)
    @JsonIgnore
    private List<Driver> drivers = new ArrayList<>();
}

Parent:
package com.example.shuttlemonitor.Entity;

import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.ArrayList;
import java.util.List;

@Entity
@Data
@AllArgsConstructor
@NoArgsConstructor
public class Parent {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long parentId;

    @OneToOne
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    private String fullName;

    private String contactPhone;

    private String currentAddress;

    @OneToMany(mappedBy = "parent", cascade = CascadeType.ALL)
    @JsonIgnore
    private List<Student> children = new ArrayList<>();
}

Role :
package com.example.shuttlemonitor.Entity;

public enum Role {
    ADMIN, PARENT, STUDENT, OPERATOR, DRIVER
}

Shuttle :
package com.example.shuttlemonitor.Entity;

import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Entity
@Data
@AllArgsConstructor
@NoArgsConstructor
@Table(name = "shuttles")
public class Shuttle {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long shuttleId;

    private String name; // New: Shuttle Name (e.g., "Shuttle A")

    @Enumerated(EnumType.STRING)
    private Status status = Status.ACTIVE; // New: Status (default ACTIVE)

    private Integer maxCapacity = 50; // New: Max Capacity (default 50, editable)

    @ManyToOne
    @JoinColumn(name = "driver_id")
    private Driver driver;

    @ManyToOne
    @JoinColumn(name = "operator_id")
    private Operator operator;

    private String route; // e.g., "ADNU to Barangay X"

    private LocalDateTime createdAt;

    @OneToMany(mappedBy = "shuttle", cascade = CascadeType.ALL)
    @JsonIgnore
    private List<CheckIn> checkIns = new ArrayList<>();

    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
    }
}

Status :
package com.example.shuttlemonitor.Entity;

public enum Status {
    ACTIVE,
    INACTIVE,
    MAINTENANCE
}

Student :
package com.example.shuttlemonitor.Entity;

import jakarta.persistence.*;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Entity
@Data
@AllArgsConstructor
@NoArgsConstructor
public class Student {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long studentId;

    @OneToOne
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    private String fullName;

    private String contactPhone;

    private String currentAddress;

    private String grade;

    private String section;

    private String rfidTag;

    private String fingerprintHash;

    @ManyToOne
    @JoinColumn(name = "parent_id")
    private Parent parent;

    @ManyToOne
    @JoinColumn(name = "assigned_shuttle_id")
    private Shuttle assignedShuttle;  // New: Assigned shuttle for the student
}

User :
package com.example.shuttlemonitor.Entity;

import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;
import java.util.List;

@Entity
@Data
@AllArgsConstructor
@NoArgsConstructor
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long userId;

    @Column(unique = true, nullable = false)
    private String username;

    @Column(nullable = false)
    @JsonIgnore
    private String password;

    @Column(unique = true, nullable = false)
    private String email;

    @Enumerated(EnumType.STRING)
    private Role role;

    @Column(nullable = true)
    private LocalDateTime createdAt;

    @Column
    private String profilePicturePath; // New field for profile picture

    @OneToMany(mappedBy = "user", cascade = CascadeType.ALL, orphanRemoval = true)
    @JsonIgnore
    private List<ForgotPassword> forgotPasswords;

    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
    }
}

exception :
UnauthorizedAccessException :
package com.example.shuttlemonitor.exception;

public class UnauthorizedAccessException extends RuntimeException {
    public UnauthorizedAccessException(String message) {
        super(message);
    }
}

Repository :
CheckInRepository :
package com.example.shuttlemonitor.Repository;

import com.example.shuttlemonitor.Entity.CheckIn;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.List;

@Repository
public interface CheckInRepository extends JpaRepository<CheckIn, Long> {
    @Query("SELECT c FROM CheckIn c WHERE c.student.user.userId = :studentId AND c.timestamp >= :startDate")
    List<CheckIn> findByStudentIdAndDate(@Param("studentId") Long studentId, @Param("startDate") LocalDateTime startDate);
}

DriverRepository :
package com.example.shuttlemonitor.Repository;

import com.example.shuttlemonitor.Entity.Driver;
import com.example.shuttlemonitor.Entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface DriverRepository extends JpaRepository<Driver, Long> {
    Optional<Driver> findByUser(User user);
}

ForgotPasswordRepository :
package com.example.shuttlemonitor.Repository;

import com.example.shuttlemonitor.Entity.ForgotPassword;
import com.example.shuttlemonitor.Entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface ForgotPasswordRepository extends JpaRepository<ForgotPassword, Integer> {
    @Query("select fp from ForgotPassword fp where fp.otp = ?1 and fp.user = ?2")
    Optional<ForgotPassword> findByOtpAndUser(Integer otp, User user);

    @Modifying
    @Query("DELETE FROM ForgotPassword fp WHERE fp.user = ?1")
    void deleteByUser(User user);
}

OperatorRepository :
package com.example.shuttlemonitor.Repository;

import com.example.shuttlemonitor.Entity.Operator;
import com.example.shuttlemonitor.Entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface OperatorRepository extends JpaRepository<Operator, Long> {
    Optional<Operator> findByUser(User user);
}

ParentRepository :
package com.example.shuttlemonitor.Repository;

import com.example.shuttlemonitor.Entity.Parent;
import com.example.shuttlemonitor.Entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface ParentRepository extends JpaRepository<Parent, Long> {
    Optional<Parent> findByUser(User user);
}

ShuttleRepository :
package com.example.shuttlemonitor.Repository;

import com.example.shuttlemonitor.Entity.Shuttle;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface ShuttleRepository extends JpaRepository<Shuttle, Long> {
    // New: Optional query for occupancy calculation (count active check-ins)
    @Query("SELECT COUNT(c) FROM CheckIn c WHERE c.shuttle.shuttleId = :shuttleId AND c.type = 'in' AND c.status = 'success'")
    Long countActiveOccupancy(@Param("shuttleId") Long shuttleId);
}
StudentRepository :
package com.example.shuttlemonitor.Repository;

import com.example.shuttlemonitor.Entity.Shuttle;
import com.example.shuttlemonitor.Entity.Student;
import com.example.shuttlemonitor.Entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface StudentRepository extends JpaRepository<Student, Long> {
    Optional<Student> findByUser(User user);
    Optional<Student> findByRfidTag(String rfidTag);

    // New: Find students assigned to a shuttle
    @Query("SELECT s FROM Student s WHERE s.assignedShuttle = :shuttle")
    List<Student> findByAssignedShuttle(Shuttle shuttle);
}

UserRepository :
package com.example.shuttlemonitor.Repository;

import com.example.shuttlemonitor.Entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    User findByUsername(String username);
    Optional<User> findByEmail(String email);
    Optional<User> findByUsernameOrEmail(String username, String email);

    @Modifying
    @Query("UPDATE User u SET u.password = ?2 WHERE u.email = ?1")
    void updatePassword(String email, String password);
}

service :
BulkUploadService:
package com.example.shuttlemonitor.service;

import com.example.shuttlemonitor.Entity.*;
import com.example.shuttlemonitor.Repository.*;
import com.example.shuttlemonitor.dto.BulkDriverDTO;
import com.example.shuttlemonitor.dto.BulkOperatorDriverDTO;
import com.example.shuttlemonitor.dto.BulkParentStudentDTO;
import com.example.shuttlemonitor.dto.BulkStudentDTO;
import com.example.shuttlemonitor.exception.UnauthorizedAccessException;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.regex.Pattern;

@Service
public class BulkUploadService {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private ParentRepository parentRepository;

    @Autowired
    private StudentRepository studentRepository;

    @Autowired
    private OperatorRepository operatorRepository;

    @Autowired
    private DriverRepository driverRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    // Email validation pattern
    private static final Pattern EMAIL_PATTERN = Pattern.compile("^[A-Za-z0-9+_.-]+@([A-Za-z0-9.-]+\\.[A-Za-z]{2,})$");

    @Transactional
    public Map<String, Object> processBulkParentsStudents(MultipartFile file) throws IOException {
        return processSpecificSheet(file, "ParentsStudents", this::processParentStudentSheet);
    }

    @Transactional
    public Map<String, Object> processBulkOperatorsDrivers(MultipartFile file) throws IOException {
        return processSpecificSheet(file, "OperatorsDrivers", this::processOperatorDriverSheet);
    }

    private Map<String, Object> processSpecificSheet(MultipartFile file, String sheetName, SheetProcessor processor) throws IOException {
        Map<String, Object> result = new HashMap<>();
        List<String> errors = new ArrayList<>();
        List<String> successes = new ArrayList<>();

        try (InputStream is = file.getInputStream();
             Workbook workbook = new XSSFWorkbook(is)) {

            System.out.println("Available sheets for " + sheetName + ": ");
            for (int i = 0; i < workbook.getNumberOfSheets(); i++) {
                System.out.println("Sheet " + i + ": '" + workbook.getSheetName(i) + "'");
            }

            Sheet sheet = workbook.getSheet(sheetName);
            if (sheet != null) {
                processor.process(sheet, successes, errors);
            } else {
                errors.add("Sheet '" + sheetName + "' not found in Excel file");
            }
        }

        result.put("successes", successes);
        result.put("errors", errors);
        result.put("totalProcessed", successes.size() + errors.size());
        return result;
    }

    @FunctionalInterface
    private interface SheetProcessor {
        void process(Sheet sheet, List<String> successes, List<String> errors);
    }

    private void processParentStudentSheet(Sheet sheet, List<String> successes, List<String> errors) {
        for (int i = 1; i <= sheet.getLastRowNum(); i++) { // Start from row 1 (Excel Row 2, skip header)
            Row row = sheet.getRow(i);
            if (row == null || isEmptyRow(row)) continue;

            int excelRowNum = i + 1; // 1-based for user-friendly errors
            try {
                BulkParentStudentDTO dto = parseParentStudentRow(row);
                if (dto != null) { // Allow parents without students
                    createParentWithStudents(dto, successes, errors, excelRowNum);
                } else {
                    errors.add("Row " + excelRowNum + ": No valid data found");
                }
            } catch (Exception e) {
                errors.add("Row " + excelRowNum + ": " + e.getMessage());
            }
        }
    }

    private void processOperatorDriverSheet(Sheet sheet, List<String> successes, List<String> errors) {
        for (int i = 1; i <= sheet.getLastRowNum(); i++) { // Start from row 1 (Excel Row 2)
            Row row = sheet.getRow(i);
            if (row == null || isEmptyRow(row)) continue;

            int excelRowNum = i + 1;
            try {
                BulkOperatorDriverDTO dto = parseOperatorDriverRow(row);
                if (dto != null) { // Allow operators without drivers
                    createOperatorWithDrivers(dto, successes, errors, excelRowNum);
                } else {
                    errors.add("Row " + excelRowNum + ": No valid data found");
                }
            } catch (Exception e) {
                errors.add("Row " + excelRowNum + ": " + e.getMessage());
            }
        }
    }

    private boolean isEmptyRow(Row row) {
        if (row == null) return true;
        for (int j = 0; j < 6; j++) { // Check first 6 columns for parents/operators
            Cell cell = row.getCell(j);
            if (cell != null && getCellValueAsString(cell) != null && !getCellValueAsString(cell).trim().isEmpty()) {
                return false;
            }
        }
        return true;
    }

    private BulkParentStudentDTO parseParentStudentRow(Row row) {
        // Column indices (0-based): 0: parentUsername, 1: parentEmail, 2: parentPassword, 3: parentFullName, 4: parentContactPhone, 5: parentCurrentAddress
        // Students: baseCol 6 + (s * 8)

        String parentUsername = getCellValueAsString(row.getCell(0));
        String parentEmail = getCellValueAsString(row.getCell(1));
        String parentPassword = getCellValueAsString(row.getCell(2));
        String parentFullName = getCellValueAsString(row.getCell(3));
        String parentContactPhone = getCellValueAsString(row.getCell(4));
        String parentCurrentAddress = getCellValueAsString(row.getCell(5));

        // Validate required fields
        if (parentUsername == null || parentUsername.trim().isEmpty() ||
                parentEmail == null || parentEmail.trim().isEmpty() ||
                parentPassword == null || parentPassword.trim().isEmpty()) {
            throw new IllegalArgumentException("Missing required fields for parent (username, email, password)");
        }

        if (!EMAIL_PATTERN.matcher(parentEmail).matches()) {
            throw new IllegalArgumentException("Invalid email format for parent: " + parentEmail);
        }

        if (parentPassword.length() < 6) {
            throw new IllegalArgumentException("Parent password must be at least 6 characters");
        }

        List<BulkStudentDTO> students = new ArrayList<>();
        for (int s = 0; s < 5; s++) {
            int baseCol = 6 + (s * 8);
            String studentUsername = getCellValueAsString(row.getCell(baseCol));
            if (studentUsername == null || studentUsername.trim().isEmpty()) continue;

            String studentEmail = getCellValueAsString(row.getCell(baseCol + 1));
            String studentPassword = getCellValueAsString(row.getCell(baseCol + 2));
            String studentFullName = getCellValueAsString(row.getCell(baseCol + 3));
            String studentContactPhone = getCellValueAsString(row.getCell(baseCol + 4));
            String studentCurrentAddress = getCellValueAsString(row.getCell(baseCol + 5));
            String studentGrade = getCellValueAsString(row.getCell(baseCol + 6));
            String studentSection = getCellValueAsString(row.getCell(baseCol + 7));

            if (studentEmail == null || studentEmail.trim().isEmpty() || !EMAIL_PATTERN.matcher(studentEmail).matches()) {
                throw new IllegalArgumentException("Invalid or missing email for student " + (s + 1) + ": " + studentEmail);
            }

            if (studentPassword == null || studentPassword.trim().isEmpty() || studentPassword.length() < 6) {
                throw new IllegalArgumentException("Invalid or missing password for student " + (s + 1));
            }

            if (studentFullName == null || studentFullName.trim().isEmpty()) {
                throw new IllegalArgumentException("Missing full name for student " + (s + 1));
            }

            if (studentGrade == null || studentGrade.trim().isEmpty() || studentSection == null || studentSection.trim().isEmpty()) {
                throw new IllegalArgumentException("Missing grade or section for student " + (s + 1));
            }

            students.add(new BulkStudentDTO(studentUsername, studentEmail, studentPassword, studentFullName,
                    studentContactPhone, studentCurrentAddress, studentGrade, studentSection));
        }

        return new BulkParentStudentDTO(parentUsername, parentEmail, parentPassword, parentFullName,
                parentContactPhone, parentCurrentAddress, students);
    }

    private BulkOperatorDriverDTO parseOperatorDriverRow(Row row) {
        // Column indices: 0: operatorUsername, 1: operatorEmail, 2: operatorPassword, 3: operatorFullName, 4: operatorContactPhone
        // Drivers: baseCol 5 + (d * 6)

        String operatorUsername = getCellValueAsString(row.getCell(0));
        String operatorEmail = getCellValueAsString(row.getCell(1));
        String operatorPassword = getCellValueAsString(row.getCell(2));
        String operatorFullName = getCellValueAsString(row.getCell(3));
        String operatorContactPhone = getCellValueAsString(row.getCell(4));

        // Validate required fields
        if (operatorUsername == null || operatorUsername.trim().isEmpty() ||
                operatorEmail == null || operatorEmail.trim().isEmpty() ||
                operatorPassword == null || operatorPassword.trim().isEmpty()) {
            throw new IllegalArgumentException("Missing required fields for operator (username, email, password)");
        }

        if (!EMAIL_PATTERN.matcher(operatorEmail).matches()) {
            throw new IllegalArgumentException("Invalid email format for operator: " + operatorEmail);
        }

        if (operatorPassword.length() < 6) {
            throw new IllegalArgumentException("Operator password must be at least 6 characters");
        }

        List<BulkDriverDTO> drivers = new ArrayList<>();
        for (int d = 0; d < 5; d++) {
            int baseCol = 5 + (d * 6);
            String driverUsername = getCellValueAsString(row.getCell(baseCol));
            if (driverUsername == null || driverUsername.trim().isEmpty()) continue;

            String driverEmail = getCellValueAsString(row.getCell(baseCol + 1));
            String driverPassword = getCellValueAsString(row.getCell(baseCol + 2));
            String driverLicenseNumber = getCellValueAsString(row.getCell(baseCol + 3));
            String driverContactPhone = getCellValueAsString(row.getCell(baseCol + 4));
            String driverEmergencyContact = getCellValueAsString(row.getCell(baseCol + 5));

            if (driverEmail == null || driverEmail.trim().isEmpty() || !EMAIL_PATTERN.matcher(driverEmail).matches()) {
                throw new IllegalArgumentException("Invalid or missing email for driver " + (d + 1) + ": " + driverEmail);
            }

            if (driverPassword == null || driverPassword.trim().isEmpty() || driverPassword.length() < 6) {
                throw new IllegalArgumentException("Invalid or missing password for driver " + (d + 1));
            }

            if (driverLicenseNumber == null || driverLicenseNumber.trim().isEmpty()) {
                throw new IllegalArgumentException("Missing license number for driver " + (d + 1));
            }

            drivers.add(new BulkDriverDTO(driverUsername, driverEmail, driverPassword, driverLicenseNumber,
                    driverContactPhone, driverEmergencyContact));
        }

        return new BulkOperatorDriverDTO(operatorUsername, operatorEmail, operatorPassword, operatorFullName,
                operatorContactPhone, drivers);
    }

    private String getCellValueAsString(Cell cell) {
        if (cell == null) return null;
        return switch (cell.getCellType()) {
            case STRING -> cell.getStringCellValue().trim();
            case NUMERIC -> {
                if (DateUtil.isCellDateFormatted(cell)) {
                    yield cell.getDateCellValue().toString();
                } else {
                    // Force numeric to string for phones/IDs (e.g., 6374123456 -> "6374123456")
                    double numericValue = cell.getNumericCellValue();
                    if (numericValue == (long) numericValue) {
                        yield String.valueOf((long) numericValue);
                    } else {
                        yield String.valueOf(numericValue);
                    }
                }
            }
            case BOOLEAN -> String.valueOf(cell.getBooleanCellValue());
            default -> null;
        };
    }

    private void createParentWithStudents(BulkParentStudentDTO dto, List<String> successes, List<String> errors, int rowNum) {
        // Check for duplicate â€“ skip instead of throw
        if (userRepository.findByEmail(dto.parentEmail()).isPresent() || userRepository.findByUsername(dto.parentUsername()) != null) {
            errors.add("Row " + rowNum + ": Duplicate email or username for parent: " + dto.parentUsername() + " (skipped)");
            return;
        }

        try {
            // Create parent user
            User parentUser = new User();
            parentUser.setUsername(dto.parentUsername());
            parentUser.setEmail(dto.parentEmail());
            parentUser.setPassword(passwordEncoder.encode(dto.parentPassword()));
            parentUser.setRole(Role.PARENT);
            parentUser = userRepository.save(parentUser); // Save to get ID

            // Create parent entity
            Parent parent = new Parent();
            parent.setUser(parentUser);
            parent.setFullName(dto.parentFullName());
            parent.setContactPhone(dto.parentContactPhone());
            parent.setCurrentAddress(dto.parentCurrentAddress());
            parent = parentRepository.save(parent);

            int createdStudents = 0;
            // Create students and link to parent
            for (BulkStudentDTO studentDto : dto.students()) {
                // Check duplicate for student
                if (userRepository.findByEmail(studentDto.email()).isPresent() || userRepository.findByUsername(studentDto.username()) != null) {
                    errors.add("Row " + rowNum + ": Duplicate email or username for student '" + studentDto.username() + "' (skipped)");
                    continue;
                }

                User studentUser = new User();
                studentUser.setUsername(studentDto.username());
                studentUser.setEmail(studentDto.email());
                studentUser.setPassword(passwordEncoder.encode(studentDto.password()));
                studentUser.setRole(Role.STUDENT);
                studentUser = userRepository.save(studentUser);

                Student student = new Student();
                student.setUser(studentUser);
                student.setFullName(studentDto.fullName());
                student.setContactPhone(studentDto.contactPhone());
                student.setCurrentAddress(studentDto.currentAddress());
                student.setGrade(studentDto.grade());
                student.setSection(studentDto.section());
                student.setParent(parent);
                studentRepository.save(student);
                createdStudents++;
            }

            successes.add("Row " + rowNum + ": Created parent '" + dto.parentUsername() + "' with " + createdStudents + " students");
        } catch (Exception e) {
            errors.add("Row " + rowNum + ": Failed to create parent '" + dto.parentUsername() + "': " + e.getMessage());
        }
    }

    private void createOperatorWithDrivers(BulkOperatorDriverDTO dto, List<String> successes, List<String> errors, int rowNum) {
        // Check for duplicate â€“ skip instead of throw
        if (userRepository.findByEmail(dto.operatorEmail()).isPresent() || userRepository.findByUsername(dto.operatorUsername()) != null) {
            errors.add("Row " + rowNum + ": Duplicate email or username for operator: " + dto.operatorUsername() + " (skipped)");
            return;
        }

        try {
            // Create operator user
            User operatorUser = new User();
            operatorUser.setUsername(dto.operatorUsername());
            operatorUser.setEmail(dto.operatorEmail());
            operatorUser.setPassword(passwordEncoder.encode(dto.operatorPassword()));
            operatorUser.setRole(Role.OPERATOR);
            operatorUser = userRepository.save(operatorUser);

            // Create operator entity
            Operator operator = new Operator();
            operator.setUser(operatorUser);
            operator.setFullName(dto.operatorFullName());
            operator.setContactPhone(dto.operatorContactPhone());
            operator = operatorRepository.save(operator);

            int createdDrivers = 0;
            // Create drivers and link to operator
            for (BulkDriverDTO driverDto : dto.drivers()) {
                // Check duplicate for driver
                if (userRepository.findByEmail(driverDto.email()).isPresent() || userRepository.findByUsername(driverDto.username()) != null) {
                    errors.add("Row " + rowNum + ": Duplicate email or username for driver '" + driverDto.username() + "' (skipped)");
                    continue;
                }

                User driverUser = new User();
                driverUser.setUsername(driverDto.username());
                driverUser.setEmail(driverDto.email());
                driverUser.setPassword(passwordEncoder.encode(driverDto.password()));
                driverUser.setRole(Role.DRIVER);
                driverUser = userRepository.save(driverUser);

                Driver driver = new Driver();
                driver.setUser(driverUser);
                driver.setLicenseNumber(driverDto.licenseNumber());
                driver.setContactPhone(driverDto.contactPhone());
                driver.setEmergencyContact(driverDto.emergencyContact());
                driver.setOperator(operator);
                driverRepository.save(driver);
                createdDrivers++;
            }

            successes.add("Row " + rowNum + ": Created operator '" + dto.operatorUsername() + "' with " + createdDrivers + " drivers");
        } catch (Exception e) {
            errors.add("Row " + rowNum + ": Failed to create operator '" + dto.operatorUsername() + "': " + e.getMessage());
        }
    }
}

CheckInService :
package com.example.shuttlemonitor.service;

import com.example.shuttlemonitor.Entity.CheckIn;
import com.example.shuttlemonitor.Entity.Shuttle;
import com.example.shuttlemonitor.Entity.Student;
import com.example.shuttlemonitor.Repository.CheckInRepository;
import com.example.shuttlemonitor.Repository.ShuttleRepository;
import com.example.shuttlemonitor.Repository.StudentRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.Optional;

@Service
@Transactional
public class CheckInService {

    @Autowired
    private StudentRepository studentRepository;

    @Autowired
    private ShuttleRepository shuttleRepository;

    @Autowired
    private CheckInRepository checkInRepository;

    public Student getStudentById(Long studentId) {
        return studentRepository.findById(studentId)
                .orElseThrow(() -> new IllegalArgumentException("Student not found"));
    }
    public CheckIn registerDevice(Long studentId, String rfidTag, String fingerprintHash) {
        Optional<Student> studentOpt = studentRepository.findById(studentId);
        if (studentOpt.isEmpty()) {
            throw new IllegalArgumentException("Student not found");
        }
        Student student = studentOpt.get();
        student.setRfidTag(rfidTag);
        student.setFingerprintHash(fingerprintHash);
        studentRepository.save(student);
        return null; // Or return confirmation object if needed
    }

    public CheckIn logCheckIn(Long studentId, Long shuttleId, String rfidTag, String fingerprintHash, String type) {
        Optional<Student> studentOpt = studentRepository.findById(studentId);
        if (studentOpt.isEmpty()) {
            throw new IllegalArgumentException("Student not found");
        }
        Student student = studentOpt.get();

        // Verify RFID/Fingerprint
        if (!rfidTag.equals(student.getRfidTag()) || !fingerprintHash.equals(student.getFingerprintHash())) {
            CheckIn failedCheckIn = new CheckIn();
            failedCheckIn.setStudent(student);
            failedCheckIn.setStatus("failed");
            failedCheckIn.setRfidTag(rfidTag);
            failedCheckIn.setFingerprintHash(fingerprintHash);
            failedCheckIn.setType(type);
            return checkInRepository.save(failedCheckIn);
        }

        Optional<Shuttle> shuttleOpt = shuttleRepository.findById(shuttleId);
        if (shuttleOpt.isEmpty()) {
            throw new IllegalArgumentException("Shuttle not found");
        }
        Shuttle shuttle = shuttleOpt.get();

        CheckIn checkIn = new CheckIn();
        checkIn.setStudent(student);
        checkIn.setShuttle(shuttle);
        checkIn.setType(type); // "in" or "out"
        checkIn.setStatus("success");
        checkIn.setRfidTag(rfidTag);
        checkIn.setFingerprintHash(fingerprintHash);
        return checkInRepository.save(checkIn);
    }
}

EmailService :
package com.example.shuttlemonitor.service;

import com.example.shuttlemonitor.dto.MailBody;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.stereotype.Service;

@Service
public class EmailService {

    private final JavaMailSender mailSender;

    public EmailService(JavaMailSender mailSender) {
        this.mailSender = mailSender;
    }

    public void sendSimpleMessage(MailBody mailBody) {
        SimpleMailMessage message = new SimpleMailMessage();
        message.setTo(mailBody.to());
        message.setFrom("alfrancis@example.com");
        message.setSubject(mailBody.subject());
        message.setText(mailBody.text());
        mailSender.send(message);
    }
}

LoginService :
package com.example.shuttlemonitor.service;

import com.example.shuttlemonitor.Entity.User;
import com.example.shuttlemonitor.Repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class LoginService implements UserDetailsService {

    @Autowired
    private UserRepository userRepository;

    @Override
    public UserDetails loadUserByUsername(String usernameOrEmail) throws UsernameNotFoundException {
        User user = userRepository.findByUsernameOrEmail(usernameOrEmail, usernameOrEmail)
                .orElseThrow(() -> new UsernameNotFoundException("User not found: " + usernameOrEmail));
        List<SimpleGrantedAuthority> authorities = List.of(new SimpleGrantedAuthority("ROLE_" + user.getRole().name()));
        return new org.springframework.security.core.userdetails.User(
                user.getUsername(),
                user.getPassword(),
                authorities
        );
    }
}

ShuttleService :
package com.example.shuttlemonitor.service;

import com.example.shuttlemonitor.Entity.CheckIn;
import com.example.shuttlemonitor.Entity.Shuttle;
import com.example.shuttlemonitor.Entity.Status;
import com.example.shuttlemonitor.Entity.Student;
import com.example.shuttlemonitor.Repository.CheckInRepository;
import com.example.shuttlemonitor.Repository.ShuttleRepository;
import com.example.shuttlemonitor.Repository.StudentRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.Comparator;
import java.util.List;
import java.util.Optional;

@Service
public class ShuttleService {

    @Autowired
    private ShuttleRepository shuttleRepository;

    @Autowired
    private CheckInRepository checkInRepository;

    @Autowired
    private StudentRepository studentRepository;

    public Shuttle getShuttleById(Long shuttleId) {
        return shuttleRepository.findById(shuttleId)
                .orElseThrow(() -> new IllegalArgumentException("Shuttle not found"));
    }

    // Updated: Calculate occupancy with null-safe maxCapacity (fallback to 50)
    public double calculateOccupancy(Shuttle shuttle) {
        Long activeCheckIns = shuttleRepository.countActiveOccupancy(shuttle.getShuttleId());
        Integer capacity = shuttle.getMaxCapacity() != null ? shuttle.getMaxCapacity() : 50;  // Fix: Fallback for null
        return (double) activeCheckIns / capacity * 100; // Percentage
    }

    // Determine next stop (next student's currentAddress, sorted by route logic - simple alphabetical for now)
    public String getNextStop(Shuttle shuttle) {
        // Get students assigned to this shuttle with recent "in" check-in
        List<Student> assignedStudents = studentRepository.findByAssignedShuttle(shuttle);
        if (assignedStudents.isEmpty()) {
            return "No students assigned";
        }

        // Simple logic: Sort by currentAddress alphabetically (real impl: use geolocation/route order)
        Optional<Student> nextStudent = assignedStudents.stream()
                .filter(s -> hasRecentCheckIn(s.getStudentId(), "in")) // Recent "in" not "out"
                .min(Comparator.comparing(s -> s.getCurrentAddress()));

        return nextStudent.map(Student::getCurrentAddress).orElse("End of route");
    }

    // Simple ETA calculation (placeholder: based on occupancy/stops; real: integrate Google Maps API)
    public String getETA(Shuttle shuttle) {
        double occupancy = calculateOccupancy(shuttle);
        int estimatedMinutes = (int) (occupancy > 80 ? 30 : 15); // High occupancy = longer ETA
        LocalDateTime etaTime = LocalDateTime.now().plusMinutes(estimatedMinutes);
        return etaTime.toString();
    }

    private boolean hasRecentCheckIn(Long studentId, String type) {
        // Check for recent check-in (last 1 hour, customizable)
        List<CheckIn> recentCheckIns = checkInRepository.findByStudentIdAndDate(studentId, LocalDateTime.now().minusHours(1));
        return recentCheckIns.stream().anyMatch(c -> c.getType().equals(type) && c.getStatus().equals("success"));
    }

    public void deleteShuttle(Long shuttleId) {
        Shuttle shuttle = getShuttleById(shuttleId);
        List<Student> assignedStudents = studentRepository.findByAssignedShuttle(shuttle);
        for (Student student : assignedStudents) {
            student.setAssignedShuttle(null);
            studentRepository.save(student);
        }
        shuttleRepository.delete(shuttle);
    }
}

UserService :
package com.example.shuttlemonitor.service;

import com.example.shuttlemonitor.Entity.*;
import com.example.shuttlemonitor.Repository.*;
import com.example.shuttlemonitor.exception.UnauthorizedAccessException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class UserService {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private ParentRepository parentRepository;

    @Autowired
    private StudentRepository studentRepository;

    @Autowired
    private OperatorRepository operatorRepository;

    @Autowired
    private DriverRepository driverRepository;

    @Autowired
    private ShuttleRepository shuttleRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    public ResponseEntity<String> createUser(User user) {
        if (userRepository.findByUsernameOrEmail(user.getUsername(), user.getEmail()).isPresent()) {
            return new ResponseEntity<>("Username or email already exists", HttpStatus.CONFLICT);
        }
        user.setPassword(passwordEncoder.encode(user.getPassword()));
        userRepository.save(user);
        // If role not ADMIN, create corresponding entity with default fields
        if (user.getRole() != Role.ADMIN) {
            switch (user.getRole()) {
                case PARENT:
                    Parent parent = new Parent();
                    parent.setUser(user);
                    parentRepository.save(parent);
                    break;
                case STUDENT:
                    Student student = new Student();
                    student.setUser(user);
                    studentRepository.save(student);
                    break;
                case OPERATOR:
                    Operator operator = new Operator();
                    operator.setUser(user);
                    operatorRepository.save(operator);
                    break;
                case DRIVER:
                    Driver driver = new Driver();
                    driver.setUser(user);
                    driverRepository.save(driver);
                    break;
            }
        }
        return new ResponseEntity<>("User created successfully", HttpStatus.CREATED);
    }

    public ResponseEntity<User> getUserWithDetails(Long userId) {
        return userRepository.findById(userId)
                .map(user -> new ResponseEntity<>(user, HttpStatus.OK))
                .orElseGet(() -> new ResponseEntity<>(null, HttpStatus.NOT_FOUND));
    }

    public ResponseEntity<String> deleteUser(Long userId) {
        String currentUsername = ((UserDetails) SecurityContextHolder.getContext().getAuthentication().getPrincipal()).getUsername();
        User currentUser = userRepository.findByUsername(currentUsername);
        if (currentUser != null && currentUser.getUserId().equals(userId)) {
            return new ResponseEntity<>("Cannot delete own account", HttpStatus.FORBIDDEN);
        }

        User user = userRepository.findById(userId).orElse(null);
        if (user == null) {
            return new ResponseEntity<>("User not found", HttpStatus.NOT_FOUND);
        }

        // Delete role-specific entity first
        switch (user.getRole()) {
            case PARENT:
                Parent parent = parentRepository.findByUser(user).orElse(null);
                if (parent != null) parentRepository.delete(parent);
                break;
            case STUDENT:
                Student student = studentRepository.findByUser(user).orElse(null);
                if (student != null) studentRepository.delete(student);
                break;
            case OPERATOR:
                Operator operator = operatorRepository.findByUser(user).orElse(null);
                if (operator != null) operatorRepository.delete(operator);
                break;
            case DRIVER:
                Driver driver = driverRepository.findByUser(user).orElse(null);
                if (driver != null) driverRepository.delete(driver);
                break;
            default:
                // For ADMIN, no additional
                break;
        }

        userRepository.deleteById(userId);
        return new ResponseEntity<>("User deleted successfully", HttpStatus.OK);
    }

    public List<User> getAllUsers(String sortBy, String sortOrder) {
        String sortField;
        switch (sortBy.toLowerCase()) {
            case "username":
                sortField = "username";
                break;
            case "email":
                sortField = "email";
                break;
            case "createdat":
            case "date":
                sortField = "createdAt";
                break;
            default:
                sortField = "createdAt"; // Default sort
        }

        Sort sort = Sort.by(sortOrder.equalsIgnoreCase("asc") ? Sort.Direction.ASC : Sort.Direction.DESC, sortField);
        return userRepository.findAll(sort);
    }

    public User getCurrentUser() {
        String username = ((UserDetails) SecurityContextHolder.getContext().getAuthentication().getPrincipal()).getUsername();
        return userRepository.findByUsername(username);
    }

    public Parent getCurrentParent() {
        User current = getCurrentUser();
        if (current.getRole() != Role.PARENT) return null;
        return parentRepository.findByUser(current).orElseThrow(() -> new IllegalArgumentException("Parent not found for user"));
    }

    public Student getCurrentStudent() {
        User current = getCurrentUser();
        if (current.getRole() != Role.STUDENT) return null;
        return studentRepository.findByUser(current).orElseThrow(() -> new IllegalArgumentException("Student not found for user"));
    }

    public Operator getCurrentOperator() {
        User current = getCurrentUser();
        if (current.getRole() != Role.OPERATOR) return null;
        return operatorRepository.findByUser(current).orElseThrow(() -> new IllegalArgumentException("Operator not found for user"));
    }

    public Driver getCurrentDriver() {
        User current = getCurrentUser();
        if (current.getRole() != Role.DRIVER) return null;
        return driverRepository.findByUser(current).orElseThrow(() -> new IllegalArgumentException("Driver not found for user"));
    }

    public boolean isOwnerOrAdminForParent(Long parentId) {
        User currentUser = getCurrentUser();
        if (currentUser.getRole() == Role.ADMIN) return true;
        Parent target = parentRepository.findById(parentId).orElse(null);
        if (target == null) return false;
        return target.getUser().getUserId().equals(currentUser.getUserId());
    }

    public boolean isOwnerOrAdminForOperator(Long operatorId) {
        User currentUser = getCurrentUser();
        if (currentUser.getRole() == Role.ADMIN) return true;
        Operator target = operatorRepository.findById(operatorId).orElse(null);
        if (target == null) return false;
        return target.getUser().getUserId().equals(currentUser.getUserId());
    }

    public boolean isOwnerOrAdminOrParentForStudent(Long studentId) {
        User currentUser = getCurrentUser();
        if (currentUser.getRole() == Role.ADMIN) return true;
        Student student = studentRepository.findById(studentId).orElse(null);
        if (student == null) return false;
        if (currentUser.getRole() == Role.STUDENT && student.getUser().getUserId().equals(currentUser.getUserId())) return true;
        if (currentUser.getRole() == Role.PARENT) {
            Parent currentParent = getCurrentParent();
            if (currentParent != null && student.getParent() != null && student.getParent().getParentId().equals(currentParent.getParentId())) return true;
        }
        return false;
    }

    public boolean isOwnerOrAdminOrOperatorForDriver(Long driverId) {
        User currentUser = getCurrentUser();
        if (currentUser.getRole() == Role.ADMIN) return true;
        Driver driver = driverRepository.findById(driverId).orElse(null);
        if (driver == null) return false;
        if (currentUser.getRole() == Role.DRIVER && driver.getUser().getUserId().equals(currentUser.getUserId())) return true;
        if (currentUser.getRole() == Role.OPERATOR) {
            Operator currentOperator = getCurrentOperator();
            if (currentOperator != null && driver.getOperator() != null && driver.getOperator().getOperatorId().equals(currentOperator.getOperatorId())) return true;
        }
        return false;
    }

    public void checkAccessForStudent(Student student) {
        if (!isOwnerOrAdminOrParentForStudent(student.getStudentId())) {
            throw new UnauthorizedAccessException("Unauthorized");
        }
    }

    public void checkAccessForParent(Parent parent) {
        if (!isOwnerOrAdminForParent(parent.getParentId())) {
            throw new UnauthorizedAccessException("Unauthorized");
        }
    }

    public void checkAccessForOperator(Operator operator) {
        if (!isOwnerOrAdminForOperator(operator.getOperatorId())) {
            throw new UnauthorizedAccessException("Unauthorized");
        }
    }

    public void checkAccessForDriver(Driver driver) {
        if (!isOwnerOrAdminOrOperatorForDriver(driver.getDriverId())) {
            throw new UnauthorizedAccessException("Unauthorized");
        }
    }
    public Student assignShuttleToStudent(Long studentId, Long shuttleId) {
        Student student = studentRepository.findById(studentId)
                .orElseThrow(() -> new IllegalArgumentException("Student not found"));
        checkAccessForStudent(student);  // Existing access check

        Shuttle shuttle = shuttleRepository.findById(shuttleId)
                .orElseThrow(() -> new IllegalArgumentException("Shuttle not found"));

        student.setAssignedShuttle(shuttle);
        return studentRepository.save(student);
    }
}

util :
ChangePassword :
package com.example.shuttlemonitor.util;

public record ChangePassword(String currentPassword, String newPassword, String repeatPassword) {
}

resources:
application.properties :
spring.application.name=shuttlemonitor
server.port=8080
spring.datasource.url=jdbc:postgresql://localhost:5432/shuttle_monitor
spring.datasource.username=postgres
spring.datasource.password=100403
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.mail.host=smtp.gmail.com
spring.mail.port=587
spring.mail.username=alfrancisbadillapaz10@gmail.com
spring.mail.password=ausw wjdu olkh fszr
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true
spring.mail.properties.mail.smtp.connectiontimeout=5000
spring.mail.properties.mail.smtp.timeout=5000
spring.mail.properties.mail.smtp.writetimeout=5000
spring.servlet.multipart.max-file-size=500MB
spring.servlet.multipart.max-request-size=500MB
spring.web.resources.static-locations=file:uploads/,classpath:/static/
spring.web.cors.allowed-origins=*
logging.level.org.springframework.security=DEBUG
logging.level.com.example.shuttlemonitor=DEBUG
jwt.secret=my-very-secure-secret-key-1234567890
otp.expiration.minutes=20
spring.jackson.time-zone=Asia/Manila
spring.data.web.pageable.default-page-size=10
spring.data.web.pageable.max-page-size=100
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE
# Enable Swagger UI
springdoc.swagger-ui.path=/swagger-ui.html
springdoc.swagger-ui.enabled=true
springdoc.api-docs.path=/v3/api-docs

# Security: Include your JWT in Swagger (for testing authenticated endpoints)
springdoc.swagger-ui.oauth2-redirect-url=/swagger-ui/oauth2-redirect.html
springdoc.swagger-ui.operations-sorter=method
springdoc.swagger-ui.try-it-out-enabled=true

# Group endpoints by tags (if you add @Tag to controllers)
springdoc.swagger-ui.tags-sorter=alpha

pom.xml :
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>3.4.0</version>
		<relativePath />
	</parent>
	<groupId>com.example</groupId>
	<artifactId>shuttlemonitor</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>shuttlemonitor</name>
	<description>Shuttle Monitoring Application</description>
	<properties>
		<java.version>17</java.version>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>
		<dependency>
			<groupId>com.itextpdf</groupId>
			<artifactId>itext7-core</artifactId>
			<version>7.2.5</version>
			<type>pom</type>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-mail</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-validation</artifactId>
		</dependency>
		<dependency>
			<groupId>org.apache.commons</groupId>
			<artifactId>commons-imaging</artifactId>
			<version>1.0-alpha3</version>
		</dependency>
		<dependency>
			<groupId>org.postgresql</groupId>
			<artifactId>postgresql</artifactId>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-api</artifactId>
			<version>0.11.5</version>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-impl</artifactId>
			<version>0.11.5</version>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>com.fasterxml.jackson.core</groupId>
			<artifactId>jackson-databind</artifactId>
			<version>2.17.2</version>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-jackson</artifactId>
			<version>0.11.5</version>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.security</groupId>
			<artifactId>spring-security-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>com.sun.activation</groupId>
			<artifactId>javax.activation</artifactId>
			<version>1.2.0</version>
		</dependency>
		<!-- Apache POI for Excel processing -->
		<dependency>
			<groupId>org.apache.poi</groupId>
			<artifactId>poi</artifactId>
			<version>5.2.5</version>
		</dependency>
		<dependency>
			<groupId>org.apache.poi</groupId>
			<artifactId>poi-ooxml</artifactId>
			<version>5.2.5</version>
		</dependency>
		<dependency>
			<groupId>org.springdoc</groupId>
			<artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
			<version>2.6.0</version>
		</dependency>
	</dependencies>
	<build>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<configuration>
					<source>17</source>
					<target>17</target>
					<annotationProcessorPaths>
						<path>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</path>
					</annotationProcessorPaths>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
			</plugin>
		</plugins>
	</build>
</project>


This is my full Backend Code together with its ADMID Web Dashboard frontend for Shuttle Monitoring System. I want you to analyze the frontend on what backend features of API/data is still not yet on the dashboard. Create a planning for this project. Analyze if carefully to make this better.


