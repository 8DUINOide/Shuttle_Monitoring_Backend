<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="icon" type="image/png" href="images/logo.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css" type="text/css">
    <style>
        .map-search {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 10px;
        }
        .map-search input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
        }
        .map-search button {
            padding: 8px 12px;
            background-color: #003A6C;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .map-search button:hover {
            background-color: #0066CC;
        }
        .map-container {
            position: relative;
            width: 100%;
            height: 600px;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .active-shuttles {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .map-style-selector {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .map-style-selector select {
            padding: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div id="login-screen" class="login-bg">
    <div class="login-container">
        <img src="images/logo.png" class="logo">
        <h3 style="color: #003A6C; font-size: 2rem; margin: 0.5rem 0 2rem 0; font-weight: bold; text-align: center;">Ride.ADNU</h3>
        <input type="text" placeholder="Username" id="username">
        <div class="password-wrapper">
            <input type="password" placeholder="Password" id="password">
            <span class="toggle-password" onclick="togglePassword('password', this)">
                <i class="fa-solid fa-eye-slash"></i>
            </span>
        </div>
        <p id="login-error" class="error-text" style="display:none; color: red; text-align: center; margin-top: 10px;"></p>
        <button onclick="login()">Sign in</button>
        <a href="reset-password.html" style="display: block; margin-top: 10px; text-align: center; color: #ffffff;">Forgot Password?</a>
    </div>
</div>

<div id="dashboard" class="dashboard" style="display: none">
    <div id="sidebar" class="sidebar">
        <div class="sidebar-profile">
            <img id="sidebar-profile-picture" src="images/default-profile.png" alt="Admin Profile Picture" class="sidebar-profile-pic">
            <p class="sidebar-username" id="sidebar-username"></p>
            <p class="sidebar-email" id="sidebar-email"></p>
        </div>
        <ul>
            <li onclick="showTab('home')"><i class="fa-solid fa-house"></i> Dashboard</li>
            <li onclick="showTab('live-map')"><i class="fa-solid fa-map-location-dot"></i> Live Map</li>
            <li onclick="showTab('students')"><i class="fa-solid fa-users"></i> Students</li>
            <li onclick="showTab('drivers')"><i class="fa-solid fa-id-card"></i> Drivers</li>
            <li onclick="showTab('shuttles')"><i class="fa-solid fa-bus"></i> Shuttles</li>
            <li onclick="showTab('notifications')"><i class="fa-solid fa-bell"></i> Notifications</li>
            <li onclick="showTab('profile')"><i class="fa-solid fa-user"></i> Profile</li>
            <li onclick="showLogoutConfirmModal()"><i class="fa-solid fa-sign-out-alt"></i> Logout</li>
        </ul>
    </div>

    <div class="sidebar-toggle" onclick="toggleSidebar()">â˜°</div>
    <div id="content" class="content">
        <div id="home" class="tab active">
            <header>
                <div class="title-container">
                    <i class="fa-solid fa-house"></i>
                    <h2>Dashboard Overview</h2>
                </div>
                <p>Real-time shuttle monitoring and management</p>
            </header>
            <div class="balance-section">
                <div class="balance-card">
                    <div class="label">Active Shuttles</div>
                    <h1>0</h1>
                </div>
                <div class="balance-card">
                    <div class="label">Students Checked In</div>
                    <h1>0</h1>
                </div>
                <div class="balance-card">
                    <div class="label">On time Performance</div>
                    <h1>0%</h1>
                </div>
                <div class="balance-card">
                    <div class="label">Routes Active</div>
                    <h1>0</h1>
                </div>
                <div class="chart-card">
                    <h4>Today's Routes</h4>
                    <table id="todays-routes-table">
                        <thead>
                        <tr>
                            <th>Route</th>
                            <th>Shuttle</th>
                            <th>Driver</th>
                            <th>Capacity</th>
                            <th>Status</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="chart-card">
                    <h4>Recent Activity</h4>
                    <ul id="recent-activity-list"></ul>
                </div>
            </div>
        </div>

        <div id="shuttles" class="tab">
            <header>
                <div class="title-container">
                    <i class="fa-solid fa-bus"></i>
                    <h2>Shuttle Management</h2>
                </div>
                <p>Monitor and manage all shuttle operations</p>
            </header>
            <div class="table-header">
                <div class="table-title-section">
                    <h3>Active Shuttles</h3>
                    <p>Real time shuttle tracking and status monitoring</p>
                </div>
                <div class="table-actions">
                    <button class="add-btn" onclick="showAddShuttleModal()">
                        <i class="fa-solid fa-plus"></i> Add Shuttle
                    </button>
                </div>
            </div>
            <div class="search-container">
                <input id="searchShuttles" type="text" placeholder="Search shuttles, drivers, or routes..." oninput="filterShuttles()">
                <select id="statusFilter" onchange="filterShuttles()">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="maintenance">Maintenance</option>
                </select>
            </div>
            <p id="no-shuttles-message" style="display:none; color: red; margin-top: 10px;">No shuttles found.</p>
            <table>
                <thead>
                <tr>
                    <th>Shuttle</th>
                    <th>Driver</th>
                    <th>Route</th>
                    <th>Status</th>
                    <th>Occupancy</th>
                    <th>Location</th>
                    <th>Next Stop</th>
                    <th>ETA</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="shuttles-table"></tbody>
            </table>
        </div>

        <div id="students" class="tab users-tab">
            <header>
                <div class="title-container">
                    <i class="fa-solid fa-users"></i>
                    <h2>Student Management</h2>
                </div>
                <p>Monitor and manage all student shuttle operations</p>
            </header>
            <div class="table-header">
                <div class="table-title-section">
                    <h3>Active Students</h3>
                    <p>Real-time student tracking and status monitoring</p>
                </div>
                <div class="table-actions">
                    <button class="add-btn" onclick="showAddParentModal()">
                        <i class="fa-solid fa-plus"></i> Add Parent & Students
                    </button>
                    <button class="add-btn bulk-btn" onclick="showBulkUploadModal('students')">
                        <i class="fa-solid fa-file-excel"></i> Bulk Upload
                    </button>
                </div>
            </div>
            <div class="search-container">
                <input id="searchStudents" type="text" placeholder="Search students, parents, or shuttles..." oninput="filterStudents()">
                <select id="statusFilter" onchange="filterStudents()">
                    <option value="all">All Status</option>
                    <option value="checked-in">Checked in</option>
                    <option value="checked-out">Checked out</option>
                    <option value="not-boarded">Not boarded</option>
                </select>
            </div>
            <p id="no-students-message" style="display:none; color: red; margin-top: 10px;">No students found.</p>
            <table>
                <thead>
                <tr>
                    <th><i class="fa-solid fa-user"></i> Student</th>
                    <th><i class="fa-solid fa-user"></i> Parent/Guardian</th>
                    <th><i class="fa-solid fa-address-book"></i> Contact</th>
                    <th><i class="fa-solid fa-bus"></i> Assigned Shuttle</th>
                    <th>Status</th>
                    <th>Check-in Time</th>
                    <th>Current Location</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="students-table"></tbody>
            </table>
        </div>

        <div id="drivers" class="tab users-tab">
            <header>
                <div class="title-container">
                    <i class="fa-solid fa-id-card"></i>
                    <h2>Driver Management</h2>
                </div>
                <p>Monitor and manage all driver operations</p>
            </header>
            <div class="table-header">
                <div class="table-title-section">
                    <h3>Active Drivers</h3>
                    <p>Real-time driver tracking and status monitoring</p>
                </div>
                <div class="table-actions">
                    <button class="add-btn" onclick="showAddOperatorModal()">
                        <i class="fa-solid fa-plus"></i> Add Operator & Drivers
                    </button>
                    <button class="add-btn bulk-btn" onclick="showBulkUploadModal('drivers')">
                        <i class="fa-solid fa-file-excel"></i> Bulk Upload
                    </button>
                </div>
            </div>
            <div class="search-container">
                <input id="searchDrivers" type="text" placeholder="Search drivers, operators, or licenses..." oninput="filterDrivers()">
                <select id="statusFilterDrivers" onchange="filterDrivers()">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="maintenance">Maintenance</option>
                </select>
            </div>
            <p id="no-drivers-message" style="display:none; color: red; margin-top: 10px;">No drivers found.</p>
            <table>
                <thead>
                <tr>
                    <th><i class="fa-solid fa-user"></i> Driver</th>
                    <th><i class="fa-solid fa-user-tie"></i> Operator</th>
                    <th><i class="fa-solid fa-address-book"></i> Contact</th>
                    <th><i class="fa-solid fa-id-card"></i> License</th>
                    <th><i class="fa-solid fa-phone-volume"></i> Emergency Contact</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="drivers-table"></tbody>
            </table>
        </div>

        <div id="notifications" class="tab">
            <header>
                <div class="title-container">
                    <i class="fa-solid fa-bell"></i>
                    <h2>Notifications</h2>
                </div>
                <p>Real-time system alerts and activity updates</p>
            </header>
            <div class="table-header">
                <h3>System Notifications</h3>
                <div class="table-actions">
                    <button class="action-btn" onclick="markAllAsRead()">Mark All as Read</button>
                    <button class="action-btn" onclick="clearAllNotifications()">Clear All</button>
                </div>
            </div>
            <div class="search-container">
                <input id="searchNotifications" type="text" placeholder="Search notifications..." oninput="filterNotifications()">
                <select id="notificationStatusFilter" onchange="filterNotifications()">
                    <option value="all">All Status</option>
                    <option value="unread">Unread</option>
                    <option value="read">Read</option>
                </select>
            </div>
            <p id="no-notifications-message" style="display:none; color: red; margin-top: 10px;">No notifications found.</p>
            <table>
                <thead>
                <tr>
                    <th>Notification Message</th>
                    <th>Timestamp</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody id="notifications-table">
                <tr>
                    <td>Sarah Johnson checked in to Shuttle #3</td>
                    <td>2025-09-22 12:16:00</td>
                    <td><span class="status-badge badge-unread">Unread</span></td>
                </tr>
                <tr>
                    <td>Shuttle #2 is running 5 minutes behind schedule</td>
                    <td>2025-09-22 12:13:00</td>
                    <td><span class="status-badge badge-read">Read</span></td>
                </tr>
                <tr>
                    <td>Mike Chen checked out from Shuttle #2</td>
                    <td>2025-09-22 12:10:00</td>
                    <td><span class="status-badge badge-unread">Unread</span></td>
                </tr>
                <tr>
                    <td>Route A delayed by 10 minutes</td>
                    <td>2025-09-22 12:00:00</td>
                    <td><span class="status-badge badge-read">Read</span></td>
                </tr>
                </tbody>
            </table>
        </div>

        <div id="live-map" class="tab">
            <header>
                <div class="title-container">
                    <i class="fa-solid fa-map-location-dot"></i>
                    <h2>Live Map Tracking</h2>
                </div>
                <p>Real-time shuttle locations and routes</p>
            </header>
            <div class="table-header">
                <h3>Shuttle Map</h3>
                <div class="table-actions">
                    <div class="map-search">
                        <input id="map-search-input" type="text" placeholder="Search location...">
                        <button class="action-btn" onclick="searchLocation()"><i class="fa-solid fa-search"></i></button>
                    </div>
                    <button class="action-btn" onclick="refreshMap()">Refresh</button>
                    <button class="action-btn" onclick="toggleTrafficLayer()">Toggle Traffic</button>
                </div>
            </div>
            <div class="map-container" style="display: flex; gap: 20px;">
                <div id="map" style="flex: 1; position: relative;"></div>
                <div class="active-shuttles" style="width: 30%; max-height: 600px; overflow-y: auto;">
                    <h3>Active Shuttles</h3>
                    <p>Live Location Tracking</p>
                    <div class="shuttle-list">
                        <div class="shuttle-item">
                            <p><strong>Shuttle #1</strong> - On Time<br>Lat: 14.5995, Lng: 120.9842<br>Driver: John Doe<br>Route: A</p>
                            <button class="action-btn track-btn" onclick="trackShuttle('Shuttle #1')">Track Shuttle</button>
                            <button class="action-btn route-btn" onclick="showRoute('Shuttle #1')">Show Route</button>
                        </div>
                        <div class="shuttle-item">
                            <p><strong>Shuttle #2</strong> - Delayed<br>Lat: 14.6760, Lng: 121.0437<br>Driver: Jane Smith<br>Route: B</p>
                            <button class="action-btn track-btn" onclick="trackShuttle('Shuttle #2')">Track Shuttle</button>
                            <button class="action-btn route-btn" onclick="showRoute('Shuttle #2')">Show Route</button>
                        </div>
                        <div class="shuttle-item">
                            <p><strong>Shuttle #3</strong> - On Time<br>Lat: 14.5580, Lng: 121.0813<br>Driver: Alex Brown<br>Route: C</p>
                            <button class="action-btn track-btn" onclick="trackShuttle('Shuttle #3')">Track Shuttle</button>
                            <button class="action-btn route-btn" onclick="showRoute('Shuttle #3')">Show Route</button>
                        </div>
                        <div class="shuttle-item">
                            <p><strong>Shuttle #4</strong> - Inactive<br>Lat: 14.5547, Lng: 121.0244<br>Driver: None<br>Route: None</p>
                            <button class="action-btn track-btn" onclick="trackShuttle('Shuttle #4')">Track Shuttle</button>
                            <button class="action-btn route-btn" onclick="showRoute('Shuttle #4')" disabled>No Route</button>
                        </div>
                    </div>
                </div>
            </div>
            <script>
                mapboxgl.accessToken = 'pk.eyJ1IjoiYWxmcmFuY2lzYnA0IiwiYSI6ImNtZnRqaDU2dzBsbGIyanM4cHFhbDY1MjMifQ.-ZQAt1NphjZJLxYUeMkZ7g';
                const map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v11',
                    center: [121.7740, 12.8797],
                    zoom: 5
                });

                map.on('load', () => {
                    // Initialize Mapbox Directions
                    const directions = new MapboxDirections({
                        accessToken: mapboxgl.accessToken,
                        unit: 'metric',
                        profile: 'mapbox/driving-traffic',
                        controls: { inputs: true, instructions: true }
                    });
                    map.addControl(directions, 'top-left');

                    // Add Geolocation Control
                    map.addControl(new mapboxgl.GeolocateControl({
                        positionOptions: { enableHighAccuracy: true },
                        trackUserLocation: true,
                        showUserHeading: true
                    }), 'top-right');

                    // Add Scale Control
                    map.addControl(new mapboxgl.ScaleControl({ unit: 'metric' }), 'bottom-right');

                    // Add Map Style Selector
                    const styleSelector = document.createElement('div');
                    styleSelector.className = 'map-style-selector';
                    styleSelector.innerHTML = `
                        <select id="style-selector" onchange="changeMapStyle(this.value)">
                            <option value="mapbox://styles/mapbox/streets-v11">Streets</option>
                            <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
                            <option value="mapbox://styles/mapbox/dark-v10">Dark</option>
                            <option value="mapbox://styles/mapbox/navigation-day-v1">Navigation Day</option>
                        </select>
                    `;
                    document.getElementById('map').prepend(styleSelector);

                    // Add Traffic Layer (initially hidden)
                    map.addSource('traffic', {
                        type: 'vector',
                        url: 'mapbox://mapbox.mapbox-traffic-v1'
                    });
                    map.addLayer({
                        id: 'traffic-layer',
                        type: 'line',
                        source: 'traffic',
                        'source-layer': 'traffic',
                        paint: {
                            'line-color': [
                                'case',
                                ['==', ['get', 'congestion'], 'low'], '#00ff00',
                                ['==', ['get', 'congestion'], 'moderate'], '#ffcc00',
                                ['==', ['get', 'congestion'], 'heavy'], '#ff0000',
                                ['==', ['get', 'congestion'], 'severe'], '#800000',
                                '#000000'
                            ],
                            'line-width': 4,
                            'line-opacity': 0.7
                        },
                        layout: { visibility: 'none' }
                    });

                    // Ensure map resizes correctly
                    map.resize();
                });

                map.addControl(new mapboxgl.NavigationControl(), 'top-right');
                map.addControl(new mapboxgl.FullscreenControl(), 'top-right');

                const shuttles = [
                    { name: 'Shuttle #1', coordinates: [120.9842, 14.5995], status: 'On Time', driver: 'John Doe', route: 'A', nextStop: 'Stop 1', eta: '10 min' },
                    { name: 'Shuttle #2', coordinates: [121.0437, 14.6760], status: 'Delayed', driver: 'Jane Smith', route: 'B', nextStop: 'Stop 2', eta: '15 min' },
                    { name: 'Shuttle #3', coordinates: [121.0813, 14.5580], status: 'On Time', driver: 'Alex Brown', route: 'C', nextStop: 'Stop 3', eta: '8 min' },
                    { name: 'Shuttle #4', coordinates: [121.0244, 14.5547], status: 'Inactive', driver: 'None', route: 'None', nextStop: 'N/A', eta: 'N/A' }
                ];

                // Sample routes for demonstration
                const routes = {
                    'Shuttle #1': [[120.9842, 14.5995], [120.9900, 14.6000], [120.9950, 14.6050]],
                    'Shuttle #2': [[121.0437, 14.6760], [121.0500, 14.6800], [121.0550, 14.6850]],
                    'Shuttle #3': [[121.0813, 14.5580], [121.0850, 14.5600], [121.0900, 14.5650]],
                    'Shuttle #4': []
                };

                shuttles.forEach(shuttle => {
                    const markerElement = document.createElement('div');
                    markerElement.style.backgroundColor = shuttle.status === 'Inactive' ? '#666' : '#003A6C';
                    markerElement.style.width = '30px';
                    markerElement.style.height = '30px';
                    markerElement.style.borderRadius = '50%';
                    markerElement.style.display = 'flex';
                    markerElement.style.alignItems = 'center';
                    markerElement.style.justifyContent = 'center';
                    markerElement.style.cursor = 'pointer';
                    markerElement.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                    markerElement.innerHTML = '<i class="fa-solid fa-bus" style="color: #F5F5F5; font-size: 18px;"></i>';

                    markerElement.addEventListener('mouseenter', () => {
                        markerElement.style.backgroundColor = shuttle.status === 'Inactive' ? '#999' : '#0066CC';
                    });
                    markerElement.addEventListener('mouseleave', () => {
                        markerElement.style.backgroundColor = shuttle.status === 'Inactive' ? '#666' : '#003A6C';
                    });

                    new mapboxgl.Marker({ element: markerElement })
                        .setLngLat(shuttle.coordinates)
                        .setPopup(new mapboxgl.Popup().setHTML(`
                            <h3>${shuttle.name}</h3>
                            <p>Status: ${shuttle.status}</p>
                            <p>Driver: ${shuttle.driver}</p>
                            <p>Route: ${shuttle.route}</p>
                            <p>Next Stop: ${shuttle.nextStop}</p>
                            <p>ETA: ${shuttle.eta}</p>
                        `))
                        .addTo(map);
                });

                function refreshMap() {
                    map.resize();
                    showToast('Map refreshed!');
                }

                function toggleTrafficLayer() {
                    const visibility = map.getLayoutProperty('traffic-layer', 'visibility');
                    map.setLayoutProperty('traffic-layer', 'visibility', visibility === 'visible' ? 'none' : 'visible');
                    showToast(visibility === 'visible' ? 'Traffic layer hidden' : 'Traffic layer shown');
                }

                function changeMapStyle(style) {
                    map.setStyle(style);
                    showToast('Map style changed');
                    map.on('style.load', () => {
                        map.addSource('traffic', {
                            type: 'vector',
                            url: 'mapbox://mapbox.mapbox-traffic-v1'
                        });
                        map.addLayer({
                            id: 'traffic-layer',
                            type: 'line',
                            source: 'traffic',
                            'source-layer': 'traffic',
                            paint: {
                                'line-color': [
                                    'case',
                                    ['==', ['get', 'congestion'], 'low'], '#00ff00',
                                    ['==', ['get', 'congestion'], 'moderate'], '#ffcc00',
                                    ['==', ['get', 'congestion'], 'heavy'], '#ff0000',
                                    ['==', ['get', 'congestion'], 'severe'], '#800000',
                                    '#000000'
                                ],
                                'line-width': 4,
                                'line-opacity': 0.7
                            },
                            layout: { visibility: 'none' }
                        });

                        shuttles.forEach(shuttle => {
                            const markerElement = document.createElement('div');
                            markerElement.style.backgroundColor = shuttle.status === 'Inactive' ? '#666' : '#003A6C';
                            markerElement.style.width = '30px';
                            markerElement.style.height = '30px';
                            markerElement.style.borderRadius = '50%';
                            markerElement.style.display = 'flex';
                            markerElement.style.alignItems = 'center';
                            markerElement.style.justifyContent = 'center';
                            markerElement.style.cursor = 'pointer';
                            markerElement.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                            markerElement.innerHTML = '<i class="fa-solid fa-bus" style="color: #F5F5F5; font-size: 18px;"></i>';

                            markerElement.addEventListener('mouseenter', () => {
                                markerElement.style.backgroundColor = shuttle.status === 'Inactive' ? '#999' : '#0066CC';
                            });
                            markerElement.addEventListener('mouseleave', () => {
                                markerElement.style.backgroundColor = shuttle.status === 'Inactive' ? '#666' : '#003A6C';
                            });

                            new mapboxgl.Marker({ element: markerElement })
                                .setLngLat(shuttle.coordinates)
                                .setPopup(new mapboxgl.Popup().setHTML(`
                                    <h3>${shuttle.name}</h3>
                                    <p>Status: ${shuttle.status}</p>
                                    <p>Driver: ${shuttle.driver}</p>
                                    <p>Route: ${shuttle.route}</p>
                                    <p>Next Stop: ${shuttle.nextStop}</p>
                                    <p>ETA: ${shuttle.eta}</p>
                                `))
                                .addTo(map);
                        });

                        // Re-add Directions control after style change
                        const directions = new MapboxDirections({
                            accessToken: mapboxgl.accessToken,
                            unit: 'metric',
                            profile: 'mapbox/driving-traffic',
                            controls: { inputs: true, instructions: true }
                        });
                        map.addControl(directions, 'top-left');
                    });
                }

                function trackShuttle(shuttleName) {
                    const shuttle = shuttles.find(s => s.name === shuttleName);
                    if (shuttle) {
                        map.flyTo({ center: shuttle.coordinates, zoom: 12 });
                        showToast(`Tracking ${shuttleName}`);
                    }
                }

                function showRoute(shuttleName) {
                    const route = routes[shuttleName];
                    if (!route || route.length < 2) {
                        showToast(`No route available for ${shuttleName}`);
                        return;
                    }

                    const coordinates = route;
                    map.getSource('route')?.setData({
                        type: 'Feature',
                        properties: {},
                        geometry: {
                            type: 'LineString',
                            coordinates: coordinates
                        }
                    }) || map.addSource('route', {
                        type: 'geojson',
                        data: {
                            type: 'Feature',
                            properties: {},
                            geometry: {
                                type: 'LineString',
                                coordinates: coordinates
                            }
                        }
                    });

                    map.getLayer('route') || map.addLayer({
                        id: 'route',
                        type: 'line',
                        source: 'route',
                        layout: {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        paint: {
                            'line-color': '#003A6C',
                            'line-width': 5,
                            'line-opacity': 0.75
                        }
                    });

                    const bounds = coordinates.reduce((bounds, coord) => {
                        return bounds.extend(coord);
                    }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));
                    map.fitBounds(bounds, { padding: 50 });
                    showToast(`Showing route for ${shuttleName}`);
                }

                function searchLocation() {
                    const query = document.getElementById('map-search-input').value.trim();
                    if (!query) {
                        showToast('Please enter a location to search.');
                        return;
                    }

                    fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${mapboxgl.accessToken}&country=PH&limit=1`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.features && data.features.length > 0) {
                                const [lng, lat] = data.features[0].center;
                                map.flyTo({ center: [lng, lat], zoom: 12 });
                                new mapboxgl.Marker()
                                    .setLngLat([lng, lat])
                                    .setPopup(new mapboxgl.Popup().setHTML(`<h3>${data.features[0].place_name}</h3>`))
                                    .addTo(map);
                                showToast(`Found location: ${data.features[0].place_name}`);
                            } else {
                                showToast('Location not found. Please try a different search term.');
                            }
                        })
                        .catch(error => {
                            console.error('Error searching location:', error);
                            showToast('Error searching location: ' + error.message);
                        });
                }
            </script>
        </div>

        <div id="profile" class="tab">
            <header>
                <h2>Profile</h2>
            </header>
            <div class="profile-section">
                <div class="profile-card" role="region" aria-labelledby="admin-info-title">
                    <h3 id="admin-info-title">Admin Information</h3>
                    <div class="info-row">
                        <div class="profile-picture-container">
                            <img id="admin-profile-picture" src="images/default-profile.png" alt="Admin Profile Picture" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; border: 2px solid #f46354;">
                            <div class="profile-picture-upload">
                                <input type="file" id="profile-picture-input" accept="image/*" style="display: none;">
                                <button class="profile-button" onclick="document.getElementById('profile-picture-input').click()">Change Picture</button>
                            </div>
                            <p id="profile-picture-error" class="error-text" style="display: none;"></p>
                        </div>
                        <p><strong>Username:</strong> <span id="admin-username"></span></p>
                        <p><strong>Email:</strong> <span id="admin-email"></span></p>
                    </div>
                </div>
                <div class="profile-card" role="region" aria-labelledby="admin-reset-title">
                    <h3 id="admin-reset-title">Reset Your Password</h3>
                    <form id="admin-reset-password-form" class="profile-form" aria-labelledby="admin-reset-title">
                        <div class="form-group password-wrapper">
                            <label for="admin-current-password">Current Password</label>
                            <input type="password" id="admin-current-password" required>
                            <span class="toggle-password" onclick="togglePassword('admin-current-password', this)" aria-label="Toggle password visibility">
                                <i class="fa-solid fa-eye-slash"></i>
                            </span>
                        </div>
                        <div class="form-group password-wrapper">
                            <label for="admin-new-password">New Password</label>
                            <input type="password" id="admin-new-password" required>
                            <span class="toggle-password" onclick="togglePassword('admin-new-password', this)" aria-label="Toggle password visibility">
                                <i class="fa-solid fa-eye-slash"></i>
                            </span>
                        </div>
                        <div class="form-group password-wrapper">
                            <label for="admin-confirm-password">Confirm New Password</label>
                            <input type="password" id="admin-confirm-password" required>
                            <span class="toggle-password" onclick="togglePassword('admin-confirm-password', this)" aria-label="Toggle password visibility">
                                <i class="fa-solid fa-eye-slash"></i>
                            </span>
                        </div>
                        <p id="admin-reset-error" class="error-text" style="display: none;"></p>
                        <button type="submit" class="profile-button">Reset Password</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Add Shuttle Modal -->
        <div id="addShuttleModal" class="modal" style="display: none;">
            <div class="modal-content add-form-modal">
                <div class="modal-header">
                    <h3><i class="fa-solid fa-bus"></i> Add Shuttle</h3>
                    <span class="close-modal" onclick="closeAddShuttleModal()">&times;</span>
                </div>
                <form id="addShuttleForm">
                    <div class="form-group">
                        <label for="operatorSelect">Operator *</label>
                        <select id="operatorSelect" required onchange="loadDriversForOperator('operatorSelect', 'driverSelect')">
                            <option value="">Select Operator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="driverSelect">Driver *</label>
                        <select id="driverSelect" required>
                            <option value="">Select Driver</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="routeInput">Route *</label>
                        <input type="text" id="routeInput" required placeholder="e.g., Route A">
                    </div>
                    <p id="add-shuttle-error" class="error-text" style="display: none;"></p>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeAddShuttleModal()">Cancel</button>
                        <button type="submit" class="submit-btn">
                            <i class="fa-solid fa-save"></i> Add Shuttle
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Shuttle Modal -->
        <div id="editShuttleModal" class="modal" style="display: none;">
            <div class="modal-content add-form-modal">
                <div class="modal-header">
                    <h3><i class="fa-solid fa-edit"></i> Edit Shuttle</h3>
                    <span class="close-modal" onclick="closeEditShuttleModal()">&times;</span>
                </div>
                <form id="editShuttleForm">
                    <input type="hidden" id="edit-shuttle-id">
                    <div class="form-group">
                        <label for="edit-operator-select">Operator *</label>
                        <select id="edit-operator-select" required onchange="loadDriversForOperator('edit-operator-select', 'edit-driver-select')">
                            <option value="">Select Operator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-driver-select">Driver *</label>
                        <select id="edit-driver-select" required>
                            <option value="">Select Driver</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-route-input">Route *</label>
                        <input type="text" id="edit-route-input" required placeholder="e.g., Route A">
                    </div>
                    <p id="edit-shuttle-error" class="error-text" style="display: none;"></p>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeEditShuttleModal()">Cancel</button>
                        <button type="submit" class="submit-btn">
                            <i class="fa-solid fa-save"></i> Update Shuttle
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Parent & Students Modal -->
        <div id="addParentModal" class="modal" style="display: none;">
            <div class="modal-content add-form-modal">
                <div class="modal-header">
                    <h3><i class="fa-solid fa-users"></i> Add Parent & Students</h3>
                    <span class="close-modal" onclick="closeAddParentModal()">&times;</span>
                </div>
                <form id="addParentForm">
                    <div class="form-section">
                        <h4><i class="fa-solid fa-user"></i> Parent Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="parent-username">Username *</label>
                                <input type="text" id="parent-username" required>
                            </div>
                            <div class="form-group">
                                <label for="parent-email">Email *</label>
                                <input type="email" id="parent-email" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group password-wrapper">
                                <label for="parent-password">Password *</label>
                                <input type="password" id="parent-password" required>
                                <span class="toggle-password" onclick="togglePassword('parent-password', this)">
                                    <i class="fa-solid fa-eye-slash"></i>
                                </span>
                            </div>
                            <div class="form-group">
                                <label for="parent-fullname">Full Name *</label>
                                <input type="text" id="parent-fullname" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="parent-phone">Contact Phone *</label>
                                <input type="tel" id="parent-phone" placeholder="+63-912-345-6789" required>
                            </div>
                            <div class="form-group">
                                <label for="parent-address">Current Address *</label>
                                <input type="text" id="parent-address" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-header">
                            <h4><i class="fa-solid fa-graduation-cap"></i> Students Information</h4>
                            <button type="button" class="add-student-btn" onclick="addStudentForm()">
                                <i class="fa-solid fa-plus"></i> Add Student
                            </button>
                        </div>
                        <div id="students-container">
                            <div class="student-form" data-student="1">
                                <div class="student-header">
                                    <h5>Student 1</h5>
                                    <button type="button" class="remove-student-btn" onclick="removeStudentForm(1)" style="display: none;">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="student-1-username">Username *</label>
                                        <input type="text" id="student-1-username" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="student-1-email">Email *</label>
                                        <input type="email" id="student-1-email" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group password-wrapper">
                                        <label for="student-1-password">Password *</label>
                                        <input type="password" id="student-1-password" required>
                                        <span class="toggle-password" onclick="togglePassword('student-1-password', this)">
                                            <i class="fa-solid fa-eye-slash"></i>
                                        </span>
                                    </div>
                                    <div class="form-group">
                                        <label for="student-1-fullname">Full Name *</label>
                                        <input type="text" id="student-1-fullname" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="student-1-address">Current Address *</label>
                                        <input type="text" id="student-1-address" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="student-1-grade">Grade *</label>
                                        <select id="student-1-grade" required>
                                            <option value="">Select Grade</option>
                                            <option value="Grade 7">Grade 7</option>
                                            <option value="Grade 8">Grade 8</option>
                                            <option value="Grade 9">Grade 9</option>
                                            <option value="Grade 10">Grade 10</option>
                                            <option value="Grade 11">Grade 11</option>
                                            <option value="Grade 12">Grade 12</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="student-1-section">Section *</label>
                                        <input type="text" id="student-1-section" placeholder="e.g., Section A" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p id="add-parent-error" class="error-text" style="display: none;"></p>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeAddParentModal()">Cancel</button>
                        <button type="submit" class="submit-btn">
                            <i class="fa-solid fa-save"></i> Register Parent & Students
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Operator & Drivers Modal -->
        <div id="addOperatorModal" class="modal" style="display: none;">
            <div class="modal-content add-form-modal">
                <div class="modal-header">
                    <h3><i class="fa-solid fa-bus"></i> Add Operator & Drivers</h3>
                    <span class="close-modal" onclick="closeAddOperatorModal()">&times;</span>
                </div>
                <form id="addOperatorForm">
                    <div class="form-section">
                        <h4><i class="fa-solid fa-user-tie"></i> Operator Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="operator-username">Username *</label>
                                <input type="text" id="operator-username" required>
                            </div>
                            <div class="form-group">
                                <label for="operator-email">Email *</label>
                                <input type="email" id="operator-email" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group password-wrapper">
                                <label for="operator-password">Password *</label>
                                <input type="password" id="operator-password" required>
                                <span class="toggle-password" onclick="togglePassword('operator-password', this)">
                                    <i class="fa-solid fa-eye-slash"></i>
                                </span>
                            </div>
                            <div class="form-group">
                                <label for="operator-fullname">Full Name *</label>
                                <input type="text" id="operator-fullname" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="operator-phone">Contact Phone *</label>
                                <input type="tel" id="operator-phone" placeholder="+63-912-345-6789" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-header">
                            <h4><i class="fa-solid fa-id-card"></i> Drivers Information</h4>
                            <button type="button" class="add-driver-btn" onclick="addDriverForm()">
                                <i class="fa-solid fa-plus"></i> Add Driver
                            </button>
                        </div>
                        <div id="drivers-container">
                            <div class="driver-form" data-driver="1">
                                <div class="driver-header">
                                    <h5>Driver 1</h5>
                                    <button type="button" class="remove-driver-btn" onclick="removeDriverForm(1)" style="display: none;">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="driver-1-username">Username *</label>
                                        <input type="text" id="driver-1-username" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="driver-1-email">Email *</label>
                                        <input type="email" id="driver-1-email" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group password-wrapper">
                                        <label for="driver-1-password">Password *</label>
                                        <input type="password" id="driver-1-password" required>
                                        <span class="toggle-password" onclick="togglePassword('driver-1-password', this)">
                                            <i class="fa-solid fa-eye-slash"></i>
                                        </span>
                                    </div>
                                    <div class="form-group">
                                        <label for="driver-1-license">License Number *</label>
                                        <input type="text" id="driver-1-license" placeholder="e.g., DRV-12345" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="driver-1-phone">Contact Phone *</label>
                                        <input type="tel" id="driver-1-phone" placeholder="+63-912-345-6789" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="driver-1-emergency">Emergency Contact *</label>
                                        <input type="tel" id="driver-1-emergency" placeholder="+63-912-345-6789" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p id="add-operator-error" class="error-text" style="display: none;"></p>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeAddOperatorModal()">Cancel</button>
                        <button type="submit" class="submit-btn">
                            <i class="fa-solid fa-save"></i> Register Operator & Drivers
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Bulk Upload Modal -->
        <div id="bulkUploadModal" class="modal" style="display: none;">
            <div class="modal-content bulk-upload-modal">
                <div class="modal-header">
                    <h3 id="bulk-title"><i class="fa-solid fa-upload"></i> Bulk Upload</h3>
                    <span class="close-modal" onclick="closeBulkUploadModal()">&times;</span>
                </div>
                <form id="bulkUploadForm">
                    <div class="form-group">
                        <label for="bulk-file">Select XLSX File *</label>
                        <input type="file" id="bulk-file" accept=".xlsx" required>
                        <small>Upload an Excel file with user data.</small>
                    </div>
                    <p id="bulk-error" class="error-text" style="display: none;"></p>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeBulkUploadModal()">Cancel</button>
                        <button type="submit" class="submit-btn">
                            <i class="fa-solid fa-upload"></i> Upload File
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Student Modal -->
        <div id="editStudentModal" class="modal" style="display: none;">
            <div class="modal-content add-form-modal">
                <div class="modal-header">
                    <h3><i class="fa-solid fa-user-edit"></i> Edit Student</h3>
                    <span class="close-modal" onclick="closeEditStudentModal()">&times;</span>
                </div>
                <form id="editStudentForm">
                    <input type="hidden" id="edit-student-id">
                    <div class="form-section">
                        <h4><i class="fa-solid fa-graduation-cap"></i> Student Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-student-fullname">Full Name *</label>
                                <input type="text" id="edit-student-fullname" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-student-grade">Grade *</label>
                                <select id="edit-student-grade" required>
                                    <option value="">Select Grade</option>
                                    <option value="Grade 7">Grade 7</option>
                                    <option value="Grade 8">Grade 8</option>
                                    <option value="Grade 9">Grade 9</option>
                                    <option value="Grade 10">Grade 10</option>
                                    <option value="Grade 11">Grade 11</option>
                                    <option value="Grade 12">Grade 12</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-student-section">Section *</label>
                                <input type="text" id="edit-student-section" placeholder="e.g., Section A" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-student-address">Current Address *</label>
                                <input type="text" id="edit-student-address" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h4><i class="fa-solid fa-user"></i> Parent Information</h4>
                        <input type="hidden" id="edit-parent-id">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-parent-fullname">Full Name *</label>
                                <input type="text" id="edit-parent-fullname" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-parent-phone">Contact Phone *</label>
                                <input type="tel" id="edit-parent-phone" placeholder="+63-912-345-6789" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-parent-address">Current Address *</label>
                                <input type="text" id="edit-parent-address" required>
                            </div>
                        </div>
                    </div>
                    <p id="edit-student-error" class="error-text" style="display: none;"></p>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeEditStudentModal()">Cancel</button>
                        <button type="submit" class="submit-btn">
                            <i class="fa-solid fa-save"></i> Update Student & Parent
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Driver Modal -->
        <div id="editDriverModal" class="modal" style="display: none;">
            <div class="modal-content add-form-modal">
                <div class="modal-header">
                    <h3><i class="fa-solid fa-user-edit"></i> Edit Driver</h3>
                    <span class="close-modal" onclick="closeEditDriverModal()">&times;</span>
                </div>
                <form id="editDriverForm">
                    <input type="hidden" id="edit-driver-id">
                    <div class="form-section">
                        <h4><i class="fa-solid fa-id-card"></i> Driver Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-driver-contact">Contact Phone *</label>
                                <input type="tel" id="edit-driver-contact" placeholder="+63-912-345-6789" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-driver-license">License Number *</label>
                                <input type="text" id="edit-driver-license" placeholder="e.g., DRV-12345" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-driver-emergency">Emergency Contact *</label>
                                <input type="tel" id="edit-driver-emergency" placeholder="+63-912-345-6789" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h4><i class="fa-solid fa-user-tie"></i> Operator Information</h4>
                        <input type="hidden" id="edit-operator-id">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-operator-fullname">Full Name *</label>
                                <input type="text" id="edit-operator-fullname" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-operator-phone">Contact Phone *</label>
                                <input type="tel" id="edit-operator-phone" placeholder="+63-912-345-6789" required>
                            </div>
                        </div>
                    </div>
                    <p id="edit-driver-error" class="error-text" style="display: none;"></p>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeEditDriverModal()">Cancel</button>
                        <button type="submit" class="submit-btn">
                            <i class="fa-solid fa-save"></i> Update Driver & Operator
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteConfirmModal" class="modal-confirm" style="display: none;">
            <div class="modal-confirm-content">
                <h3>Confirm Delete</h3>
                <p id="deleteConfirmMessage">Are you sure you want to delete this item? This action cannot be undone.</p>
                <input type="hidden" id="deleteItemId">
                <input type="hidden" id="deleteItemType">
                <button class="confirm-action" onclick="confirmDelete()">Delete</button>
                <button class="cancel-action" onclick="cancelDelete()">Cancel</button>
            </div>
        </div>

        <div id="logoutConfirmModal" class="modal-confirm" style="display: none;">
            <div class="modal-confirm-content">
                <h3>Confirm Logout</h3>
                <p>Are you sure you want to log out?</p>
                <button class="confirm-action" onclick="confirmLogout()">Logout</button>
                <button class="cancel-action" onclick="cancelLogout()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast" style="display: none;"></div>

    <script src="script.js"></script>
    <script>
        function togglePassword(id, iconSpan) {
            const input = document.getElementById(id);
            const icon = iconSpan.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 4000);
        }
    </script>
</body>
</html>